
<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>GPV Chat</title>
    <script defer src="https://cdn.jsdelivr.net/npm/react@18.2.0/umd/react.production.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/react-dom@18.2.0/umd/react-dom.production.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/axios@1.6.2/dist/axios.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/@babel/standalone@7.20.6/babel.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <style>
        :root {
            --primary-color: #0066cc;
            --secondary-color: #e6f7ff;
            --background-color: #ffffff;
            --text-color: #000000;
            --message-bg-left: #e6f7ff;
            --message-bg-right: #ffffff;
            --header-bg: #0066cc;
            --footer-bg: #ffffff;
            --border-color: #e5e7eb;
            --text-size: 14px;
            --progress-bar-bg: #e5e7eb;
            --progress-bar-fill: #0066cc;
            --quoted-color: #f0f0f0; /* Nova cor para citação */
        }
        [data-theme="dark"] {
            --primary-color: #4a9eff;
            --secondary-color: #1a365d;
            --background-color: #1a202c;
            --text-color: #ffffff;
            --message-bg-left: #2d3748;
            --message-bg-right: #4a5568;
            --header-bg: #2d3748;
            --footer-bg: #2d3748;
            --border-color: #4a5568;
            --progress-bar-bg: #4a5568;
            --progress-bar-fill: #4a9eff;
            --quoted-color: #2d3748;
        }
        [data-theme="nature"] {
            --primary-color: #22c55e;
            --secondary-color: #dcfce7;
            --background-color: #f0fdf4;
            --text-color: #166534;
            --message-bg-left: #16a34a;
            --message-bg-right: #ffffff;
            --header-bg: transparent;
            --footer-bg: #ffffff;
            --border-color: #bbf7d0;
            --progress-bar-bg: #bbf7d0;
            --progress-bar-fill: #22c55e;
            --quoted-color: #dcfce7;
        }
        body {
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            background: var(--background-color);
            overscroll-behavior: none;
            position: relative;
            color: var(--text-color);
            font-size: var(--text-size);
            transition: all 0.3s ease;
            overflow: hidden;
        }
        .text-small { --text-size: 12px; }
        .text-medium { --text-size: 14px; }
        .text-large { --text-size: 16px; }
        .text-xlarge { --text-size: 18px; }
        /* Particle Background */
        #particles {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: -1;
        }
        .particle {
            position: absolute;
            background: #0066cc;
            border-radius: 50%;
            opacity: 0.5;
            animation: float 10s infinite ease-in-out;
        }
        @keyframes float {
            0% { transform: translateY(0) scale(1); opacity: 0.5; }
            50% { transform: translateY(-100vh) scale(0.8); opacity: 0.2; }
            100% { transform: translateY(-200vh) scale(0.6); opacity: 0; }
        }
        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #ffffff;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: #0066cc;
            z-index: 9999;
            transition: opacity 0.7s ease-out;
        }
        .loading-screen.hidden {
            opacity: 0;
            pointer-events: none;
        }
        .loading-logo {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            object-fit: cover;
            margin-bottom: 20px;
            box-shadow: 0 0 15px rgba(0, 102, 204, 0.2);
            animation: logoScale 1.5s ease-in-out infinite;
        }
        @keyframes logoScale {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        .loading-text {
            font-size: 1.5rem;
            font-weight: 500;
            color: #0066cc;
        }
        .chat-container {
            height: 100vh;
            width: 100vw;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            touch-action: manipulation;
        }
        .chat-header {
            background: var(--header-bg);
            color: #ffffff;
            padding: 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            z-index: 10;
            border-bottom-left-radius: 20px;
            border-bottom-right-radius: 20px;
        }
        .global-delete-button {
            cursor: pointer;
            color: #ffffff;
            font-size: 1.2rem;
        }
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            scrollbar-width: thin;
            scrollbar-color: var(--primary-color) var(--border-color);
            padding: 16px;
            background: transparent;
            width: 100%;
            padding-bottom: 120px;
        }
        .chat-messages::-webkit-scrollbar {
            width: 6px;
        }
        .chat-messages::-webkit-scrollbar-track {
            background: var(--border-color);
        }
        .chat-messages::-webkit-scrollbar-thumb {
            background: var(--primary-color);
            border-radius: 3px;
        }
        .message {
            animation: fadeIn 0.3s ease-out;
            width: 100%;
            position: relative;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .message-bubble {
            position: relative;
            border-radius: 10px;
            padding: 10px 14px;
            max-width: 90%;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
            white-space: pre-wrap;
            word-wrap: normal;
            margin-bottom: 4px;
            display: inline-block;
            font-size: var(--text-size);
        }
        .message-bubble.radiate {
            animation: radiateBorder 0.5s ease-out;
        }
        @keyframes radiateBorder {
            0% { box-shadow: 0 0 0 0 rgba(0, 102, 204, 0.7); }
            100% { box-shadow: 0 0 0 10px rgba(0, 102, 204, 0); }
        }
        .message-bubble::after {
            content: '';
            position: absolute;
            width: 0;
            height: 0;
            border: 8px solid transparent;
        }
        .message-left .message-bubble {
            background: var(--message-bg-left);
            color: var(--primary-color);
        }
        .message-left .message-bubble::after {
            border-right-color: var(--message-bg-left);
            border-left: 0;
            left: -8px;
            top: 12px;
        }
        .message-right .message-bubble {
            background: var(--message-bg-right);
            color: var(--text-color);
        }
        .message-right .message-bubble::after {
            border-left-color: var(--message-bg-right);
            border-right: 0;
            right: -8px;
            top: 12px;
        }
        .message-image {
            max-width: 200px;
            border-radius: 10px;
            cursor: pointer;
            display: block;
        }
        .message-audio {
            max-width: 250px;
            border-radius: 20px;
            padding: 8px;
            background: #f0f0f0;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        .waveform {
            display: flex;
            gap: 2px;
            flex: 1;
            height: 20px;
            align-items: center;
        }
        .wave-bar {
            width: 4px;
            background: var(--primary-color);
            border-radius: 2px;
            animation: audioWave 1.5s infinite ease-in-out;
        }
        .wave-bar:nth-child(2) { animation-delay: -0.3s; }
        .wave-bar:nth-child(3) { animation-delay: -0.6s; }
        .wave-bar:nth-child(4) { animation-delay: -0.9s; }
        .wave-bar:nth-child(5) { animation-delay: -1.2s; }
        @keyframes audioWave {
            0%, 100% { height: 10px; }
            50% { height: 20px; }
        }
        .fullscreen-image {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .fullscreen-image img {
            max-width: 90%;
            max-height: 90%;
            object-fit: contain;
        }
        .close-button {
            position: absolute;
            top: 20px;
            right: 20px;
            background: var(--secondary-color);
            color: var(--primary-color);
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            font-size: 20px;
        }
        .like-button, .quote-button, .delete-button, .laugh-button, .sad-button {
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 4px;
            color: var(--primary-color);
            font-size: calc(var(--text-size) * 0.8);
            margin-top: 4px;
            background: #f0f0f0;
            border-radius: 20px;
            padding: 4px 8px;
            transition: background 0.3s;
        }
        .like-button:hover, .quote-button:hover, .delete-button:hover, .laugh-button:hover, .sad-button:hover {
            background: var(--secondary-color);
        }
        .heart-rain {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 10;
        }
        .heart {
            position: absolute;
            color: var(--primary-color);
            font-size: 12px;
            opacity: 0;
            animation: heartRain 1s ease-out forwards;
        }
        @keyframes heartRain {
            0% { opacity: 1; transform: translateY(0) scale(1); }
            100% { opacity: 0; transform: translateY(100px) scale(0.5); }
        }
        .mention {
            color: var(--primary-color);
            font-weight: bold;
        }
        .typing-indicator {
            position: sticky;
            bottom: 60px;
            left: 16px;
            background: var(--secondary-color);
            border-radius: 15px;
            padding: 12px 16px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
            color: var(--text-color);
            font-size: calc(var(--text-size) * 0.9);
            display: flex;
            align-items: center;
            gap: 8px;
            animation: pulse 1.5s ease-in-out infinite;
            margin-top: 8px;
            width: fit-content;
            border: 2px solid var(--primary-color);
        }
        .typing-avatar {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            object-fit: cover;
        }
        .typing-text {
            font-weight: 600;
            font-size: calc(var(--text-size) * 1.1);
        }
        .dot {
            width: 6px;
            height: 6px;
            background: var(--primary-color);
            border-radius: 50%;
            animation: bounce 1.2s infinite ease-in-out;
        }
        .dot:nth-child(2) {
            animation-delay: -0.4s;
        }
        .dot:nth-child(3) {
            animation-delay: -0.8s;
        }
        @keyframes bounce {
            0%, 80%, 100% { transform: translateY(0); }
            40% { transform: translateY(-5px); }
        }
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        .chat-footer {
            background: var(--footer-bg);
            padding: 10px 16px;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 -2px 5px rgba(0, 0, 0, 0.1);
            z-index: 10;
            border-top-left-radius: 20px;
            border-top-right-radius: 20px;
            position: relative;
            flex-direction: column;
        }
        .chat-input {
            flex: 1;
            padding: 12px 16px;
            border: 2px solid var(--primary-color);
            border-radius: 20px;
            outline: none;
            font-size: var(--text-size);
            transition: border-color 0.3s ease, transform 0.2s ease;
            background: var(--background-color);
            color: var(--text-color);
            width: 100%;
        }
        .chat-input:focus {
            border-color: var(--secondary-color);
            transform: scale(1.02);
        }
        .input-container {
            position: relative;
            display: flex;
            align-items: center;
            gap: 8px;
            width: 100%;
        }
        .mic-button, .send-button {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            background: transparent;
            border: none;
            color: var(--primary-color);
            font-size: 1.2rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .send-button.visible {
            opacity: 1;
        }
        .mic-button:hover, .send-button:hover {
            color: var(--secondary-color);
        }
        .fab-wrapper {
            position: fixed;
            bottom: 4rem;
            right: 3rem;
        }
        .fab-checkbox {
            display: none;
        }
        .fab {
            position: absolute;
            bottom: -1rem;
            right: -1rem;
            width: 4rem;
            height: 4rem;
            background: var(--primary-color);
            border-radius: 50%;
            box-shadow: 0px 5px 20px #81a4f1;
            transition: all 0.3s ease;
            z-index: 1;
            border-bottom-right-radius: 6px;
            border: 1px solid #0c50a7;
        }
        .fab:before {
            content: "";
            position: absolute;
            width: 100%;
            height: 100%;
            left: 0;
            top: 0;
            border-radius: 50%;
            background-color: rgba(255, 255, 255, 0.1);
        }
        .fab-checkbox:checked ~ .fab:before {
            width: 90%;
            height: 90%;
            left: 5%;
            top: 5%;
            background-color: rgba(255, 255, 255, 0.2);
        }
        .fab:hover {
            background: #2c87e8;
            box-shadow: 0px 5px 20px 5px #81a4f1;
        }
        .fab-dots {
            position: absolute;
            height: 8px;
            width: 8px;
            background-color: white;
            border-radius: 50%;
            top: 50%;
            transform: translateX(0%) translateY(-50%) rotate(0deg);
            opacity: 1;
            animation: blink 3s ease infinite;
            transition: all 0.3s ease;
        }
        .fab-dots-1 {
            left: 15px;
            animation-delay: 0s;
        }
        .fab-dots-2 {
            left: 50%;
            transform: translateX(-50%) translateY(-50%);
            animation-delay: 0.4s;
        }
        .fab-dots-3 {
            right: 15px;
            animation-delay: 0.8s;
        }
        .fab-checkbox:checked ~ .fab .fab-dots {
            height: 6px;
        }
        .fab .fab-dots-2 {
            transform: translateX(-50%) translateY(-50%) rotate(0deg);
        }
        .fab-checkbox:checked ~ .fab .fab-dots-1 {
            width: 32px;
            border-radius: 10px;
            left: 50%;
            transform: translateX(-50%) translateY(-50%) rotate(45deg);
        }
        .fab-checkbox:checked ~ .fab .fab-dots-3 {
            width: 32px;
            border-radius: 10px;
            right: 50%;
            transform: translateX(50%) translateY(-50%) rotate(-45deg);
        }
        @keyframes blink {
            50% {
                opacity: 0.25;
            }
        }
        .fab-checkbox:checked ~ .fab .fab-dots {
            animation: none;
        }
        .fab-wheel {
            position: absolute;
            bottom: 4rem;
            right: 0;
            border: 1px solid transparent;
            width: 100vw;
            height: auto;
            transition: all 0.3s ease;
            transform-origin: bottom right;
            transform: scale(0);
            display: flex;
            flex-direction: row;
            overflow-x: auto;
            scroll-snap-type: x mandatory;
            padding: 0.5rem;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 1rem 1rem 0 0;
            box-shadow: 0 -4px 12px rgba(0, 0, 0, 0.15);
            gap: 1.5rem;
            scrollbar-width: none; /* Hide scrollbar for Firefox */
            scroll-behavior: smooth;
        }
        .fab-wheel::-webkit-scrollbar {
            display: none; /* Hide scrollbar for Chrome/Safari */
        }
        .fab-checkbox:checked ~ .fab-wheel {
            transform: scale(1);
        }
        .fab-action {
            background: var(--primary-color);
            width: 3.5rem;
            height: 3.5rem;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            box-shadow: 0 0.1rem 1rem rgba(24, 66, 154, 0.82);
            transition: all 0.3s ease;
            opacity: 0;
            cursor: pointer;
            border: none;
            flex-shrink: 0;
            scroll-snap-align: start;
            position: relative;
        }
        .fab-action::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: -2rem;
            left: 50%;
            transform: translateX(-50%);
            background: var(--primary-color);
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.8rem;
            white-space: nowrap;
            opacity: 0;
            transition: opacity 0.3s;
            pointer-events: none;
        }
        .fab-action:hover::after {
            opacity: 1;
        }
        .fab-checkbox:checked ~ .fab-wheel .fab-action {
            opacity: 1;
        }
        .fab-action:hover {
            background-color: var(--secondary-color);
        }
        /* Remove specific positions, let flex handle */
        .recording-animation {
            position: absolute;
            bottom: 60px;
            left: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
            background: var(--secondary-color);
            border-radius: 20px;
            padding: 8px 16px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            z-index: 9;
            animation: slideIn 0.3s ease-out;
        }
        .recording-icon {
            font-size: 1.5rem;
            color: var(--primary-color);
            animation: pulseIcon 1.5s infinite;
        }
        .recording-wave {
            display: flex;
            gap: 4px;
            align-items: center;
        }
        .recording-wave-bar {
            width: 6px;
            height: 20px;
            background: var(--primary-color);
            border-radius: 3px;
            animation: wave 1.2s infinite ease-in-out;
        }
        .recording-wave-bar:nth-child(2) { animation-delay: -0.3s; }
        .recording-wave-bar:nth-child(3) { animation-delay: -0.6s; }
        .recording-wave-bar:nth-child(4) { animation-delay: -0.9s; }
        .recording-wave-bar:nth-child(5) { animation-delay: -1.2s; }
        @keyframes wave {
            0%, 100% { transform: scaleY(1); }
            50% { transform: scaleY(2.5); }
        }
        @keyframes pulseIcon {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.3); }
        }
        @keyframes slideIn {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        .progress-bar-container {
            position: absolute;
            bottom: 80px;
            left: 16px;
            width: 200px;
            background: var(--secondary-color);
            border-radius: 12px;
            padding: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            z-index: 9;
            animation: slideIn 0.3s ease-out;
        }
        .progress-bar {
            height: 8px;
            background: var(--progress-bar-bg);
            border-radius: 4px;
            overflow: hidden;
        }
        .progress-bar-fill {
            height: 100%;
            background: var(--progress-bar-fill);
            transition: width 0.2s ease-in-out;
        }
        .progress-text {
            font-size: calc(var(--text-size) * 0.8);
            color: var(--primary-color);
            margin-top: 4px;
            text-align: center;
        }
        .quoted-message {
            background: var(--quoted-color);
            padding: 8px;
            border-radius: 8px;
            margin-bottom: 8px;
            border-left: 4px solid var(--primary-color);
        }
        .quoted-user {
            font-weight: bold;
            color: var(--primary-color);
        }
        .quoted-text {
            font-size: 0.9em;
        }
        .quoted-image {
            max-width: 100px;
            border-radius: 8px;
            margin-bottom: 8px;
        }
        .quoted-preview {
            background: var(--quoted-color);
            padding: 8px;
            border-radius: 8px;
            margin-bottom: 8px;
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            width: 100%;
        }
        .quoted-preview button {
            background: transparent;
            border: none;
            color: var(--primary-color);
            cursor: pointer;
            align-self: flex-end;
        }
        .reply-text {
            color: var(--primary-color);
            font-size: calc(var(--text-size) * 0.8);
            margin-top: 4px;
        }
        .poll-container {
            margin-top: 8px;
        }
        .poll-bar {
            height: 8px;
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 4px;
        }
        .poll-bar-fill {
            height: 100%;
            transition: width 0.2s ease-in-out;
        }
        .poll-bar-sim {
            background: #4caf50; /* Verde para sim */
        }
        .poll-bar-nao {
            background: #f44336; /* Vermelho para não */
        }
        .winning {
            font-weight: bold;
        }
        .error-message {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--error-bg);
            color: var(--error-text);
            padding: 12px 24px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            z-index: 10000;
            display: flex;
            align-items: center;
            gap: 8px;
            animation: slideDown 0.5s ease-out, fadeOut 4s ease-out 1s forwards;
        }
        .error-message button {
            background: transparent;
            border: none;
            color: var(--error-text);
            cursor: pointer;
            font-size: 1rem;
        }
        @keyframes slideDown {
            from { transform: translateY(-100%) translateX(-50%); opacity: 0; }
            to { transform: translateY(0) translateX(-50%); opacity: 1; }
        }
        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; }
        }
        .gif-grid {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background: var(--background-color);
            padding: 16px;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            animation: slideUp 0.3s ease-out;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
            gap: 8px;
        }
        @keyframes slideUp {
            from { transform: translateY(100%); }
            to { transform: translateY(0); }
        }
        .gif-item {
            cursor: pointer;
            width: 80px;
            height: 80px;
            object-fit: cover;
            border-radius: 8px;
            transition: transform 0.2s;
        }
        .gif-item:hover {
            transform: scale(1.1);
        }
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-content {
            background: var(--background-color);
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            max-width: 80%;
        }
        .modal-input {
            margin-bottom: 10px;
            padding: 8px;
            width: 100%;
            border: 1px solid var(--border-color);
            border-radius: 4px;
        }
        .modal-buttons {
            display: flex;
            justify-content: space-around;
        }
        .modal-buttons button {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .modal-buttons button:first-child {
            background: var(--primary-color);
            color: #ffffff;
        }
        .modal-buttons button:last-child {
            background: #cccccc;
            color: #000000;
        }
        /* Ajustes para mobile */
        @media (max-width: 768px) {
            .chat-footer {
                padding: 8px 12px;
            }
            .fab-main {
                width: 44px;
                height: 44px;
            }
            .fab-action {
                width: 36px;
                height: 36px;
            }
            .send-button {
                width: 36px;
                height: 36px;
            }
            .chat-input {
                padding: 10px 14px;
            }
            .message-bubble {
                max-width: 85%;
            }
        }
        .theme-menu, .font-menu {
            position: fixed;
            bottom: 8rem;
            right: 3rem;
            background: var(--background-color);
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            padding: 1rem;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        .theme-button, .font-button {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            background: var(--primary-color);
            color: white;
            transition: background 0.3s;
        }
        .theme-button:hover, .font-button:hover {
            background: var(--secondary-color);
        }
    </style>
</head>
<body>
    <canvas id="particles"></canvas>
    <div class="loading-screen" id="loading-screen">
        <img
            src="https://i.postimg.cc/Ssk9kkHb/1757343420124.png"
            alt="GPV Logo"
            class="loading-logo"
        />
        <p class="loading-text">Iniciando GPV Chat...</p>
    </div>
    <div id="root"></div>
    <script type="text/babel">
        const AudioPlayer = ({ src }) => {
            const audioRef = React.useRef(null);
            const [isPlaying, setIsPlaying] = React.useState(false);
            const [progress, setProgress] = React.useState(0);
            React.useEffect(() => {
                const audio = audioRef.current;
                if (audio) {
                    const handleTimeUpdate = () => {
                        const current = audio.currentTime;
                        const duration = audio.duration;
                        setProgress((current / duration) * 100 || 0);
                    };
                    const handleEnded = () => setIsPlaying(false);
                    audio.addEventListener('timeupdate', handleTimeUpdate);
                    audio.addEventListener('ended', handleEnded);
                    return () => {
                        audio.removeEventListener('timeupdate', handleTimeUpdate);
                        audio.removeEventListener('ended', handleEnded);
                    };
                }
            }, []);
            const togglePlay = () => {
                if (isPlaying) {
                    audioRef.current.pause();
                } else {
                    audioRef.current.play();
                }
                setIsPlaying(!isPlaying);
            };
            const handleSeek = (e) => {
                const seekTime = (e.target.value / 100) * audioRef.current.duration;
                audioRef.current.currentTime = seekTime;
                setProgress(e.target.value);
            };
            return (
                <div className="message-audio">
                    <button onClick={togglePlay} className="control-button">
                        <i className={`fas ${isPlaying ? 'fa-pause' : 'fa-play'}`}></i>
                    </button>
                    <div className="waveform">
                        {Array.from({ length: 10 }).map((_, i) => (
                            <div
                                key={i}
                                className="wave-bar"
                                style={{ height: `${10 + Math.random() * 10}px` }}
                            ></div>
                        ))}
                    </div>
                    <input
                        type="range"
                        value={progress}
                        onChange={handleSeek}
                        min="0"
                        max="100"
                        className="w-full h-1 bg-gray-200 rounded-lg"
                    />
                    <audio ref={audioRef} src={src} />
                </div>
            );
        };
        const PollComponent = ({ id, question, votes, onVote }) => {
            const parsedVotes = votes ? JSON.parse(votes) : {};
            const options = Object.keys(parsedVotes);
            const total = options.reduce((sum, opt) => sum + parsedVotes[opt], 0);
            return (
                <div className="poll-container">
                    <p>{question}</p>
                    {options.map((opt, index) => {
                        const count = parsedVotes[opt];
                        const percent = total > 0 ? (count / total) * 100 : 0;
                        const colors = ['#4caf50', '#f44336', '#2196f3', '#ffeb3b', '#9c27b0'];
                        const color = colors[index % colors.length];
                        return (
                            <div key={opt}>
                                <p>{opt}: {count} ({percent.toFixed(1)}%)</p>
                                <div className="poll-bar">
                                    <div className="poll-bar-fill" style={{ width: `${percent}%`, background: color }}></div>
                                </div>
                                <button onClick={() => onVote(id, opt)}>Votar {opt}</button>
                            </div>
                        );
                    })}
                </div>
            );
        };
        const ErrorMessage = ({ message, onClose }) => {
            return (
                <div className="error-message">
                    <i className="fas fa-exclamation-circle"></i>
                    <span>{message}</span>
                    <button onClick={onClose}>
                        <i className="fas fa-times"></i>
                    </button>
                </div>
            );
        };
        const GifGrid = ({ onSelect }) => {
            const gifs = [
                'https://i.imgur.com/FTYI8EA.png',
                'https://i.imgur.com/Wiq0mGa.png',
                'https://i.imgur.com/ASQUHNJ.png',
                'https://i.imgur.com/TXfb8dj.png'
            ];
            return (
                <div className="gif-grid">
                    {gifs.map((gif, index) => (
                        <img
                            key={index}
                            src={gif}
                            alt={`GIF ${index + 1}`}
                            className="gif-item"
                            onClick={() => onSelect(gif)}
                        />
                    ))}
                </div>
            );
        };
        const ChatMessage = ({ id, usuario, mensagem, data, fotoPerfil, isRight, mensacao, laughs, sads, arquivosGravados, quotedMsg, enquete, citacao, onLike, onLaugh, onSad, onQuote, onImageClick, onDelete, onVote }) => {
            const [isAnimating, setIsAnimating] = React.useState(false);
            const [hearts, setHearts] = React.useState([]);
            const formatDate = (dateString) => {
                const date = new Date(dateString);
                return date.toLocaleString('pt-BR', {
                    hour: '2-digit',
                    minute: '2-digit'
                });
            };
            const handleLike = () => {
                if (!isAnimating) {
                    setIsAnimating(true);
                    const newHearts = Array.from({ length: 10 }, (_, i) => ({
                        id: i,
                        left: `${Math.random() * 100}%`,
                        animationDelay: `${Math.random() * 0.5}s`
                    }));
                    setHearts(newHearts);
                    onLike(id, mensacao);
                    setTimeout(() => {
                        setIsAnimating(false);
                        setHearts([]);
                    }, 1000);
                }
            };
            const handleLaugh = () => {
                onLaugh(id, laughs);
            };
            const handleSad = () => {
                onSad(id, sads);
            };
            const handleQuote = () => {
                onQuote({ id, usuario, mensagem, data, fotoPerfil, mensacao, laughs, sads, arquivosGravados });
            };
            mensagem = mensagem || '';
            const isImage = /\.(jpg|png|gif)$/i.test(mensagem);
            const isVideo = /\.(mp4|webm|ogg)$/i.test(mensagem);
            const isPoll = mensagem.startsWith('Enquete: ');
            const pollQuestion = isPoll ? mensagem.substring(9) : '';
            const cleanMessage = mensagem.replace(/[\r\n]+/g, ' ').trim();
            const parts = cleanMessage.split(/(@\w+)/g);
            const renderedMessage = parts.map((part, index) => {
                if (part.startsWith('@')) {
                    return <span key={index} className="mention">{part}</span>;
                }
                return part;
            });
            const likeCount = parseInt(mensacao || '0', 10);
            const laughCount = parseInt(laughs || '0', 10);
            const sadCount = parseInt(sads || '0', 10);
            const audioFile = arquivosGravados && arquivosGravados.length > 0 ? arquivosGravados[0] : null;
            const userDisplay = usuario && usuario !== 'string' ? usuario : 'Anônimo';
            return (
                <div className={`flex ${isRight ? 'justify-end' : 'justify-start'} mb-4 message message-${isRight ? 'right' : 'left'}`}>
                    <div className={`flex ${isRight ? 'flex-row-reverse' : 'flex-row'} items-start w-full`}>
                        <img
                            src={fotoPerfil || 'https://i.postimg.cc/Ssk9kkHb/1757343420124.png'}
                            alt="Profile"
                            className="w-10 h-10 rounded-full object-cover mt-2"
                        />
                        <div className="flex flex-col mx-2 w-full relative">
                            <div className={`message-bubble ${isAnimating ? 'radiate' : ''}`}>
                                <span className="text-xs font-semibold" style={{ color: isRight ? 'var(--primary-color)' : '#ffffff' }}>{userDisplay}</span>
                                {quotedMsg && (
                                    <div className="quoted-message">
                                        <span className="quoted-user">{quotedMsg.Usuario}</span>
                                        {/\.(jpg|png|gif)$/i.test(quotedMsg.DIGIOTOU) && (
                                            <img src={quotedMsg.DIGIOTOU} alt="Quoted image" className="quoted-image" />
                                        )}
                                        <p className="quoted-text">{quotedMsg.DIGIOTOU}</p>
                                    </div>
                                )}
                                {citacao && <p className="quoted-text">{citacao}</p>}
                                {isPoll ? (
                                    <PollComponent id={id} question={pollQuestion} votes={enquete} onVote={onVote} />
                                ) : isImage ? (
                                    <img
                                        src={mensagem}
                                        alt="Message"
                                        className="message-image"
                                        onClick={() => onImageClick(mensagem)}
                                    />
                                ) : isVideo ? (
                                    <video
                                        src={mensagem}
                                        controls
                                        className="message-image"
                                    />
                                ) : audioFile ? (
                                    <AudioPlayer src={audioFile.url} />
                                ) : (
                                    <p className="text-sm leading-relaxed mt-1">{renderedMessage}</p>
                                )}
                                <div className="flex items-center justify-end mt-1">
                                    <span className="text-xs text-gray-500">{formatDate(data)}</span>
                                    {isRight && <i className="fas fa-check text-xs text-gray-500 ml-1"></i>}
                                </div>
                            </div>
                            <div className="heart-rain">
                                {hearts.map(heart => (
                                    <i
                                        key={heart.id}
                                        className="fas fa-heart heart"
                                        style={{
                                            left: heart.left,
                                            animationDelay: heart.animationDelay
                                        }}
                                    ></i>
                                ))}
                            </div>
                            <div className="flex gap-2">
                                {!isRight && (
                                    <div className="like-button" onClick={handleLike}>
                                        <i className="fas fa-heart"></i>
                                        <span>{likeCount}</span>
                                    </div>
                                )}
                                {!isRight && (
                                    <div className="laugh-button" onClick={handleLaugh}>
                                        <i className="fas fa-laugh"></i>
                                        <span>{laughCount}</span>
                                    </div>
                                )}
                                {!isRight && (
                                    <div className="sad-button" onClick={handleSad}>
                                        <i className="fas fa-sad-tear"></i>
                                        <span>{sadCount}</span>
                                    </div>
                                )}
                                {!isRight && (
                                    <div className="quote-button" onClick={handleQuote}>
                                        <i className="fas fa-reply"></i>
                                    </div>
                                )}
                                <div className="delete-button" onClick={() => onDelete(id)}>
                                    <i className="fas fa-trash"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };
        const FullscreenImage = ({ src, onClose }) => {
            return (
                <div className="fullscreen-image" onClick={onClose}>
                    <img src={src} alt="Fullscreen" />
                    <button className="close-button" onClick={onClose}>
                        <i className="fas fa-times"></i>
                    </button>
                </div>
            );
        };
        const RecordingAnimation = ({ duration }) => {
            return (
                <div className="recording-animation">
                    <i className="fas fa-microphone recording-icon"></i>
                    <div className="recording-wave">
                        <div className="recording-wave-bar"></div>
                        <div className="recording-wave-bar"></div>
                        <div className="recording-wave-bar"></div>
                        <div className="recording-wave-bar"></div>
                        <div className="recording-wave-bar"></div>
                    </div>
                    <span className="text-xs font-semibold" style={{ color: 'var(--primary-color)' }}>
                        Gravando... {duration}s
                    </span>
                </div>
            );
        };
        const ProgressBar = ({ progress }) => {
            return (
                <div className="progress-bar-container">
                    <div className="progress-bar">
                        <div
                            className="progress-bar-fill"
                            style={{ width: `${progress}%` }}
                        ></div>
                    </div>
                    <div className="progress-text">Enviando: {Math.round(progress)}%</div>
                </div>
            );
        };
        const TypingIndicator = ({ user, avatar }) => {
            return (
                <div className="typing-indicator">
                    <img src={avatar || 'https://i.postimg.cc/Ssk9kkHb/1757343420124.png'}
                         alt="Avatar" className="typing-avatar" />
                    <span className="typing-text">{user} está digitando</span>
                    <div className="flex gap-1">
                        <div className="dot"></div>
                        <div className="dot"></div>
                        <div className="dot"></div>
                    </div>
                </div>
            );
        };
        const ConfirmModal = ({ message, onConfirm, onCancel }) => {
            return (
                <div className="modal">
                    <div className="modal-content">
                        <p>{message}</p>
                        <div className="modal-buttons">
                            <button onClick={onConfirm}>Sim</button>
                            <button onClick={onCancel}>Não</button>
                        </div>
                    </div>
                </div>
            );
        };
        const PromptModal = ({ title, onSubmit, onCancel }) => {
            const [value, setValue] = React.useState('');
            return (
                <div className="modal">
                    <div className="modal-content">
                        <p>{title}</p>
                        <textarea className="modal-input" style={{height: '100px'}} value={value} onChange={e => setValue(e.target.value)} />
                        <div className="modal-buttons">
                            <button onClick={() => onSubmit(value)}>Enviar</button>
                            <button onClick={onCancel}>Cancelar</button>
                        </div>
                    </div>
                </div>
            );
        };
        const ThemeMenu = ({ onSelect }) => {
            return (
                <div className="theme-menu">
                    <button className="theme-button" onClick={() => onSelect('light')}>Claro</button>
                    <button className="theme-button" onClick={() => onSelect('dark')}>Escuro</button>
                    <button className="theme-button" onClick={() => onSelect('nature')}>Natureza</button>
                </div>
            );
        };
        const FontMenu = ({ onSelect }) => {
            return (
                <div className="font-menu">
                    <button className="font-button" onClick={() => onSelect('small')}>Pequeno</button>
                    <button className="font-button" onClick={() => onSelect('medium')}>Médio</button>
                    <button className="font-button" onClick={() => onSelect('large')}>Grande</button>
                    <button className="font-button" onClick={() => onSelect('xlarge')}>Extra Grande</button>
                </div>
            );
        };
        const ChatApp = () => {
            const [messages, setMessages] = React.useState([]);
            const [typingUser, setTypingUser] = React.useState(null);
            const [typingUserData, setTypingUserData] = React.useState(null);
            const [isLoading, setIsLoading] = React.useState(true);
            const [fullscreenImage, setFullscreenImage] = React.useState(null);
            const [inputText, setInputText] = React.useState('');
            const [isRecording, setIsRecording] = React.useState(false);
            const [userData, setUserData] = React.useState(null);
            const [currentUserId, setCurrentUserId] = React.useState(null);
            const [mediaRecorder, setMediaRecorder] = React.useState(null);
            const [theme, setTheme] = React.useState('light');
            const [fontSize, setFontSize] = React.useState('medium');
            const [showThemeMenu, setShowThemeMenu] = React.useState(false);
            const [showFontMenu, setShowFontMenu] = React.useState(false);
            const [uploadProgress, setUploadProgress] = React.useState(null);
            const [fabOpen, setFabOpen] = React.useState(false);
            const [recordingDuration, setRecordingDuration] = React.useState(0);
            const [quotedMessage, setQuotedMessage] = React.useState(null);
            const [errorMessages, setErrorMessages] = React.useState([]);
            const [audioPreview, setAudioPreview] = React.useState(null);
            const [showGifGrid, setShowGifGrid] = React.useState(false);
            const [confirmModal, setConfirmModal] = React.useState({ open: false, message: '', onConfirm: () => {}, id: null });
            const [promptModal, setPromptModal] = React.useState({ open: false, title: '', onSubmit: () => {} });
            const messagesEndRef = React.useRef(null);
            const currentUser = userData?.NOME || "Anônimo";
            const defaultProfilePic = 'https://i.postimg.cc/Ssk9kkHb/1757343420124.png';
            const apiToken = 'UkqZsuMMnwE59fMqs8OwXX60SASP7FOd';
            // Função para mostrar mensagens de erro
            const showError = (message) => {
                const id = Date.now();
                setErrorMessages(prev => [...prev, { id, message }]);
                setTimeout(() => {
                    setErrorMessages(prev => prev.filter(err => err.id !== id));
                }, 5000);
            };
            // Partículas
            React.useEffect(() => {
                const canvas = document.getElementById('particles');
                const ctx = canvas.getContext('2d');
                canvas.width = window.innerWidth;
                canvas.height = window.innerHeight;
                const particles = [];
                const particleCount = 50;
                for (let i = 0; i < particleCount; i++) {
                    particles.push({
                        x: Math.random() * canvas.width,
                        y: Math.random() * canvas.height,
                        size: Math.random() * 5 + 1,
                        speed: Math.random() * 0.5 + 0.2
                    });
                }
                const animateParticles = () => {
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    particles.forEach(particle => {
                        ctx.beginPath();
                        ctx.arc(particle.x, particle.y, particle.size, 0, Math.PI * 2);
                        ctx.fillStyle = '#0066cc';
                        ctx.globalAlpha = 0.5;
                        ctx.fill();
                        particle.y -= particle.speed;
                        if (particle.y < -particle.size) {
                            particle.y = canvas.height + particle.size;
                            particle.x = Math.random() * canvas.width;
                        }
                    });
                    requestAnimationFrame(animateParticles);
                };
                animateParticles();
                const handleResize = () => {
                    canvas.width = window.innerWidth;
                    canvas.height = window.innerHeight;
                };
                window.addEventListener('resize', handleResize);
                return () => window.removeEventListener('resize', handleResize);
            }, []);
            // Aplicar tema e tamanho da fonte
            React.useEffect(() => {
                document.body.setAttribute('data-theme', theme);
                document.body.className = `text-${fontSize}`;
            }, [theme, fontSize]);
            // Atualizar status de digitação
            const updateTypingStatus = async (isTyping) => {
                if (!currentUserId) return;
                try {
                    await axios({
                        method: 'PATCH',
                        url: `https://api.baserow.io/api/database/rows/table/314649/${currentUserId}/?user_field_names=true`,
                        headers: { Authorization: `Token ${apiToken}` },
                        data: {
                            digitandotruefalse: isTyping ? 'true' : 'false',
                            DigitandoUser: currentUser
                        }
                    });
                    console.log('Status de digitação atualizado:', isTyping);
                } catch (error) {
                    console.error('Erro ao atualizar status de digitação:', error);
                    showError('Erro ao atualizar status de digitação.');
                }
            };
            const createField = async (name, type) => {
                try {
                    const response = await axios({
                        method: 'GET',
                        url: 'https://api.baserow.io/api/database/fields/table/459281/',
                        headers: { Authorization: `Token ${apiToken}` }
                    });
                    const fields = response.data;
                    const hasColumn = fields.some(field => field.name === name);
                    if (!hasColumn) {
                        await axios({
                            method: 'POST',
                            url: 'https://api.baserow.io/api/database/fields/table/459281/',
                            headers: { Authorization: `Token ${apiToken}` },
                            data: {
                                name: name,
                                type: type
                            }
                        });
                        console.log(`Coluna ${name} criada com sucesso`);
                    }
                } catch (error) {
                    console.error(`Erro ao criar/verificar coluna ${name}:`, error);
                    showError(`Erro ao criar/verificar coluna ${name}.`);
                }
            };
            const initializeColumns = async () => {
                await createField('ArquivosGravados', 'file');
                await createField('QuotedId', 'text');
                await createField('citacao', 'text');
                await createField('enquete', 'text');
                await createField('laughs', 'text');
                await createField('sads', 'text');
                await createField('EnqueteArmazenamento', 'text'); // Adaptado do schema
                await createField('ColunaParaUsarExtra', 'text'); // Adaptado do schema
            };
            const fetchUserData = async () => {
                try {
                    const response = await axios({
                        method: 'GET',
                        url: 'https://api.baserow.io/api/database/rows/table/221009/?user_field_names=true',
                        headers: { Authorization: `Token ${apiToken}` }
                    });
                    const results = response.data.results;
                    const activeUserRow = results.find(row => row.ultimoclick && row.ultimoclick.trim() !== '');
                    if (activeUserRow) {
                        const userId = activeUserRow.id;
                        setCurrentUserId(userId);
                        setUserData({ NOME: activeUserRow.NOME, PERFIL: activeUserRow.PERFIL });
                        console.log('Usuário ativo encontrado:', activeUserRow);
                        await axios({
                            method: 'PATCH',
                            url: `https://api.baserow.io/api/database/rows/table/221009/${userId}/?user_field_names=true`,
                            headers: { Authorization: `Token ${apiToken}` },
                            data: { ultimoclick: '' }
                        });
                        console.log('Campo ultimoclick limpo com sucesso');
                    } else {
                        console.error('Nenhum usuário ativo encontrado (ultimoclick vazio)');
                        setUserData({ NOME: "Anônimo", PERFIL: defaultProfilePic });
                    }
                } catch (error) {
                    console.error('Erro ao buscar dados do usuário:', error);
                    showError('Erro ao carregar dados do usuário.');
                    setUserData({ NOME: "Anônimo", PERFIL: defaultProfilePic });
                }
            };
            const fetchMessages = async () => {
                try {
                    const response = await axios({
                        method: 'GET',
                        url: 'https://api.baserow.io/api/database/rows/table/459281/?user_field_names=true',
                        headers: { Authorization: `Token ${apiToken}` }
                    });
                    const results = response.data.results;
                    const processedMessages = results.map(msg => {
                        if (msg.QuotedId) {
                            const quotedId = parseInt(msg.QuotedId, 10);
                            const quotedMsg = results.find(m => m.id === quotedId);
                            return { ...msg, quotedMsg };
                        }
                        return msg;
                    });
                    setMessages(processedMessages);
                    console.log('Mensagens obtidas:', processedMessages);
                } catch (error) {
                    console.error('Erro ao buscar mensagens:', error);
                    showError('Erro ao carregar mensagens.');
                    setMessages([]);
                }
            };
            const fetchTypingStatus = async () => {
                try {
                    const response = await axios({
                        method: 'GET',
                        url: 'https://api.baserow.io/api/database/rows/table/314649/?user_field_names=true',
                        headers: { Authorization: `Token ${apiToken}` }
                    });
                    const typingData = response.data.results.find(user => user.digitandotruefalse === 'true' && user.DigitandoUser !== currentUser);
                    if (typingData) {
                        setTypingUser(typingData.DigitandoUser);
                        console.log('Usuário digitando detectado:', typingData.DigitandoUser);
                        try {
                            const userResponse = await axios({
                                method: 'GET',
                                url: `https://api.baserow.io/api/database/rows/table/221009/?user_field_names=true`,
                                headers: { Authorization: `Token ${apiToken}` }
                            });
                            const userData = userResponse.data.results.find(user => user.NOME === typingData.DigitandoUser);
                            setTypingUserData(userData);
                            console.log('Dados do usuário digitando:', userData);
                        } catch (error) {
                            console.error('Erro ao buscar dados do usuário digitando:', error);
                            showError('Erro ao carregar dados do usuário digitando.');
                            setTypingUserData(null);
                        }
                    } else {
                        setTypingUser(null);
                        setTypingUserData(null);
                        console.log('Nenhum usuário digitando.');
                    }
                } catch (error) {
                    console.error('Erro ao buscar status de digitação:', error);
                    showError('Erro ao verificar status de digitação.');
                    setTypingUser(null);
                    setTypingUserData(null);
                }
            };
            const likeMessage = async (id, currentLikes) => {
                try {
                    const currentCount = parseInt(currentLikes || '0', 10);
                    const newCount = currentCount + 1;
                    await axios({
                        method: 'PATCH',
                        url: `https://api.baserow.io/api/database/rows/table/459281/${id}/?user_field_names=true`,
                        data: { mensacao: newCount.toString() },
                        headers: { Authorization: `Token ${apiToken}` }
                    });
                    fetchMessages();
                } catch (error) {
                    console.error('Erro ao curtir mensagem:', error);
                    showError('Erro ao curtir mensagem.');
                }
            };
            const laughMessage = async (id, currentLaughs) => {
                try {
                    const currentCount = parseInt(currentLaughs || '0', 10);
                    const newCount = currentCount + 1;
                    await axios({
                        method: 'PATCH',
                        url: `https://api.baserow.io/api/database/rows/table/459281/${id}/?user_field_names=true`,
                        data: { laughs: newCount.toString() },
                        headers: { Authorization: `Token ${apiToken}` }
                    });
                    fetchMessages();
                } catch (error) {
                    console.error('Erro ao reagir com riso:', error);
                    showError('Erro ao reagir com riso.');
                }
            };
            const sadMessage = async (id, currentSads) => {
                try {
                    const currentCount = parseInt(currentSads || '0', 10);
                    const newCount = currentCount + 1;
                    await axios({
                        method: 'PATCH',
                        url: `https://api.baserow.io/api/database/rows/table/459281/${id}/?user_field_names=true`,
                        data: { sads: newCount.toString() },
                        headers: { Authorization: `Token ${apiToken}` }
                    });
                    fetchMessages();
                } catch (error) {
                    console.error('Erro ao reagir com tristeza:', error);
                    showError('Erro ao reagir com tristeza.');
                }
            };
            const votePoll = async (id, vote) => {
                try {
                    const response = await axios({
                        method: 'GET',
                        url: `https://api.baserow.io/api/database/rows/table/459281/${id}/?user_field_names=true`,
                        headers: { Authorization: `Token ${apiToken}` }
                    });
                    let currentVotes = response.data.enquete ? JSON.parse(response.data.enquete) : {};
                    if (currentVotes[vote]) {
                        currentVotes[vote] += 1;
                    } else {
                        currentVotes[vote] = 1;
                    }
                    await axios({
                        method: 'PATCH',
                        url: `https://api.baserow.io/api/database/rows/table/459281/${id}/?user_field_names=true`,
                        data: { enquete: JSON.stringify(currentVotes) },
                        headers: { Authorization: `Token ${apiToken}` }
                    });
                    fetchMessages();
                } catch (error) {
                    console.error('Erro ao votar na enquete:', error);
                    showError('Erro ao registrar voto na enquete.');
                }
            };
            const deleteMessage = (id) => {
                setConfirmModal({
                    open: true,
                    message: 'Tem certeza que deseja apagar esta mensagem para todos?',
                    onConfirm: async () => {
                        try {
                            await axios({
                                method: 'DELETE',
                                url: `https://api.baserow.io/api/database/rows/table/459281/${id}/`,
                                headers: { Authorization: `Token ${apiToken}` }
                            });
                            fetchMessages();
                        } catch (error) {
                            console.error('Erro ao apagar mensagem:', error);
                            showError('Erro ao apagar mensagem.');
                        }
                        setConfirmModal({ open: false, message: '', onConfirm: () => {} });
                    },
                    id
                });
            };
            const createPoll = () => {
                setPromptModal({
                    open: true,
                    title: 'Digite a pergunta da enquete na primeira linha, e as opções nas linhas seguintes (uma por linha):',
                    onSubmit: async (input) => {
                        if (input) {
                            const lines = input.split('\n').filter(line => line.trim() !== '');
                            const question = lines[0].trim();
                            const options = lines.slice(1).map(opt => opt.trim());
                            if (options.length < 2) {
                                showError('Adicione pelo menos duas opções.');
                                return;
                            }
                            const votesJson = JSON.stringify(options.reduce((acc, opt) => ({ ...acc, [opt]: 0 }), {}));
                            await handleSendMessage({ DIGIOTOU: `Enquete: ${question}`, enquete: votesJson });
                        }
                        setPromptModal({ open: false, title: '', onSubmit: () => {} });
                    }
                });
            };
            const uploadFile = async (file, fileName) => {
                try {
                    const formData = new FormData();
                    formData.append('file', file, fileName);
                    const response = await axios({
                        method: 'POST',
                        url: 'https://api.baserow.io/api/user-files/upload-file/',
                        headers: {
                            Authorization: `Token ${apiToken}`,
                            'Content-Type': 'multipart/form-data'
                        },
                        data: formData,
                        onUploadProgress: (progressEvent) => {
                            const percentCompleted = Math.round((progressEvent.loaded * 100) / progressEvent.total);
                            setUploadProgress(percentCompleted);
                        }
                    });
                    setUploadProgress(null);
                    return response.data;
                } catch (error) {
                    console.error('Erro ao fazer upload do arquivo:', error);
                    showError('Erro ao fazer upload do arquivo.');
                    setUploadProgress(null);
                    return null;
                }
            };
            const handleSendMessage = async (fileData = null) => {
                if (inputText.trim() || fileData) {
                    try {
                        const data = {
                            Usuario: currentUser,
                            DIGIOTOU: inputText || (fileData && !fileData.isAudio ? fileData.url : ''),
                            DATAENVIO: new Date().toISOString(),
                            FOTOPERFIL: userData?.PERFIL || defaultProfilePic,
                            mensacao: '0'
                        };
                        if (quotedMessage) {
                            data.QuotedId = quotedMessage.id.toString();
                        }
                        if (fileData && fileData.isAudio) {
                            data.ArquivosGravados = [{ name: fileData.name, url: fileData.url }];
                        }
                        await axios({
                            method: 'POST',
                            url: 'https://api.baserow.io/api/database/rows/table/459281/?user_field_names=true',
                            data,
                            headers: { Authorization: `Token ${apiToken}` }
                        });
                        setInputText('');
                        setQuotedMessage(null);
                        fetchMessages();
                    } catch (error) {
                        console.error('Erro ao enviar mensagem:', error);
                        showError('Erro ao enviar mensagem.');
                        setInputText('');
                        setQuotedMessage(null);
                    }
                }
            };
            const handleImageClick = (src) => {
                setFullscreenImage(src);
            };
            const closeFullscreenImage = () => {
                setFullscreenImage(null);
            };
            let audioChunks = [];
            const handleRecordAudio = async () => {
                if (isRecording) {
                    if (mediaRecorder) {
                        mediaRecorder.stop();
                    }
                    setFabOpen(false);
                    return;
                }
                try {
                    console.log('Tentando acessar o microfone...');
                    if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                        showError('Seu navegador não suporta gravação de áudio. Tente usar outro navegador.');
                        return;
                    }
                    const permissionStatus = await navigator.permissions.query({ name: 'microphone' });
                    console.log('Status da permissão do microfone:', permissionStatus.state);
                    if (permissionStatus.state === 'denied') {
                        showError('Permissão de microfone negada. Habilite o acesso nas configurações do navegador.');
                        return;
                    }
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    console.log('Microfone acessado com sucesso');
                    const recorder = new MediaRecorder(stream);
                    audioChunks = [];
                    const startTime = Date.now();
                    const updateDuration = () => {
                        setRecordingDuration(Math.floor((Date.now() - startTime) / 1000));
                    };
                    const durationInterval = setInterval(updateDuration, 1000);
                    recorder.ondataavailable = (event) => {
                        audioChunks.push(event.data);
                        console.log('Dados de áudio recebidos:', event.data);
                    };
                    recorder.onstop = async () => {
                        clearInterval(durationInterval);
                        setRecordingDuration(0);
                        console.log('Gravação parada, processando áudio...');
                        const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                        const audioUrl = URL.createObjectURL(audioBlob);
                        setAudioPreview(audioUrl);
                        setIsRecording(false);
                        setMediaRecorder(null);
                    };
                    recorder.onerror = (error) => {
                        clearInterval(durationInterval);
                        setRecordingDuration(0);
                        console.error('Erro na gravação de áudio:', error);
                        showError('Erro ao gravar áudio. Verifique as permissões do microfone.');
                        stream.getTracks().forEach(track => track.stop());
                        setIsRecording(false);
                        setMediaRecorder(null);
                    };
                    recorder.start();
                    console.log('Gravação iniciada');
                    setMediaRecorder(recorder);
                    setIsRecording(true);
                    setFabOpen(false);
                } catch (error) {
                    console.error('Erro ao iniciar gravação:', error);
                    showError('Não foi possível acessar o microfone. Verifique HTTPS ou permissões.');
                    setIsRecording(false);
                }
            };
            const sendAudio = async () => {
                if (audioPreview) {
                    const audioBlob = await fetch(audioPreview).then(r => r.blob());
                    const audioFile = await uploadFile(audioBlob, `audio_${Date.now()}.webm`);
                    if (audioFile) {
                        await handleSendMessage({ ...audioFile, isAudio: true });
                    } else {
                        showError('Erro ao enviar áudio.');
                    }
                    setAudioPreview(null);
                }
            };
            const cancelAudio = () => {
                setAudioPreview(null);
            };
            const handleUploadPhoto = () => {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = 'image/*';
                input.onchange = async (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        try {
                            const fileData = await uploadFile(file, file.name);
                            if (fileData) {
                                await handleSendMessage(fileData);
                            } else {
                                showError('Erro ao enviar foto.');
                            }
                        } catch (error) {
                            console.error('Erro ao enviar foto:', error);
                            showError('Erro ao enviar foto. Tente novamente.');
                        }
                    }
                };
                input.click();
                setFabOpen(false);
            };
            const handleUploadAudio = () => {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = 'audio/*';
                input.onchange = async (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        try {
                            const fileData = await uploadFile(file, file.name);
                            if (fileData) {
                                await handleSendMessage({ ...fileData, isAudio: true });
                            } else {
                                showError('Erro ao enviar áudio.');
                            }
                        } catch (error) {
                            console.error('Erro ao enviar áudio:', error);
                            showError('Erro ao enviar áudio. Tente novamente.');
                        }
                    }
                };
                input.click();
                setFabOpen(false);
            };
            const handleUploadVideo = () => {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = 'video/*';
                input.onchange = async (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        try {
                            const fileData = await uploadFile(file, file.name);
                            if (fileData) {
                                await handleSendMessage(fileData);
                            } else {
                                showError('Erro ao enviar vídeo.');
                            }
                        } catch (error) {
                            console.error('Erro ao enviar vídeo:', error);
                            showError('Erro ao enviar vídeo. Tente novamente.');
                        }
                    }
                };
                input.click();
                setFabOpen(false);
            };
            const handleKeyPress = (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    handleSendMessage();
                    setFabOpen(false);
                }
            };
            const handleInputChange = (e) => {
                setInputText(e.target.value);
                updateTypingStatus(e.target.value.length > 0);
            };
            const toggleFab = () => {
                setFabOpen(!fabOpen);
                setShowThemeMenu(false);
                setShowFontMenu(false);
            };
            const toggleThemeMenu = () => {
                setShowThemeMenu(!showThemeMenu);
                setShowFontMenu(false);
            };
            const toggleFontMenu = () => {
                setShowFontMenu(!showFontMenu);
                setShowThemeMenu(false);
            };
            const changeTheme = (newTheme) => {
                setTheme(newTheme);
                setShowThemeMenu(false);
                setFabOpen(false);
            };
            const changeFontSize = (newSize) => {
                setFontSize(newSize);
                setShowFontMenu(false);
                setFabOpen(false);
            };
            React.useEffect(() => {
                const initializeApp = async () => {
                    try {
                        console.log('Iniciando inicialização do aplicativo...');
                        await initializeColumns();
                        await Promise.allSettled([
                            fetchUserData(),
                            fetchMessages(),
                            fetchTypingStatus()
                        ]);
                        console.log('Inicialização concluída, ocultando tela de carregamento...');
                        setTimeout(() => {
                            setIsLoading(false);
                            const loadingScreen = document.getElementById('loading-screen');
                            if (loadingScreen) {
                                loadingScreen.classList.add('hidden');
                            }
                        }, 500); // Reduzido para carregamento mais rápido
                    } catch (error) {
                        console.error('Erro geral na inicialização do aplicativo:', error);
                        showError('Erro ao inicializar o aplicativo. Tentando novamente...');
                        setTimeout(initializeApp, 3000); // Retry automático
                    } finally {
                        setIsLoading(false);
                        const loadingScreen = document.getElementById('loading-screen');
                        if (loadingScreen) {
                            loadingScreen.classList.add('hidden');
                        }
                    }
                };
                initializeApp();
                const messageInterval = setInterval(fetchMessages, 5000);
                const typingInterval = setInterval(fetchTypingStatus, 2000);
                return () => {
                    clearInterval(messageInterval);
                    clearInterval(typingInterval);
                    if (mediaRecorder) {
                        mediaRecorder.stop();
                    }
                };
            }, [currentUserId]);
            React.useEffect(() => {
                const handleClickOutside = (event) => {
                    if (!event.target.closest('.fab-wrapper') && !event.target.closest('.fab-sub-menu')) {
                        setShowThemeMenu(false);
                        setShowFontMenu(false);
                        setFabOpen(false);
                    }
                };
                document.addEventListener('mousedown', handleClickOutside);
                return () => {
                    document.removeEventListener('mousedown', handleClickOutside);
                };
            }, []);
            return (
                <div className="chat-container">
                    {errorMessages.map(err => (
                        <ErrorMessage
                            key={err.id}
                            message={err.message}
                            onClose={() => setErrorMessages(prev => prev.filter(e => e.id !== err.id))}
                        />
                    ))}
                    <div className="chat-header">
                        {/* Título removido */}
                    </div>
                    <div className="chat-messages">
                        {messages.map((msg) => (
                            <ChatMessage
                                key={msg.id}
                                id={msg.id}
                                usuario={msg.Usuario}
                                mensagem={msg.DIGIOTOU}
                                data={msg.DATAENVIO}
                                fotoPerfil={msg.FOTOPERFIL}
                                isRight={msg.Usuario === currentUser}
                                mensacao={msg.mensacao}
                                laughs={msg.laughs}
                                sads={msg.sads}
                                arquivosGravados={msg.ArquivosGravados}
                                quotedMsg={msg.quotedMsg}
                                enquete={msg.enquete}
                                citacao={msg.citacao}
                                onLike={likeMessage}
                                onLaugh={laughMessage}
                                onSad={sadMessage}
                                onQuote={setQuotedMessage}
                                onImageClick={handleImageClick}
                                onDelete={deleteMessage}
                                onVote={votePoll}
                            />
                        ))}
                        {typingUser && (
                            <TypingIndicator
                                user={typingUser}
                                avatar={typingUserData?.PERFIL || defaultProfilePic}
                            />
                        )}
                        <div ref={messagesEndRef} />
                    </div>
                    <div className="chat-footer">
                        {isRecording && <RecordingAnimation duration={recordingDuration} />}
                        {uploadProgress !== null && <ProgressBar progress={uploadProgress} />}
                        {quotedMessage && (
                            <div className="quoted-preview">
                                <span>Citando {quotedMessage.usuario}:</span>
                                <p>{quotedMessage.mensagem.substring(0, 50)}...</p>
                                <button onClick={() => setQuotedMessage(null)}>X</button>
                            </div>
                        )}
                        {audioPreview ? (
                            <div className="audio-preview-container">
                                <audio controls src={audioPreview} />
                                <button onClick={sendAudio} className="send-audio-button">
                                    <i className="fas fa-paper-plane"></i>
                                </button>
                                <button onClick={cancelAudio} className="cancel-audio-button">
                                    <i className="fas fa-times"></i>
                                </button>
                            </div>
                        ) : (
                            <div className="input-container">
                                <input
                                    type="text"
                                    className="chat-input"
                                    placeholder="Digite uma mensagem..."
                                    value={inputText}
                                    onChange={handleInputChange}
                                    onKeyPress={handleKeyPress}
                                />
                                {inputText.trim() ? (
                                    <button
                                        className={`send-button visible`}
                                        onClick={() => handleSendMessage()}
                                    >
                                        <i className="fas fa-paper-plane"></i>
                                    </button>
                                ) : (
                                    <button
                                        className="mic-button"
                                        onClick={handleRecordAudio}
                                    >
                                        <i className="fas fa-microphone"></i>
                                    </button>
                                )}
                                <div className="fab-wrapper">
                                    <input id="fabCheckbox" type="checkbox" className="fab-checkbox" checked={fabOpen} onChange={toggleFab} />
                                    <label className="fab" htmlFor="fabCheckbox">
                                        <span className="fab-dots fab-dots-1"></span>
                                        <span className="fab-dots fab-dots-2"></span>
                                        <span className="fab-dots fab-dots-3"></span>
                                    </label>
                                    <div className="fab-wheel">
                                        <button className="fab-action" data-tooltip="Foto" onClick={handleUploadPhoto}>
                                            <i className="fas fa-camera"></i>
                                        </button>
                                        <button className="fab-action" data-tooltip="Áudio" onClick={handleUploadAudio}>
                                            <i className="fas fa-file-audio"></i>
                                        </button>
                                        <button className="fab-action" data-tooltip="Vídeo" onClick={handleUploadVideo}>
                                            <i className="fas fa-video"></i>
                                        </button>
                                        <button className="fab-action" data-tooltip="Tema" onClick={toggleThemeMenu}>
                                            <i className="fas fa-palette"></i>
                                        </button>
                                        <button className="fab-action" data-tooltip="Fonte" onClick={toggleFontMenu}>
                                            <i className="fas fa-text-height"></i>
                                        </button>
                                        <button className="fab-action" data-tooltip="Enquete" onClick={createPoll}>
                                            <i className="fas fa-poll"></i>
                                        </button>
                                        <button className="fab-action" data-tooltip="GIF" onClick={() => setShowGifGrid(true)}>
                                            <i className="fas fa-image"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        )}
                    </div>
                    {fullscreenImage && (
                        <FullscreenImage src={fullscreenImage} onClose={closeFullscreenImage} />
                    )}
                    {showGifGrid && (
                        <GifGrid onSelect={(gif) => {
                            handleSendMessage({ url: gif });
                            setShowGifGrid(false);
                        }} />
                    )}
                    {confirmModal.open && (
                        <ConfirmModal
                            message={confirmModal.message}
                            onConfirm={confirmModal.onConfirm}
                            onCancel={() => setConfirmModal({ open: false, message: '', onConfirm: () => {} })}
                        />
                    )}
                    {promptModal.open && (
                        <PromptModal
                            title={promptModal.title}
                            onSubmit={promptModal.onSubmit}
                            onCancel={() => setPromptModal({ open: false, title: '', onSubmit: () => {} })}
                        />
                    )}
                    {showThemeMenu && <ThemeMenu onSelect={changeTheme} />}
                    {showFontMenu && <FontMenu onSelect={changeFontSize} />}
                </div>
            );
        };
        ReactDOM.render(<ChatApp />, document.getElementById('root'));
    </script>
</body>
</html>
