<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>GPV Chat</title>
    <script src="https://cdn.jsdelivr.net/npm/react@18.2.0/umd/react.production.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/react-dom@18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios@1.6.2/dist/axios.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@babel/standalone@7.20.6/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/quagga@0.12.1/dist/quagga.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <style>
        :root {
            --primary-color: #0066cc;
            --secondary-color: #e6f7ff;
            --background-color: #ffffff;
            --text-color: #000000;
            --message-bg-left: #e6f7ff;
            --message-bg-right: #ffffff;
            --header-bg: #0066cc;
            --footer-bg: #ffffff;
            --border-color: #e5e7eb;
            --text-size: 14px;
            --progress-bar-bg: #e5e7eb;
            --progress-bar-fill: #0066cc;
            --quoted-color: #f0f0f0;
            --error-bg: #fef2f2;
            --error-text: #ef4444;
        }
        [data-theme="dark"] {
            --primary-color: #4a9eff;
            --secondary-color: #1a365d;
            --background-color: #1a202c;
            --text-color: #ffffff;
            --message-bg-left: #2d3748;
            --message-bg-right: #4a5568;
            --header-bg: #2d3748;
            --footer-bg: #2d3748;
            --border-color: #4a5568;
            --progress-bar-bg: #4a5568;
            --progress-bar-fill: #4a9eff;
            --quoted-color: #2d3748;
            --error-bg: #451a1a;
            --error-text: #fca5a5;
        }
        [data-theme="nature"] {
            --primary-color: #22c55e;
            --secondary-color: #dcfce7;
            --background-color: #f0fdf4;
            --text-color: #166534;
            --message-bg-left: #16a34a;
            --message-bg-right: #ffffff;
            --header-bg: transparent;
            --footer-bg: #ffffff;
            --border-color: #bbf7d0;
            --progress-bar-bg: #bbf7d0;
            --progress-bar-fill: #22c55e;
            --quoted-color: #dcfce7;
            --error-bg: #fef2f2;
            --error-text: #ef4444;
        }
        body {
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            background: var(--background-color);
            overscroll-behavior: none;
            position: relative;
            color: var(--text-color);
            font-size: var(--text-size);
            transition: all 0.3s ease;
        }
        .text-small { --text-size: 12px; }
        .text-medium { --text-size: 14px; }
        .text-large { --text-size: 16px; }
        .text-xlarge { --text-size: 18px; }
        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #ffffff;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: #0066cc;
            z-index: 9999;
            transition: opacity 0.7s ease-out;
        }
        .loading-screen.hidden {
            opacity: 0;
            pointer-events: none;
        }
        .loading-logo {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            object-fit: cover;
            margin-bottom: 20px;
            box-shadow: 0 0 15px rgba(0, 102, 204, 0.2);
            animation: logoScale 1.5s ease-in-out infinite;
        }
        @keyframes logoScale {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        .loading-text {
            font-size: 1.5rem;
            font-weight: 500;
            color: #0066cc;
        }
        .chat-container {
            height: 100vh;
            width: 100vw;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            touch-action: manipulation;
            position: relative;
        }
        .particles-background {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            z-index: 0;
        }
        .particle {
            position: absolute;
            background: rgba(0, 102, 204, 0.3);
            border-radius: 50%;
            animation: moveParticles 20s linear infinite;
        }
        @keyframes moveParticles {
            0% { transform: translate(0, 0); opacity: 0; }
            50% { opacity: 1; }
            100% { transform: translate(var(--x), var(--y)); opacity: 0; }
        }
        .chat-header {
            background: var(--header-bg);
            color: #ffffff;
            padding: 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            z-index: 10;
            border-bottom-left-radius: 20px;
            border-bottom-right-radius: 20px;
        }
        .error-message {
            background: var(--error-bg);
            color: var(--error-text);
            padding: 12px;
            text-align: center;
            font-weight: bold;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            position: sticky;
            top: 0;
            z-index: 20;
            animation: slideInDown 0.5s ease-out;
            cursor: pointer;
        }
        @keyframes slideInDown {
            from { transform: translateY(-100%); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        .global-delete-button {
            cursor: pointer;
            color: #ffffff;
            font-size: 1.2rem;
        }
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            scrollbar-width: thin;
            scrollbar-color: var(--primary-color) var(--border-color);
            padding: 16px;
            background: transparent;
            width: 100%;
            padding-bottom: 120px;
            position: relative;
            z-index: 1;
        }
        .chat-messages::-webkit-scrollbar {
            width: 6px;
        }
        .chat-messages::-webkit-scrollbar-track {
            background: var(--border-color);
        }
        .chat-messages::-webkit-scrollbar-thumb {
            background: var(--primary-color);
            border-radius: 3px;
        }
        .message {
            animation: fadeIn 0.3s ease-out;
            width: 100%;
            position: relative;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .message-bubble {
            position: relative;
            border-radius: 10px;
            padding: 10px 14px;
            max-width: 90%;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
            white-space: pre-wrap;
            word-wrap: normal;
            margin-bottom: 4px;
            display: inline-block;
            font-size: var(--text-size);
        }
        .message-bubble.radiate {
            animation: radiateBorder 0.5s ease-out;
        }
        @keyframes radiateBorder {
            0% { box-shadow: 0 0 0 0 rgba(0, 102, 204, 0.7); }
            100% { box-shadow: 0 0 0 10px rgba(0, 102, 204, 0); }
        }
        .message-bubble::after {
            content: '';
            position: absolute;
            width: 0;
            height: 0;
            border: 8px solid transparent;
        }
        .message-left .message-bubble {
            background: var(--message-bg-left);
            color: var(--primary-color);
        }
        .message-left .message-bubble::after {
            border-right-color: var(--message-bg-left);
            border-left: 0;
            left: -8px;
            top: 12px;
        }
        .message-right .message-bubble {
            background: var(--message-bg-right);
            color: var(--text-color);
        }
        .message-right .message-bubble::after {
            border-left-color: var(--message-bg-right);
            border-right: 0;
            right: -8px;
            top: 12px;
        }
        .message-image {
            max-width: 200px;
            border-radius: 10px;
            cursor: pointer;
            display: block;
        }
        .message-audio {
            max-width: 250px;
            border-radius: 20px;
            padding: 8px;
            background: #f0f0f0;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        .waveform {
            display: flex;
            gap: 2px;
            flex: 1;
            height: 20px;
            align-items: center;
        }
        .wave-bar {
            width: 4px;
            background: var(--primary-color);
            border-radius: 2px;
            animation: audioWave 1.5s infinite ease-in-out;
        }
        .wave-bar:nth-child(2) { animation-delay: -0.3s; }
        .wave-bar:nth-child(3) { animation-delay: -0.6s; }
        .wave-bar:nth-child(4) { animation-delay: -0.9s; }
        .wave-bar:nth-child(5) { animation-delay: -1.2s; }
        @keyframes audioWave {
            0%, 100% { height: 10px; }
            50% { height: 20px; }
        }
        .fullscreen-image {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .fullscreen-image img {
            max-width: 90%;
            max-height: 90%;
            object-fit: contain;
        }
        .close-button {
            position: absolute;
            top: 20px;
            right: 20px;
            background: var(--secondary-color);
            color: var(--primary-color);
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            font-size: 20px;
        }
        .like-button, .quote-button, .delete-button, .vote-button {
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 4px;
            color: var(--primary-color);
            font-size: calc(var(--text-size) * 0.8);
            margin-top: 4px;
            background: #f0f0f0;
            border-radius: 20px;
            padding: 4px 8px;
            transition: background 0.3s;
        }
        .like-button:hover, .quote-button:hover, .delete-button:hover, .vote-button:hover {
            background: var(--secondary-color);
        }
        .heart-rain {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 10;
        }
        .heart {
            position: absolute;
            color: var(--primary-color);
            font-size: 12px;
            opacity: 0;
            animation: heartRain 1s ease-out forwards;
        }
        @keyframes heartRain {
            0% { opacity: 1; transform: translateY(0) scale(1); }
            100% { opacity: 0; transform: translateY(100px) scale(0.5); }
        }
        .mention {
            color: var(--primary-color);
            font-weight: bold;
        }
        .typing-indicator {
            position: sticky;
            bottom: 60px;
            left: 16px;
            background: var(--secondary-color);
            border-radius: 15px;
            padding: 12px 16px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
            color: var(--text-color);
            font-size: calc(var(--text-size) * 0.9);
            display: flex;
            align-items: center;
            gap: 8px;
            animation: pulse 1.5s ease-in-out infinite;
            margin-top: 8px;
            width: fit-content;
            border: 2px solid var(--primary-color);
        }
        .typing-avatar {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            object-fit: cover;
        }
        .typing-text {
            font-weight: 600;
            font-size: calc(var(--text-size) * 1.1);
        }
        .dot {
            width: 6px;
            height: 6px;
            background: var(--primary-color);
            border-radius: 50%;
            animation: bounce 1.2s infinite ease-in-out;
        }
        .dot:nth-child(2) { animation-delay: -0.4s; }
        .dot:nth-child(3) { animation-delay: -0.8s; }
        @keyframes bounce {
            0%, 80%, 100% { transform: translateY(0); }
            40% { transform: translateY(-5px); }
        }
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        .chat-footer {
            background: var(--footer-bg);
            padding: 10px 16px;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 -2px 5px rgba(0, 0, 0, 0.1);
            z-index: 10;
            border-top-left-radius: 20px;
            border-top-right-radius: 20px;
            position: relative;
            flex-direction: column;
        }
        .chat-input {
            flex: 1;
            padding: 12px 16px;
            border: 2px solid var(--primary-color);
            border-radius: 20px;
            outline: none;
            font-size: var(--text-size);
            transition: border-color 0.3s ease, transform 0.2s ease;
            background: var(--background-color);
            color: var(--text-color);
            width: 100%;
        }
        .chat-input:focus {
            border-color: var(--secondary-color);
            transform: scale(1.02);
        }
        .fab-container {
            position: relative;
            display: flex;
            align-items: center;
        }
        .fab-main {
            background: var(--primary-color);
            color: #ffffff;
            border: none;
            border-radius: 50%;
            width: 48px;
            height: 48px;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: transform 0.3s ease;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }
        .fab-main:hover {
            background: var(--secondary-color);
            color: var(--primary-color);
            transform: scale(1.1);
        }
        .fab-main.open {
            transform: rotate(45deg);
        }
        .fab-actions {
            position: absolute;
            bottom: 60px;
            right: 16px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            opacity: 0;
            pointer-events: none;
            transform: translateY(20px);
            transition: all 0.3s ease;
        }
        .fab-actions.open {
            opacity: 1;
            pointer-events: auto;
            transform: translateY(0);
        }
        .fab-action {
            background: var(--primary-color);
            color: #ffffff;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }
        .fab-action:hover {
            background: var(--secondary-color);
            color: var(--primary-color);
            transform: scale(1.1);
        }
        .fab-action.recording {
            background: var(--primary-color);
            animation: pulseRecording 1s infinite;
        }
        .fab-action:disabled {
            background: #cccccc;
            cursor: not-allowed;
            transform: none;
        }
        @keyframes pulseRecording {
            0% { transform: scale(1); }
            50% { transform: scale(1.15); }
            100% { transform: scale(1); }
        }
        .send-button {
            background: var(--primary-color);
            color: #ffffff;
            border: none;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            opacity: 0;
            transform: scale(0);
        }
        .send-button.visible {
            opacity: 1;
            transform: scale(1);
        }
        .send-button:hover {
            background: var(--secondary-color);
            color: var(--primary-color);
            transform: scale(1.1);
        }
        .fab-sub-menu {
            position: absolute;
            bottom: 60px;
            right: 60px;
            background-color: var(--background-color);
            min-width: 160px;
            box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
            z-index: 1000;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            display: none;
        }
        .fab-sub-menu.open {
            display: block;
        }
        .fab-sub-menu-item {
            color: var(--text-color);
            padding: 12px 16px;
            text-decoration: none;
            display: block;
            cursor: pointer;
            border-radius: 8px;
            margin: 4px;
            transition: background-color 0.3s;
        }
        .fab-sub-menu-item:hover {
            background-color: var(--secondary-color);
        }
        .recording-animation {
            position: absolute;
            bottom: 60px;
            left: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
            background: var(--secondary-color);
            border-radius: 20px;
            padding: 8px 16px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            z-index: 9;
            animation: slideIn 0.3s ease-out;
        }
        .recording-icon {
            font-size: 1.5rem;
            color: var(--primary-color);
            animation: pulseIcon 1.5s infinite;
        }
        .recording-wave {
            display: flex;
            gap: 4px;
            align-items: center;
        }
        .recording-wave-bar {
            width: 6px;
            height: 20px;
            background: var(--primary-color);
            border-radius: 3px;
            animation: wave 1.2s infinite ease-in-out;
        }
        .recording-wave-bar:nth-child(2) { animation-delay: -0.3s; }
        .recording-wave-bar:nth-child(3) { animation-delay: -0.6s; }
        .recording-wave-bar:nth-child(4) { animation-delay: -0.9s; }
        .recording-wave-bar:nth-child(5) { animation-delay: -1.2s; }
        @keyframes wave {
            0%, 100% { transform: scaleY(1); }
            50% { transform: scaleY(2.5); }
        }
        @keyframes pulseIcon {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.3); }
        }
        @keyframes slideIn {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        .progress-bar-container {
            position: absolute;
            bottom: 80px;
            left: 16px;
            width: 200px;
            background: var(--secondary-color);
            border-radius: 12px;
            padding: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            z-index: 9;
            animation: slideIn 0.3s ease-out;
        }
        .progress-bar {
            height: 8px;
            background: var(--progress-bar-bg);
            border-radius: 4px;
            overflow: hidden;
        }
        .progress-bar-fill {
            height: 100%;
            background: var(--progress-bar-fill);
            transition: width 0.2s ease-in-out;
        }
        .progress-text {
            font-size: calc(var(--text-size) * 0.8);
            color: var(--primary-color);
            margin-top: 4px;
            text-align: center;
        }
        .quoted-message {
            background: var(--quoted-color);
            padding: 8px;
            border-radius: 8px;
            margin-bottom: 8px;
            border-left: 4px solid var(--primary-color);
        }
        .quoted-user {
            font-weight: bold;
            color: var(--primary-color);
        }
        .quoted-text {
            font-size: 0.9em;
        }
        .quoted-preview {
            background: var(--quoted-color);
            padding: 8px;
            border-radius: 8px;
            margin-bottom: 8px;
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            width: 100%;
        }
        .quoted-preview button {
            background: transparent;
            border: none;
            color: var(--primary-color);
            cursor: pointer;
            align-self: flex-end;
        }
        .input-container {
            display: flex;
            align-items: center;
            gap: 8px;
            width: 100%;
        }
        .reply-text {
            color: var(--primary-color);
            font-size: calc(var(--text-size) * 0.8);
            margin-top: 4px;
        }
        .poll-container {
            margin-top: 8px;
            background: rgba(255, 255, 255, 0.8);
            padding: 12px;
            border-radius: 12px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .poll-question {
            font-weight: bold;
            font-size: 1.1em;
            margin-bottom: 8px;
        }
        .poll-option-button {
            width: 100%;
            background: #e0e0e0;
            color: #333;
            padding: 8px;
            border-radius: 8px;
            margin-bottom: 4px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            transition: background-color 0.2s;
            border: none;
        }
        .poll-option-button:hover {
            background: #d4d4d4;
        }
        .poll-option-button.voted-option {
            background: #d1e7dd;
        }
        .poll-option-button:disabled {
            cursor: not-allowed;
            background: #e9ecef;
        }
        .poll-option-bar-container {
            flex-grow: 1;
            height: 10px;
            background: #c2e0ff;
            border-radius: 5px;
            margin-right: 8px;
            position: relative;
        }
        .poll-option-bar {
            height: 100%;
            background: var(--primary-color);
            border-radius: 5px;
            transition: width 0.3s ease;
        }
        .poll-option-text {
            font-weight: 500;
        }
        .poll-option-count {
            font-weight: bold;
        }
        .poll-winner-message {
            margin-top: 8px;
            font-weight: bold;
            text-align: center;
            color: var(--primary-color);
        }
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1001;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }
        .modal-overlay.open {
            opacity: 1;
            pointer-events: auto;
        }
        .modal {
            background: var(--background-color);
            color: var(--text-color);
            padding: 24px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            max-width: 90%;
            width: 400px;
            transform: translateY(-20px);
            transition: transform 0.3s ease, opacity 0.3s ease;
        }
        .modal-overlay.open .modal {
            transform: translateY(0);
        }
        .modal-header {
            font-size: 1.5rem;
            font-weight: bold;
            margin-bottom: 16px;
            color: var(--primary-color);
        }
        .modal-input {
            width: 100%;
            padding: 12px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            margin-bottom: 16px;
            outline: none;
            font-size: var(--text-size);
            background: var(--background-color);
            color: var(--text-color);
        }
        .modal-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 12px;
        }
        .modal-button {
            padding: 10px 20px;
            border-radius: 20px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .modal-button.cancel {
            background: #e5e7eb;
            color: #4b5563;
        }
        .modal-button.create {
            background: var(--primary-color);
            color: #ffffff;
        }
        .modal-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }
        #qr-scanner-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1002;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        #qr-scanner-container.open {
            display: flex;
        }
        .camera-preview-box {
            position: relative;
            width: 100%;
            max-width: 500px;
            height: 0;
            padding-bottom: 75%; /* 4:3 Aspect Ratio */
            background: black;
        }
        #qr-scanner-video {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            transform: scaleX(-1);
            object-fit: cover;
        }
        #interactive-camera-content {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            pointer-events: none;
        }
        #qr-scanner-result {
            color: #fff;
            margin-top: 20px;
            font-size: 1.2rem;
            text-align: center;
        }
        #qr-camera-buttons {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 20px;
        }
        .qr-camera-button {
            background: var(--primary-color);
            color: #fff;
            border: none;
            padding: 10px 20px;
            border-radius: 20px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .qr-camera-button:hover {
            background: var(--secondary-color);
            color: var(--primary-color);
        }
        .paste-button {
            position: absolute;
            bottom: 60px;
            left: 16px;
            background: var(--primary-color);
            color: #ffffff;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            z-index: 9;
            opacity: 0;
            transform: scale(0);
        }
        .paste-button.visible {
            opacity: 1;
            transform: scale(1);
        }
    </style>
</head>
<body>
    <div class="loading-screen" id="loading-screen">
        <img src="https://i.postimg.cc/Ssk9kkHb/1757343420124.png" alt="GPV Logo" class="loading-logo" />
        <p class="loading-text">Iniciando GVC CHAT...</p>
    </div>
    <div id="root"></div>

    <div id="qr-scanner-container">
        <div class="modal w-full h-full flex flex-col justify-center items-center">
            <h2 class="modal-header">Câmera</h2>
            <div class="camera-preview-box w-full max-w-sm relative">
                <video id="qr-scanner-video" playsinline muted></video>
                <div id="interactive-camera-content"></div>
            </div>
            <div id="qr-camera-buttons" class="mt-4 flex flex-row gap-4">
                <button id="photo-button" class="qr-camera-button"><i class="fas fa-camera-retro mr-2"></i>Tirar Foto</button>
                <button id="qr-button" class="qr-camera-button"><i class="fas fa-qrcode mr-2"></i>Ler QR Code</button>
                <button id="switch-camera-button" class="qr-camera-button"><i class="fas fa-sync-alt mr-2"></i>Trocar Câmera</button>
            </div>
            <div class="modal-buttons mt-4">
                <button id="close-qr-scanner" class="modal-button cancel">Cancelar</button>
            </div>
        </div>
    </div>
    <script type="text/babel">
        const ErrorMessage = ({ message, onClose }) => {
            if (!message) return null;
            return (
                <div className="error-message" onClick={onClose}>
                    <i className="fas fa-exclamation-triangle mr-2"></i>
                    {message}
                </div>
            );
        };
        const AudioPlayer = ({ src }) => {
            const audioRef = React.useRef(null);
            const [isPlaying, setIsPlaying] = React.useState(false);
            const [progress, setProgress] = React.useState(0);
            const togglePlay = () => {
                if (isPlaying) {
                    audioRef.current.pause();
                } else {
                    audioRef.current.play();
                }
                setIsPlaying(!isPlaying);
            };
            const handleTimeUpdate = () => {
                const current = audioRef.current.currentTime;
                const duration = audioRef.current.duration;
                setProgress((current / duration) * 100);
            };
            const handleSeek = (e) => {
                const seekTime = (e.target.value / 100) * audioRef.current.duration;
                audioRef.current.currentTime = seekTime;
                setProgress(e.target.value);
            };
            return (
                <div className="message-audio">
                    <button onClick={togglePlay} className="control-button">
                        <i className={`fas ${isPlaying ? 'fa-pause' : 'fa-play'}`}></i>
                    </button>
                    <div className="waveform">
                        {Array.from({ length: 10 }).map((_, i) => (
                            <div key={i} className="wave-bar" style={{ height: `${10 + Math.random() * 10}px` }}></div>
                        ))}
                    </div>
                    <input type="range" value={progress} onChange={handleSeek} min="0" max="100" className="w-full h-1 bg-gray-200 rounded-lg" />
                    <audio ref={audioRef} src={src} onTimeUpdate={handleTimeUpdate} onEnded={() => setIsPlaying(false)} />
                </div>
            );
        };
        const PollComponent = ({ id, question, options, votes, onVote }) => {
            const [voted, setVoted] = React.useState(false);
            const [votedOption, setVotedOption] = React.useState(null);
            const votesMap = votes ? votes : {};
            const totalVotes = Object.values(votesMap).reduce((sum, count) => sum + count, 0);
            
            React.useEffect(() => {
                const hasVoted = localStorage.getItem(`poll_${id}_voted`);
                if (hasVoted) {
                    setVoted(true);
                    setVotedOption(localStorage.getItem(`poll_${id}_voted_option`));
                }
            }, [id]);
            
            const handleVote = (option) => {
                if (!voted) {
                    localStorage.setItem(`poll_${id}_voted`, 'true');
                    localStorage.setItem(`poll_${id}_voted_option`, option);
                    setVoted(true);
                    setVotedOption(option);
                    onVote(id, option);
                }
            };
            
            const findWinner = () => {
                if (totalVotes === 0) return null;
                const sortedOptions = options.map(option => ({
                    option,
                    count: votesMap[option] || 0
                })).sort((a, b) => b.count - a.count);
                const winner = sortedOptions[0];
                const winners = sortedOptions.filter(opt => opt.count === winner.count);
                if (winners.length > 1) {
                    return `Empate entre: ${winners.map(w => w.option).join(' e ')}`;
                }
                return `${winner.option} está ganhando com ${winner.count} votos!`;
            };

            return (
                <div className="poll-container">
                    <p className="poll-question">{question}</p>
                    {options.map((option, index) => {
                        const count = votesMap[option] || 0;
                        const percent = totalVotes > 0 ? (count / totalVotes) * 100 : 0;
                        const isVotedOption = voted && votedOption === option;
                        return (
                            <div key={index} className="mb-2">
                                <button
                                    className={`poll-option-button ${isVotedOption ? 'voted-option' : ''}`}
                                    onClick={() => handleVote(option)}
                                    disabled={voted}
                                >
                                    <span className="poll-option-text">{option}</span>
                                </button>
                                <div className="flex items-center gap-2 mt-1">
                                    <div className="poll-option-bar-container">
                                        <div className="poll-option-bar" style={{ width: `${percent}%` }}></div>
                                    </div>
                                    <span className="poll-option-count">{count}</span>
                                </div>
                            </div>
                        );
                    })}
                    {voted && totalVotes > 0 && (
                        <p className="poll-winner-message">{findWinner()}</p>
                    )}
                </div>
            );
        };
        const ChatMessage = ({ id, Usuario, DIGIOTOU, DATAENVIO, FOTOPERFIL, isRight, mensacao, laughs, sads, ArquivosGravados, quotedMsg, EnqueteArmazenamento, citacao, onLike, onLaugh, onSad, onQuote, onImageClick, onDelete, onVote, onCopyText }) => {
            const [isAnimating, setIsAnimating] = React.useState(false);
            const [hearts, setHearts] = React.useState([]);
            const formatDate = (dateString) => {
                const date = new Date(dateString);
                return date.toLocaleString('pt-BR', { hour: '2-digit', minute: '2-digit' });
            };
            const handleLike = () => {
                if (!isAnimating) {
                    setIsAnimating(true);
                    const newHearts = Array.from({ length: 10 }, (_, i) => ({
                        id: i,
                        left: `${Math.random() * 100}%`,
                        animationDelay: `${Math.random() * 0.5}s`
                    }));
                    setHearts(newHearts);
                    onLike(id, mensacao);
                    setTimeout(() => {
                        setIsAnimating(false);
                        setHearts([]);
                    }, 1000);
                }
            };
            const handleLaugh = () => { onLaugh(id, laughs); };
            const handleSad = () => { onSad(id, sads); };
            const handleQuote = () => { onQuote({ id, Usuario, DIGIOTOU, DATAENVIO, FOTOPERFIL, mensacao, laughs, sads, ArquivosGravados }); };
            const handleDelete = async () => {
                const password = prompt('Tem certeza que deseja apagar esta mensagem para todos?');
                if (password === 'admincordeiro') {
                    onDelete(id);
                } else {
                    console.error('Senha incorreta!');
                }
            };
            const isImage = Array.isArray(ArquivosGravados) && ArquivosGravados.length > 0 && ArquivosGravados[0].is_image;
            const isVideo = Array.isArray(ArquivosGravados) && ArquivosGravados.length > 0 && ArquivosGravados[0].mime_type.startsWith('video/');
            const isAudio = Array.isArray(ArquivosGravados) && ArquivosGravados.length > 0 && ArquivosGravados[0].mime_type.startsWith('audio/');
            const isPoll = EnqueteArmazenamento;
            let pollData = null;
            if (isPoll) {
                try {
                    pollData = JSON.parse(EnqueteArmazenamento);
                } catch (e) {
                    console.error("Failed to parse poll data:", e);
                    isPoll = false;
                }
            }
            const cleanMessage = DIGIOTOU ? DIGIOTOU.replace(/[\r\n]+/g, ' ').trim() : '';
            const parts = cleanMessage.split(/(@\w+)/g);
            const renderedMessage = parts.map((part, index) => {
                if (part.startsWith('@')) {
                    return <span key={index} className="mention">{part}</span>;
                }
                return part;
            });
            const likeCount = parseInt(mensacao || '0', 10);
            const laughCount = parseInt(laughs || '0', 10);
            const sadCount = parseInt(sads || '0', 10);
            const userDisplay = Usuario && Usuario !== 'string' ? Usuario : 'Anônimo';
            return (
                <div className={`flex ${isRight ? 'justify-end' : 'justify-start'} mb-4 message message-${isRight ? 'right' : 'left'}`}>
                    <div className={`flex ${isRight ? 'flex-row-reverse' : 'flex-row'} items-start w-full`}>
                        <img src={FOTOPERFIL || 'https://i.postimg.cc/Ssk9kkHb/1757343420124.png'} alt="Profile" className="w-10 h-10 rounded-full object-cover mt-2" />
                        <div className="flex flex-col mx-2 w-full relative">
                            <div className={`message-bubble ${isAnimating ? 'radiate' : ''}`} onDoubleClick={() => onCopyText(DIGIOTOU)}>
                                <span className="text-xs font-semibold" style={{ color: isRight ? 'var(--primary-color)' : '#ffffff' }}>{userDisplay}</span>
                                {quotedMsg && (
                                    <div className="quoted-message">
                                        <span className="quoted-user">{quotedMsg.Usuario}</span>
                                        <p className="quoted-text">{quotedMsg.DIGIOTOU}</p>
                                    </div>
                                )}
                                {citacao && <p className="quoted-text">{citacao}</p>}
                                {isPoll && pollData ? (
                                    <PollComponent id={id} question={pollData.question} options={pollData.options} votes={pollData.votes} onVote={onVote} />
                                ) : isImage ? (
                                    <img src={ArquivosGravados[0].url} alt="Message" className="message-image" onClick={() => onImageClick(ArquivosGravados[0].url)} />
                                ) : isVideo ? (
                                    <video src={ArquivosGravados[0].url} controls className="message-image" />
                                ) : isAudio ? (
                                    <AudioPlayer src={ArquivosGravados[0].url} />
                                ) : (
                                    DIGIOTOU && <p className="text-sm leading-relaxed mt-1">{renderedMessage}</p>
                                )}
                                <div className="flex items-center justify-end mt-1">
                                    <span className="text-xs text-gray-500">{formatDate(DATAENVIO)}</span>
                                    {isRight && <i className="fas fa-check text-xs text-gray-500 ml-1"></i>}
                                </div>
                            </div>
                            <div className="heart-rain">
                                {hearts.map(heart => (
                                    <i key={heart.id} className="fas fa-heart heart" style={{ left: heart.left, animationDelay: heart.animationDelay }}></i>
                                ))}
                            </div>
                            <div className="flex gap-2">
                                {!isRight && (
                                    <div className="like-button" onClick={handleLike}>
                                        <i className="fas fa-heart"></i>
                                        <span>{likeCount}</span>
                                    </div>
                                )}
                                {!isRight && (
                                    <div className="laugh-button" onClick={handleLaugh}>
                                        <i className="fas fa-laugh"></i>
                                        <span>{laughCount}</span>
                                    </div>
                                )}
                                {!isRight && (
                                    <div className="sad-button" onClick={handleSad}>
                                        <i className="fas fa-sad-tear"></i>
                                        <span>{sadCount}</span>
                                    </div>
                                )}
                                {!isRight && (
                                    <div className="quote-button" onClick={handleQuote}>
                                        <i className="fas fa-reply"></i>
                                    </div>
                                )}
                                <div className="delete-button" onClick={handleDelete}>
                                    <i className="fas fa-trash"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };
        const FullscreenImage = ({ src, onClose }) => {
            return (
                <div className="fullscreen-image" onClick={onClose}>
                    <img src={src} alt="Fullscreen" />
                    <button className="close-button" onClick={onClose}>
                        <i className="fas fa-times"></i>
                    </button>
                </div>
            );
        };
        const RecordingAnimation = ({ duration }) => {
            return (
                <div className="recording-animation">
                    <i className="fas fa-microphone recording-icon"></i>
                    <div className="recording-wave">
                        <div className="recording-wave-bar"></div>
                        <div className="recording-wave-bar"></div>
                        <div className="recording-wave-bar"></div>
                        <div className="recording-wave-bar"></div>
                        <div className="recording-wave-bar"></div>
                    </div>
                    <span className="text-xs font-semibold" style={{ color: 'var(--primary-color)' }}>
                        Gravando... {duration}s
                    </span>
                </div>
            );
        };
        const ProgressBar = ({ progress }) => {
            return (
                <div className="progress-bar-container">
                    <div className="progress-bar">
                        <div className="progress-bar-fill" style={{ width: `${progress}%` }}></div>
                    </div>
                    <div className="progress-text">Enviando: {Math.round(progress)}%</div>
                </div>
            );
        };
        const ParticlesBackground = () => {
            const particles = Array.from({ length: 50 }).map((_, i) => (
                <div
                    key={i}
                    className="particle"
                    style={{
                        width: `${Math.random() * 5 + 2}px`,
                        height: `${Math.random() * 5 + 2}px`,
                        left: `${Math.random() * 100}%`,
                        top: `${Math.random() * 100}%`,
                        '--x': `${(Math.random() - 0.5) * 200}px`,
                        '--y': `${(Math.random() - 0.5) * 200}px`,
                        animationDelay: `${Math.random() * 20}s`,
                        animationDuration: `${Math.random() * 15 + 10}s`
                    }}
                ></div>
            ));
            return <div className="particles-background">{particles}</div>;
        };
        const TypingIndicator = ({ user, avatar }) => {
            return (
                <div className="typing-indicator">
                    <img src={avatar || 'https://i.postimg.cc/Ssk9kkHb/1757343420124.png'} alt="Avatar" className="typing-avatar" />
                    <span className="typing-text">{user} está digitando</span>
                    <div className="flex gap-1">
                        <div className="dot"></div>
                        <div className="dot"></div>
                        <div className="dot"></div>
                    </div>
                </div>
            );
        };
        const ChatApp = () => {
            const [messages, setMessages] = React.useState([]);
            const [typingUser, setTypingUser] = React.useState(null);
            const [typingUserData, setTypingUserData] = React.useState(null);
            const [isLoading, setIsLoading] = React.useState(true);
            const [fullscreenImage, setFullscreenImage] = React.useState(null);
            const [inputText, setInputText] = React.useState('');
            const [isRecording, setIsRecording] = React.useState(false);
            const [userData, setUserData] = React.useState(null);
            const [currentUserId, setCurrentUserId] = React.useState(null);
            const [mediaRecorder, setMediaRecorder] = React.useState(null);
            const [theme, setTheme] = React.useState('light');
            const [fontSize, setFontSize] = React.useState('medium');
            const [showThemeMenu, setShowThemeMenu] = React.useState(false);
            const [showFontMenu, setShowFontMenu] = React.useState(false);
            const [uploadProgress, setUploadProgress] = React.useState(null);
            const [fabOpen, setFabOpen] = React.useState(false);
            const [recordingDuration, setRecordingDuration] = React.useState(0);
            const [quotedMessage, setQuotedMessage] = React.useState(null);
            const [chatError, setChatError] = React.useState(null);
            const [showPollModal, setShowPollModal] = React.useState(false);
            const [pollQuestion, setPollQuestion] = React.useState('');
            const [pollOptions, setPollOptions] = React.useState(['', '']);
            const [copiedText, setCopiedText] = React.useState('');
            const [showPasteButton, setShowPasteButton] = React.useState(false);
            const messagesEndRef = React.useRef(null);
            const currentUser = userData?.Usuario || "Usuário";
            const defaultProfilePic = 'https://i.postimg.cc/Ssk9kkHb/1757343420124.png';
            const apiToken = 'UkqZsuMMnwE59fMqs8OwXX60SASP7FOd';

            const mockMessages = [{ id: 1, Usuario: "Usuário Mock", DIGIOTOU: "Bem-vindo ao GPV Chat!", DATAENVIO: new Date().toISOString(), FOTOPERFIL: defaultProfilePic, mensacao: '0', laughs: '0', sads: '0', ArquivosGravados: [], EnqueteArmazenamento: null, citacao: null }];
            const mockUserData = { Usuario: "Usuário", FOTOPERFIL: defaultProfilePic };
            const mockTypingUser = { DigitandoUser: "Usuário Mock", PERFIL: defaultProfilePic };

            React.useEffect(() => {
                document.body.setAttribute('data-theme', theme);
                document.body.className = `text-${fontSize}`;
            }, [theme, fontSize]);
            
            React.useEffect(() => {
                if (chatError) {
                    const timer = setTimeout(() => {
                        setChatError(null);
                    }, 5000);
                    return () => clearTimeout(timer);
                }
            }, [chatError]);

            const updateTypingStatus = async (isTyping) => {
                if (!currentUserId) return;
                try {
                    await axios({
                        method: 'PATCH',
                        url: `https://api.baserow.io/api/database/rows/table/314649/${currentUserId}/?user_field_names=true`,
                        headers: { Authorization: `Token ${apiToken}` },
                        data: { digitandotruefalse: isTyping ? 'true' : 'false', DigitandoUser: currentUser }
                    });
                } catch (error) {
                    setChatError('Falha ao atualizar status de digitação.');
                }
            };
            const fetchUserData = async () => {
                try {
                    const response = await axios({
                        method: 'GET',
                        url: 'https://api.baserow.io/api/database/rows/table/221009/?user_field_names=true',
                        headers: { Authorization: `Token ${apiToken}` }
                    });
                    const activeUserRow = response.data.results.find(row => row.ultimoclick && row.ultimoclick.trim() !== '');
                    if (activeUserRow) {
                        setCurrentUserId(activeUserRow.id);
                        setUserData({ Usuario: activeUserRow.NOME, FOTOPERFIL: activeUserRow.PERFIL });
                        await axios({
                            method: 'PATCH',
                            url: `https://api.baserow.io/api/database/rows/table/221009/${activeUserRow.id}/?user_field_names=true`,
                            headers: { Authorization: `Token ${apiToken}` },
                            data: { ultimoclick: '' }
                        });
                    } else {
                        console.log('Nenhum usuário ativo encontrado. Usando dados mock.');
                        setCurrentUserId(340);
                        setUserData(mockUserData);
                    }
                } catch (error) {
                    setChatError('Falha ao carregar dados do usuário. Recarregue a página.');
                    setCurrentUserId(340);
                    setUserData(mockUserData);
                }
            };
            const fetchMessages = async () => {
                try {
                    const response = await axios({
                        method: 'GET',
                        url: 'https://api.baserow.io/api/database/rows/table/459281/?user_field_names=true',
                        headers: { Authorization: `Token ${apiToken}` }
                    });
                    const results = response.data.results;
                    const processedMessages = results.map(msg => {
                        if (msg.QuotedId) {
                            const quotedId = parseInt(msg.QuotedId, 10);
                            const quotedMsg = results.find(m => m.id === quotedId);
                            return { ...msg, quotedMsg };
                        }
                        return msg;
                    });
                    setMessages(processedMessages);
                } catch (error) {
                    setChatError('Falha ao carregar mensagens. Tente novamente mais tarde.');
                    setMessages(mockMessages);
                }
            };
            const fetchTypingStatus = async () => {
                try {
                    const response = await axios({
                        method: 'GET',
                        url: 'https://api.baserow.io/api/database/rows/table/314649/?user_field_names=true',
                        headers: { Authorization: `Token ${apiToken}` }
                    });
                    const typingData = response.data.results.find(user => user.digitandotruefalse === 'true' && user.DigitandoUser !== currentUser);
                    if (typingData) {
                        setTypingUser(typingData.DigitandoUser);
                        const userResponse = await axios({
                            method: 'GET',
                            url: `https://api.baserow.io/api/database/rows/table/221009/?user_field_names=true`,
                            headers: { Authorization: `Token ${apiToken}` }
                        });
                        const userData = userResponse.data.results.find(user => user.NOME === typingData.DigitandoUser);
                        setTypingUserData(userData || mockTypingUser);
                    } else {
                        setTypingUser(null);
                        setTypingUserData(null);
                    }
                } catch (error) {
                    setChatError('Falha ao verificar status de digitação.');
                    setTypingUser(null);
                    setTypingUserData(null);
                }
            };
            const likeMessage = async (id, currentLikes) => {
                try {
                    const newCount = parseInt(currentLikes || '0', 10) + 1;
                    await axios({
                        method: 'PATCH',
                        url: `https://api.baserow.io/api/database/rows/table/459281/${id}/?user_field_names=true`,
                        data: { mensacao: newCount.toString() },
                        headers: { Authorization: `Token ${apiToken}` }
                    });
                    fetchMessages();
                } catch (error) {
                    setChatError('Não foi possível curtir a mensagem.');
                }
            };
            const laughMessage = async (id, currentLaughs) => {
                try {
                    const newCount = parseInt(currentLaughs || '0', 10) + 1;
                    await axios({
                        method: 'PATCH',
                        url: `https://api.baserow.io/api/database/rows/table/459281/${id}/?user_field_names=true`,
                        data: { laughs: newCount.toString() },
                        headers: { Authorization: `Token ${apiToken}` }
                    });
                    fetchMessages();
                } catch (error) {
                    setChatError('Não foi possível reagir com riso.');
                }
            };
            const sadMessage = async (id, currentSads) => {
                try {
                    const newCount = parseInt(currentSads || '0', 10) + 1;
                    await axios({
                        method: 'PATCH',
                        url: `https://api.baserow.io/api/database/rows/table/459281/${id}/?user_field_names=true`,
                        data: { sads: newCount.toString() },
                        headers: { Authorization: `Token ${apiToken}` }
                    });
                    fetchMessages();
                } catch (error) {
                    setChatError('Não foi possível reagir com tristeza.');
                }
            };
            const votePoll = async (id, option) => {
                try {
                    const response = await axios({
                        method: 'GET',
                        url: `https://api.baserow.io/api/database/rows/table/459281/${id}/?user_field_names=true`,
                        headers: { Authorization: `Token ${apiToken}` }
                    });
                    const currentPoll = response.data.EnqueteArmazenamento ? JSON.parse(response.data.EnqueteArmazenamento) : { votes: {} };
                    const newVotes = { ...currentPoll.votes };
                    newVotes[option] = (newVotes[option] || 0) + 1;
                    await axios({
                        method: 'PATCH',
                        url: `https://api.baserow.io/api/database/rows/table/459281/${id}/?user_field_names=true`,
                        data: { EnqueteArmazenamento: JSON.stringify({ ...currentPoll, votes: newVotes }) },
                        headers: { Authorization: `Token ${apiToken}` }
                    });
                    fetchMessages();
                } catch (error) {
                    setChatError('Não foi possível votar na enquete.');
                }
            };
            const deleteMessage = async (id) => {
                try {
                    await axios({
                        method: 'DELETE',
                        url: `https://api.baserow.io/api/database/rows/table/459281/${id}/`,
                        headers: { Authorization: `Token ${apiToken}` }
                    });
                    fetchMessages();
                } catch (error) {
                    setChatError('Falha ao apagar mensagem.');
                }
            };
            const deleteAllMessages = async () => {
                const password = prompt('Digite a senha para apagar todas as mensagens:');
                if (password === 'admincordeiro') {
                    try {
                        for (const msg of messages) {
                            await axios({
                                method: 'DELETE',
                                url: `https://api.baserow.io/api/database/rows/table/459281/${msg.id}/`,
                                headers: { Authorization: `Token ${apiToken}` }
                            });
                        }
                        fetchMessages();
                    } catch (error) {
                        setChatError('Falha ao apagar todas as mensagens.');
                    }
                } else {
                    setChatError('Senha incorreta para apagar mensagens.');
                }
            };
            const addPollOption = () => {
                setPollOptions([...pollOptions, '']);
            };
            const removePollOption = (index) => {
                const newOptions = [...pollOptions];
                newOptions.splice(index, 1);
                setPollOptions(newOptions);
            };
            const handlePollOptionChange = (index, value) => {
                const newOptions = [...pollOptions];
                newOptions[index] = value;
                setPollOptions(newOptions);
            };
            const handleCreatePoll = async () => {
                if (pollQuestion && pollOptions.every(opt => opt.trim())) {
                    await handleSendMessage({ isPoll: true, question: pollQuestion, options: pollOptions });
                    setPollQuestion('');
                    setPollOptions(['', '']);
                    setShowPollModal(false);
                } else {
                    alert('Por favor, preencha a pergunta e todas as opções.');
                }
            };
            const uploadFile = async (file, fileName) => {
                try {
                    const formData = new FormData();
                    formData.append('file', file, fileName);
                    const response = await axios({
                        method: 'POST',
                        url: 'https://api.baserow.io/api/user-files/upload-file/',
                        headers: { Authorization: `Token ${apiToken}`, 'Content-Type': 'multipart/form-data' },
                        data: formData,
                        onUploadProgress: (progressEvent) => {
                            const percentCompleted = Math.round((progressEvent.loaded * 100) / progressEvent.total);
                            setUploadProgress(percentCompleted);
                        }
                    });
                    setUploadProgress(null);
                    return response.data;
                } catch (error) {
                    setChatError('Erro ao fazer upload do arquivo. O arquivo pode ser muito grande ou o servidor está fora do ar.');
                    setUploadProgress(null);
                    return null;
                }
            };
            const handleSendMessage = async (fileData = null) => {
                if (inputText.trim() || fileData) {
                    try {
                        const data = {
                            Usuario: currentUser,
                            DIGIOTOU: inputText || (fileData && !fileData.isAudio && !fileData.isPoll ? fileData.url : ''),
                            DATAENVIO: new Date().toISOString(),
                            FOTOPERFIL: userData?.FOTOPERFIL || defaultProfilePic,
                            mensacao: '0'
                        };
                        if (quotedMessage) { data.QuotedId = quotedMessage.id.toString(); }
                        if (fileData && fileData.isAudio) { data.ArquivosGravados = [{ url: fileData.url, name: fileData.name, mime_type: "audio/webm" }]; }
                        if (fileData && fileData.isImage) { data.ArquivosGravados = [{ url: fileData.url, name: fileData.name, is_image: true }]; }
                        if (fileData && fileData.isVideo) { data.ArquivosGravados = [{ url: fileData.url, name: fileData.name, mime_type: "video/mp4" }]; }
                        if (fileData && fileData.isPoll) { data.DIGIOTOU = fileData.question; data.EnqueteArmazenamento = JSON.stringify({ question: fileData.question, options: fileData.options, votes: {} }); }
                        await axios({
                            method: 'POST',
                            url: 'https://api.baserow.io/api/database/rows/table/459281/?user_field_names=true',
                            data,
                            headers: { Authorization: `Token ${apiToken}` }
                        });
                        setInputText('');
                        setQuotedMessage(null);
                        await fetchMessages();
                        messagesEndRef.current?.scrollIntoView({ behavior: "smooth" });
                    } catch (error) {
                        setChatError('Falha ao enviar a mensagem. Verifique sua conexão e tente novamente.');
                        setInputText('');
                        setQuotedMessage(null);
                    }
                }
            };
            const handleImageClick = (src) => { setFullscreenImage(src); };
            const closeFullscreenImage = () => { setFullscreenImage(null); };
            const handleRecordAudio = async () => {
                if (isRecording) {
                    if (mediaRecorder) { mediaRecorder.stop(); }
                    setFabOpen(false);
                    return;
                }
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    const recorder = new MediaRecorder(stream);
                    const audioChunks = [];
                    const startTime = Date.now();
                    const durationInterval = setInterval(() => { setRecordingDuration(Math.floor((Date.now() - startTime) / 1000)); }, 1000);
                    recorder.ondataavailable = (event) => { audioChunks.push(event.data); };
                    recorder.onstop = async () => {
                        clearInterval(durationInterval);
                        setRecordingDuration(0);
                        const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                        const audioFile = await uploadFile(audioBlob, `audio_${Date.now()}.webm`);
                        if (audioFile) { await handleSendMessage({ ...audioFile, isAudio: true }); }
                        stream.getTracks().forEach(track => track.stop());
                        setIsRecording(false);
                        setMediaRecorder(null);
                    };
                    recorder.onerror = (error) => {
                        clearInterval(durationInterval);
                        setRecordingDuration(0);
                        setChatError('Erro na gravação de áudio. Verifique as permissões do microfone.');
                        stream.getTracks().forEach(track => track.stop());
                        setIsRecording(false);
                        setMediaRecorder(null);
                    };
                    recorder.start();
                    setMediaRecorder(recorder);
                    setIsRecording(true);
                    setFabOpen(false);
                } catch (error) {
                    setChatError('Não foi possível acessar o microfone. Verifique as permissões.');
                    setIsRecording(false);
                }
            };
            const handleCopyText = (text) => {
                setCopiedText(text);
                setShowPasteButton(true);
                setTimeout(() => {
                    setShowPasteButton(false);
                }, 5000);
            };
            const handlePasteText = () => {
                setInputText(copiedText);
                setShowPasteButton(false);
                setCopiedText('');
            };
            
            // Camera and QR Code functions
            const [isCameraOpen, setIsCameraOpen] = React.useState(false);
            const [cameraFacingMode, setCameraFacingMode] = React.useState('environment');
            const videoRef = React.useRef(null);
            
            const openCamera = async () => {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({
                        video: { facingMode: cameraFacingMode },
                        audio: false
                    });
                    videoRef.current.srcObject = stream;
                    videoRef.current.play();
                    setIsCameraOpen(true);
                } catch (error) {
                    setChatError('Falha ao acessar a câmera. Verifique as permissões.');
                }
            };

            const closeCamera = () => {
                const stream = videoRef.current.srcObject;
                const tracks = stream.getTracks();
                tracks.forEach(track => track.stop());
                setIsCameraOpen(false);
                Quagga.stop();
            };

            const switchCamera = () => {
                closeCamera();
                const newFacingMode = cameraFacingMode === 'user' ? 'environment' : 'user';
                setCameraFacingMode(newFacingMode);
                openCamera();
            };

            const takePhoto = () => {
                const canvas = document.createElement('canvas');
                canvas.width = videoRef.current.videoWidth;
                canvas.height = videoRef.current.videoHeight;
                const context = canvas.getContext('2d');
                context.drawImage(videoRef.current, 0, 0, canvas.width, canvas.height);
                canvas.toBlob(async (blob) => {
                    const file = new File([blob], `photo_${Date.now()}.png`, { type: 'image/png' });
                    const fileData = await uploadFile(file, file.name);
                    if (fileData) { await handleSendMessage({ ...fileData, isImage: true }); }
                    closeCamera();
                }, 'image/png');
            };

            const startQrScanner = () => {
                Quagga.init({
                    inputStream: {
                        name: "Live",
                        type: "LiveStream",
                        target: videoRef.current,
                        constraints: {
                            facingMode: cameraFacingMode
                        }
                    },
                    decoder: {
                        readers: ["qrcode_reader"]
                    }
                }, function (err) {
                    if (err) {
                        setChatError('Erro ao iniciar o leitor de QR Code.');
                        return;
                    }
                    Quagga.start();
                });
                Quagga.onDetected(function(result) {
                    if (result.codeResult) {
                        const qrCodeValue = result.codeResult.code;
                        setInputText(qrCodeValue);
                        closeCamera();
                    }
                });
            };
            React.useEffect(() => {
                if (isCameraOpen) {
                    openCamera();
                }
            }, [isCameraOpen, cameraFacingMode]);
            
            React.useEffect(() => {
                const qrContainer = document.getElementById('qr-scanner-container');
                const closeButton = document.getElementById('close-qr-scanner');
                const videoElement = document.getElementById('qr-scanner-video');
                const photoButton = document.getElementById('photo-button');
                const qrButton = document.getElementById('qr-button');
                const switchButton = document.getElementById('switch-camera-button');

                videoRef.current = videoElement;

                if (isCameraOpen) {
                    qrContainer.classList.add('open');
                } else {
                    qrContainer.classList.remove('open');
                }

                closeButton.onclick = closeCamera;
                photoButton.onclick = takePhoto;
                qrButton.onclick = startQrScanner;
                switchButton.onclick = switchCamera;

                return () => {
                    closeButton.onclick = null;
                    photoButton.onclick = null;
                    qrButton.onclick = null;
                    switchButton.onclick = null;
                };
            }, [isCameraOpen, cameraFacingMode, takePhoto, startQrScanner, switchCamera]);
            
            const handleUploadPhoto = () => {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = 'image/*';
                input.onchange = async (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        try {
                            const fileData = await uploadFile(file, file.name);
                            if (fileData) { await handleSendMessage({ ...fileData, isImage: true }); }
                        } catch (error) {
                            setChatError('Falha ao enviar a foto. Tente novamente.');
                        }
                    }
                };
                input.click();
                setFabOpen(false);
            };
            const handleUploadAudio = () => {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = 'audio/*';
                input.onchange = async (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        try {
                            const fileData = await uploadFile(file, file.name);
                            if (fileData) { await handleSendMessage({ ...fileData, isAudio: true }); }
                        } catch (error) {
                            setChatError('Falha ao enviar o áudio. Tente novamente.');
                        }
                    }
                };
                input.click();
                setFabOpen(false);
            };
            const handleUploadVideo = () => {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = 'video/*';
                input.onchange = async (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        try {
                            const fileData = await uploadFile(file, file.name);
                            if (fileData) { await handleSendMessage({ ...fileData, isVideo: true }); }
                        } catch (error) {
                            setChatError('Falha ao enviar o vídeo. Tente novamente.');
                        }
                    }
                };
                input.click();
                setFabOpen(false);
            };
            const handleKeyPress = (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    handleSendMessage();
                    setFabOpen(false);
                }
            };
            const handleInputChange = (e) => {
                setInputText(e.target.value);
                updateTypingStatus(e.target.value.length > 0);
            };
            const toggleFab = () => { setFabOpen(!fabOpen); setShowThemeMenu(false); setShowFontMenu(false); };
            const toggleThemeMenu = () => { setShowThemeMenu(!showThemeMenu); setShowFontMenu(false); };
            const toggleFontMenu = () => { setShowFontMenu(!showFontMenu); setShowThemeMenu(false); };
            const changeTheme = (newTheme) => { setTheme(newTheme); setShowThemeMenu(false); setFabOpen(false); };
            const changeFontSize = (newSize) => { setFontSize(newSize); setShowFontMenu(false); setFabOpen(false); };
            const openPollModal = () => { setFabOpen(false); setShowPollModal(true); };
            const closePollModal = () => { setShowPollModal(false); setPollQuestion(''); setPollOptions(['', '']); };

            React.useEffect(() => {
                const initializeApp = async () => {
                    try {
                        await fetchUserData();
                        await fetchMessages();
                        await fetchTypingStatus();
                    } catch (error) {
                        setChatError('Falha na inicialização do chat. Recarregue a página.');
                    } finally {
                        setTimeout(() => {
                            setIsLoading(false);
                            const loadingScreen = document.getElementById('loading-screen');
                            if (loadingScreen) { loadingScreen.classList.add('hidden'); }
                        }, 1000);
                    }
                };
                initializeApp();
                const messageInterval = setInterval(fetchMessages, 5000);
                const typingInterval = setInterval(fetchTypingStatus, 2000);
                return () => {
                    clearInterval(messageInterval);
                    clearInterval(typingInterval);
                    if (mediaRecorder) { mediaRecorder.stop(); }
                };
            }, [currentUserId]);

            React.useEffect(() => {
                const handleClickOutside = (event) => {
                    if (!event.target.closest('.fab-container') && !event.target.closest('.fab-sub-menu') && !event.target.closest('.modal')) {
                        setShowThemeMenu(false);
                        setShowFontMenu(false);
                        setFabOpen(false);
                    }
                };
                document.addEventListener('mousedown', handleClickOutside);
                return () => { document.removeEventListener('mousedown', handleClickOutside); };
            }, []);

            return (
                <div className="chat-container">
                    <ParticlesBackground />
                    <ErrorMessage message={chatError} onClose={() => setChatError(null)} />
                    <div className="chat-header"></div>
                    <div className="chat-messages">
                        {messages.map((msg) => (
                            <ChatMessage
                                key={msg.id}
                                id={msg.id}
                                Usuario={msg.Usuario}
                                DIGIOTOU={msg.DIGIOTOU}
                                DATAENVIO={msg.DATAENVIO}
                                FOTOPERFIL={msg.FOTOPERFIL}
                                isRight={msg.Usuario === currentUser}
                                mensacao={msg.mensacao}
                                laughs={msg.laughs}
                                sads={msg.sads}
                                ArquivosGravados={msg.ArquivosGravados}
                                quotedMsg={msg.quotedMsg}
                                EnqueteArmazenamento={msg.EnqueteArmazenamento}
                                citacao={msg.citacao}
                                onLike={likeMessage}
                                onLaugh={laughMessage}
                                onSad={sadMessage}
                                onQuote={setQuotedMessage}
                                onImageClick={handleImageClick}
                                onDelete={deleteMessage}
                                onVote={votePoll}
                                onCopyText={handleCopyText}
                            />
                        ))}
                        {typingUser && (<TypingIndicator user={typingUser} avatar={typingUserData?.PERFIL || defaultProfilePic} />)}
                        <div ref={messagesEndRef} />
                    </div>
                    <div className="chat-footer">
                        {isRecording && <RecordingAnimation duration={recordingDuration} />}
                        {uploadProgress !== null && <ProgressBar progress={uploadProgress} />}
                        {quotedMessage && (
                            <div className="quoted-preview">
                                <span>Citando {quotedMessage.Usuario}:</span>
                                <p>{quotedMessage.DIGIOTOU.substring(0, 50)}...</p>
                                <button onClick={() => setQuotedMessage(null)}>X</button>
                            </div>
                        )}
                        <div className="input-container relative">
                            <button className={`fab-action ${isRecording ? 'recording' : ''}`} onClick={handleRecordAudio} title={isRecording ? 'Parar gravação' : 'Gravar áudio'} disabled={isRecording && !mediaRecorder}>
                                <i className="fas fa-microphone"></i>
                            </button>
                            <button className="fab-action" onClick={() => setIsCameraOpen(true)} title="Abrir Câmera">
                                <i className="fas fa-camera"></i>
                            </button>
                            <div className="flex-grow relative">
                                <input
                                    type="text"
                                    className="chat-input pr-12"
                                    placeholder="Digite uma mensagem..."
                                    value={inputText}
                                    onChange={handleInputChange}
                                    onKeyPress={handleKeyPress}
                                />
                                <button
                                    className={`send-button absolute right-2 top-1/2 transform -translate-y-1/2 ${inputText.trim() ? 'visible' : ''}`}
                                    onClick={() => handleSendMessage()}
                                    disabled={!inputText.trim()}
                                    title="Enviar mensagem"
                                >
                                    <i className="fas fa-paper-plane"></i>
                                </button>
                            </div>
                            <button 
                                className={`paste-button ${showPasteButton ? 'visible' : ''}`} 
                                onClick={handlePasteText}
                                title="Colar texto copiado"
                            >
                                <i className="fas fa-paste"></i>
                            </button>
                            <div className="fab-container">
                                <button className={`fab-main ${fabOpen ? 'open' : ''}`} onClick={toggleFab} title="Mais opções">
                                    <i className="fas fa-plus"></i>
                                </button>
                                <div className={`fab-actions ${fabOpen ? 'open' : ''}`}>
                                    <button className="fab-action" onClick={handleUploadPhoto} title="Enviar foto">
                                        <i className="fas fa-image"></i>
                                    </button>
                                    <button className="fab-action" onClick={handleUploadAudio} title="Enviar áudio">
                                        <i className="fas fa-file-audio"></i>
                                    </button>
                                    <button className="fab-action" onClick={handleUploadVideo} title="Enviar vídeo">
                                        <i className="fas fa-video"></i>
                                    </button>
                                    <button className="fab-action" onClick={toggleThemeMenu} title="Alterar tema">
                                        <i className="fas fa-palette"></i>
                                    </button>
                                    <button className="fab-action" onClick={toggleFontMenu} title="Tamanho do texto">
                                        <i className="fas fa-text-height"></i>
                                    </button>
                                    <button className="fab-action" onClick={openPollModal} title="Criar enquete">
                                        <i className="fas fa-poll"></i>
                                    </button>
                                    <button className="fab-action" onClick={deleteAllMessages} title="Apagar todas as mensagens">
                                        <i className="fas fa-trash-alt"></i>
                                    </button>
                                </div>
                                <div className={`fab-sub-menu ${showThemeMenu ? 'open' : ''}`}>
                                    <div className="fab-sub-menu-item" onClick={() => changeTheme('light')}>
                                        <i className="fas fa-sun mr-2"></i>Claro
                                    </div>
                                    <div className="fab-sub-menu-item" onClick={() => changeTheme('dark')}>
                                        <i className="fas fa-moon mr-2"></i>Escuro
                                    </div>
                                    <div className="fab-sub-menu-item" onClick={() => changeTheme('nature')}>
                                        <i className="fas fa-leaf mr-2"></i>Natureza
                                    </div>
                                </div>
                                <div className={`fab-sub-menu ${showFontMenu ? 'open' : ''}`}>
                                    <div className="fab-sub-menu-item" onClick={() => changeFontSize('small')}>Pequeno</div>
                                    <div className="fab-sub-menu-item" onClick={() => changeFontSize('medium')}>Médio</div>
                                    <div className="fab-sub-menu-item" onClick={() => changeFontSize('large')}>Grande</div>
                                    <div className="fab-sub-menu-item" onClick={() => changeFontSize('xlarge')}>Extra Grande</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    {fullscreenImage && (<FullscreenImage src={fullscreenImage} onClose={closeFullscreenImage} />)}
                    <div className={`modal-overlay ${showPollModal ? 'open' : ''}`}>
                        <div className="modal">
                            <h2 className="modal-header">Criar Enquete</h2>
                            <input
                                type="text"
                                className="modal-input"
                                placeholder="Qual a sua pergunta?"
                                value={pollQuestion}
                                onChange={(e) => setPollQuestion(e.target.value)}
                            />
                            {pollOptions.map((option, index) => (
                                <div key={index} className="flex gap-2 items-center">
                                    <input
                                        type="text"
                                        className="modal-input flex-grow"
                                        placeholder={`Opção ${index + 1}`}
                                        value={option}
                                        onChange={(e) => handlePollOptionChange(index, e.target.value)}
                                    />
                                    {pollOptions.length > 2 && (
                                        <button className="modal-button" onClick={() => removePollOption(index)}>
                                            <i className="fas fa-times text-red-500"></i>
                                        </button>
                                    )}
                                </div>
                            ))}
                            <button className="modal-button" onClick={addPollOption}><i className="fas fa-plus mr-2"></i>Adicionar opção</button>
                            <div className="modal-buttons mt-4">
                                <button className="modal-button cancel" onClick={closePollModal}>Cancelar</button>
                                <button className="modal-button create" onClick={handleCreatePoll} disabled={!pollQuestion.trim() || pollOptions.some(opt => !opt.trim())}>Criar Enquete</button>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };
        ReactDOM.render(<ChatApp />, document.getElementById('root'));
    </script>
</body>
</html>
