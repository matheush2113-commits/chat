<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>GPV Chat</title>
    <script src="https://cdn.jsdelivr.net/npm/react@18.2.0/umd/react.production.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/react-dom@18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios@1.6.2/dist/axios.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@babel/standalone@7.20.6/babel.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <style>
        :root {
            --primary-color: #0066cc;
            --secondary-color: #e6f7ff;
            --background-color: #ffffff;
            --text-color: #000000;
            --message-bg-left: #e6f7ff;
            --message-bg-right: #ffffff;
            --header-bg: #0066cc;
            --footer-bg: #ffffff;
            --border-color: #e5e7eb;
            --text-size: 14px;
            --progress-bar-bg: #e5e7eb;
            --progress-bar-fill: #0066cc;
            --quoted-color: #f0f0f0;
        }

        [data-theme="dark"] {
            --primary-color: #4a9eff;
            --secondary-color: #1a365d;
            --background-color: #1a202c;
            --text-color: #ffffff;
            --message-bg-left: #2d3748;
            --message-bg-right: #4a5568;
            --header-bg: #2d3748;
            --footer-bg: #2d3748;
            --border-color: #4a5568;
            --progress-bar-bg: #4a5568;
            --progress-bar-fill: #4a9eff;
            --quoted-color: #2d3748;
        }

        [data-theme="nature"] {
            --primary-color: #22c55e;
            --secondary-color: #dcfce7;
            --background-color: #f0fdf4;
            --text-color: #166534;
            --message-bg-left: #16a34a;
            --message-bg-right: #ffffff;
            --header-bg: transparent;
            --footer-bg: #ffffff;
            --border-color: #bbf7d0;
            --progress-bar-bg: #bbf7d0;
            --progress-bar-fill: #22c55e;
            --quoted-color: #dcfce7;
        }

        body {
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            background: var(--background-color);
            overscroll-behavior: none;
            position: relative;
            color: var(--text-color);
            font-size: var(--text-size);
            transition: all 0.3s ease;
        }

        .text-small { --text-size: 12px; }
        .text-medium { --text-size: 14px; }
        .text-large { --text-size: 16px; }
        .text-xlarge { --text-size: 18px; }

        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #ffffff;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: #0066cc;
            z-index: 9999;
            transition: opacity 0.7s ease-out;
        }

        .loading-screen.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .loading-logo {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            object-fit: cover;
            margin-bottom: 20px;
            box-shadow: 0 0 15px rgba(0, 102, 204, 0.2);
            animation: logoScale 1.5s ease-in-out infinite;
        }

        @keyframes logoScale {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        .loading-text {
            font-size: 1.5rem;
            font-weight: 500;
            color: #0066cc;
        }

        .chat-container {
            height: 100vh;
            width: 100vw;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            touch-action: manipulation;
        }

        .chat-header {
            background: var(--header-bg);
            color: #ffffff;
            padding: 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            z-index: 10;
            border-bottom-left-radius: 20px;
            border-bottom-right-radius: 20px;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            scrollbar-width: thin;
            scrollbar-color: var(--primary-color) var(--border-color);
            padding: 16px;
            background: transparent;
            width: 100%;
            padding-bottom: 120px;
        }

        .chat-messages::-webkit-scrollbar {
            width: 6px;
        }

        .chat-messages::-webkit-scrollbar-track {
            background: var(--border-color);
        }

        .chat-messages::-webkit-scrollbar-thumb {
            background: var(--primary-color);
            border-radius: 3px;
        }

        .message {
            animation: fadeIn 0.3s ease-out;
            width: 100%;
            position: relative;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .message-bubble {
            position: relative;
            border-radius: 10px;
            padding: 10px 14px;
            max-width: 90%;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
            white-space: pre-wrap;
            word-wrap: normal;
            margin-bottom: 4px;
            display: inline-block;
            font-size: var(--text-size);
        }

        .message-bubble.radiate {
            animation: radiateBorder 0.5s ease-out;
        }

        @keyframes radiateBorder {
            0% { box-shadow: 0 0 0 0 rgba(0, 102, 204, 0.7); }
            100% { box-shadow: 0 0 0 10px rgba(0, 102, 204, 0); }
        }

        .message-bubble::after {
            content: '';
            position: absolute;
            width: 0;
            height: 0;
            border: 8px solid transparent;
        }

        .message-left .message-bubble {
            background: var(--message-bg-left);
            color: var(--primary-color);
        }

        .message-left .message-bubble::after {
            border-right-color: var(--message-bg-left);
            border-left: 0;
            left: -8px;
            top: 12px;
        }

        .message-right .message-bubble {
            background: var(--message-bg-right);
            color: var(--text-color);
        }

        .message-right .message-bubble::after {
            border-left-color: var(--message-bg-right);
            border-right: 0;
            right: -8px;
            top: 12px;
        }

        .message-image {
            max-width: 200px;
            border-radius: 10px;
            cursor: pointer;
            display: block;
        }

        .message-audio {
            max-width: 250px;
            border-radius: 20px;
            padding: 8px;
            background: #f0f0f0;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .waveform {
            display: flex;
            gap: 2px;
            flex: 1;
            height: 20px;
            align-items: center;
        }

        .wave-bar {
            width: 4px;
            background: var(--primary-color);
            border-radius: 2px;
            animation: audioWave 1.5s infinite ease-in-out;
        }

        .wave-bar:nth-child(2) { animation-delay: -0.3s; }
        .wave-bar:nth-child(3) { animation-delay: -0.6s; }
        .wave-bar:nth-child(4) { animation-delay: -0.9s; }
        .wave-bar:nth-child(5) { animation-delay: -1.2s; }

        @keyframes audioWave {
            0%, 100% { height: 10px; }
            50% { height: 20px; }
        }

        .fullscreen-image {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .fullscreen-image img {
            max-width: 90%;
            max-height: 90%;
            object-fit: contain;
        }

        .close-button {
            position: absolute;
            top: 20px;
            right: 20px;
            background: var(--secondary-color);
            color: var(--primary-color);
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            font-size: 20px;
        }

        .reaction-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 8px;
        }

        .reaction-button {
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 4px;
            color: var(--primary-color);
            font-size: calc(var(--text-size) * 0.8);
            background: rgba(0, 102, 204, 0.1);
            border-radius: 15px;
            padding: 6px 10px;
            transition: all 0.3s ease;
            border: 1px solid transparent;
            user-select: none;
        }

        .reaction-button:hover {
            background: var(--secondary-color);
            border-color: var(--primary-color);
            transform: translateY(-1px);
        }

        .reaction-button.active {
            background: var(--primary-color);
            color: white;
        }

        .reaction-button i {
            font-size: 1.1em;
        }

        .like-button {
            color: #e91e63;
        }

        .like-button:hover {
            background: rgba(233, 30, 99, 0.1);
            border-color: #e91e63;
        }

        .laugh-button {
            color: #ff9800;
        }

        .laugh-button:hover {
            background: rgba(255, 152, 0, 0.1);
            border-color: #ff9800;
        }

        .sad-button {
            color: #2196f3;
        }

        .sad-button:hover {
            background: rgba(33, 150, 243, 0.1);
            border-color: #2196f3;
        }

        .quote-button {
            color: var(--primary-color);
        }

        .delete-button {
            color: #f44336;
        }

        .delete-button:hover {
            background: rgba(244, 67, 54, 0.1);
            border-color: #f44336;
        }

        .heart-rain {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 10;
        }

        .heart {
            position: absolute;
            color: var(--primary-color);
            font-size: 12px;
            opacity: 0;
            animation: heartRain 1s ease-out forwards;
        }

        @keyframes heartRain {
            0% { opacity: 1; transform: translateY(0) scale(1); }
            100% { opacity: 0; transform: translateY(100px) scale(0.5); }
        }

        .mention {
            color: var(--primary-color);
            font-weight: bold;
        }

        .typing-indicator {
            position: sticky;
            bottom: 60px;
            left: 16px;
            background: var(--secondary-color);
            border-radius: 15px;
            padding: 12px 16px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
            color: var(--text-color);
            font-size: calc(var(--text-size) * 0.9);
            display: flex;
            align-items: center;
            gap: 8px;
            animation: pulse 1.5s ease-in-out infinite;
            margin-top: 8px;
            width: fit-content;
            border: 2px solid var(--primary-color);
        }

        .typing-avatar {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            object-fit: cover;
        }

        .typing-text {
            font-weight: 600;
            font-size: calc(var(--text-size) * 1.1);
        }

        .dot {
            width: 6px;
            height: 6px;
            background: var(--primary-color);
            border-radius: 50%;
            animation: bounce 1.2s infinite ease-in-out;
        }

        .dot:nth-child(2) {
            animation-delay: -0.4s;
        }

        .dot:nth-child(3) {
            animation-delay: -0.8s;
        }

        @keyframes bounce {
            0%, 80%, 100% { transform: translateY(0); }
            40% { transform: translateY(-5px); }
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .chat-footer {
            background: var(--footer-bg);
            padding: 10px 16px;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 -2px 5px rgba(0, 0, 0, 0.1);
            z-index: 10;
            border-top-left-radius: 20px;
            border-top-right-radius: 20px;
            position: relative;
            flex-direction: column;
        }

        .chat-input {
            flex: 1;
            padding: 12px 16px;
            border: 2px solid var(--primary-color);
            border-radius: 20px;
            outline: none;
            font-size: var(--text-size);
            transition: border-color 0.3s ease, transform 0.2s ease;
            background: var(--background-color);
            color: var(--text-color);
            width: 100%;
        }

        .chat-input:focus {
            border-color: var(--secondary-color);
            transform: scale(1.02);
        }

        .fab-container {
            position: relative;
            display: flex;
            align-items: center;
        }

        .fab-main {
            background: var(--primary-color);
            color: #ffffff;
            border: none;
            border-radius: 50%;
            width: 48px;
            height: 48px;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: transform 0.3s ease;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }

        .fab-main:hover {
            background: var(--secondary-color);
            color: var(--primary-color);
            transform: scale(1.1);
        }

        .fab-main.open {
            transform: rotate(45deg);
        }

        .fab-actions {
            position: absolute;
            bottom: 60px;
            right: 16px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            opacity: 0;
            pointer-events: none;
            transform: translateY(20px);
            transition: all 0.3s ease;
        }

        .fab-actions.open {
            opacity: 1;
            pointer-events: auto;
            transform: translateY(0);
        }

        .fab-action {
            background: var(--primary-color);
            color: #ffffff;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }

        .fab-action:hover {
            background: var(--secondary-color);
            color: var(--primary-color);
            transform: scale(1.1);
        }

        .fab-action.recording {
            background: var(--primary-color);
            animation: pulseRecording 1s infinite;
        }

        .fab-action:disabled {
            background: #cccccc;
            cursor: not-allowed;
            transform: none;
        }

        @keyframes pulseRecording {
            0% { transform: scale(1); }
            50% { transform: scale(1.15); }
            100% { transform: scale(1); }
        }

        .send-button {
            background: var(--primary-color);
            color: #ffffff;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            opacity: 0;
            transform: scale(0);
        }

        .send-button.visible {
            opacity: 1;
            transform: scale(1);
        }

        .send-button:hover {
            background: var(--secondary-color);
            color: var(--primary-color);
            transform: scale(1.1);
        }

        .fab-sub-menu {
            position: absolute;
            bottom: 60px;
            right: 60px;
            background-color: var(--background-color);
            min-width: 160px;
            box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
            z-index: 1000;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            display: none;
        }

        .fab-sub-menu.open {
            display: block;
        }

        .fab-sub-menu-item {
            color: var(--text-color);
            padding: 12px 16px;
            text-decoration: none;
            display: block;
            cursor: pointer;
            border-radius: 8px;
            margin: 4px;
            transition: background-color 0.3s;
        }

        .fab-sub-menu-item:hover {
            background-color: var(--secondary-color);
        }

        .recording-animation {
            position: absolute;
            bottom: 60px;
            left: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
            background: var(--secondary-color);
            border-radius: 20px;
            padding: 8px 16px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            z-index: 9;
            animation: slideIn 0.3s ease-out;
        }

        .recording-icon {
            font-size: 1.5rem;
            color: var(--primary-color);
            animation: pulseIcon 1.5s infinite;
        }

        .recording-wave {
            display: flex;
            gap: 4px;
            align-items: center;
        }

        .recording-wave-bar {
            width: 6px;
            height: 20px;
            background: var(--primary-color);
            border-radius: 3px;
            animation: wave 1.2s infinite ease-in-out;
        }

        .recording-wave-bar:nth-child(2) { animation-delay: -0.3s; }
        .recording-wave-bar:nth-child(3) { animation-delay: -0.6s; }
        .recording-wave-bar:nth-child(4) { animation-delay: -0.9s; }
        .recording-wave-bar:nth-child(5) { animation-delay: -1.2s; }

        @keyframes wave {
            0%, 100% { transform: scaleY(1); }
            50% { transform: scaleY(2.5); }
        }

        @keyframes pulseIcon {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.3); }
        }

        @keyframes slideIn {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .progress-bar-container {
            position: absolute;
            bottom: 80px;
            left: 16px;
            width: 200px;
            background: var(--secondary-color);
            border-radius: 12px;
            padding: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            z-index: 9;
            animation: slideIn 0.3s ease-out;
        }

        .progress-bar {
            height: 8px;
            background: var(--progress-bar-bg);
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-bar-fill {
            height: 100%;
            background: var(--progress-bar-fill);
            transition: width 0.2s ease-in-out;
        }

        .progress-text {
            font-size: calc(var(--text-size) * 0.8);
            color: var(--primary-color);
            margin-top: 4px;
            text-align: center;
        }

        .quoted-message {
            background: var(--quoted-color);
            padding: 8px;
            border-radius: 8px;
            margin-bottom: 8px;
            border-left: 4px solid var(--primary-color);
        }

        .quoted-user {
            font-weight: bold;
            color: var(--primary-color);
        }

        .quoted-text {
            font-size: 0.9em;
        }

        .quoted-preview {
            background: var(--quoted-color);
            padding: 8px;
            border-radius: 8px;
            margin-bottom: 8px;
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            width: 100%;
        }

        .quoted-preview button {
            background: transparent;
            border: none;
            color: var(--primary-color);
            cursor: pointer;
            align-self: flex-end;
        }

        .input-container {
            display: flex;
            align-items: center;
            gap: 8px;
            width: 100%;
        }

        .reply-text {
            color: var(--primary-color);
            font-size: calc(var(--text-size) * 0.8);
            margin-top: 4px;
        }

        .poll-container {
            margin-top: 12px;
            background: var(--secondary-color);
            border-radius: 12px;
            padding: 16px;
            border: 2px solid var(--primary-color);
        }

        .poll-question {
            font-weight: bold;
            font-size: 1.1em;
            margin-bottom: 8px;
            color: var(--primary-color);
        }

        .poll-stats {
            font-size: 0.9em;
            color: var(--text-color);
            margin-bottom: 12px;
            opacity: 0.8;
        }

        .poll-options-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 8px;
            margin-bottom: 12px;
        }

        .poll-option-button {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 10px 12px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .poll-option-button:hover {
            background: var(--secondary-color);
            color: var(--primary-color);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        .poll-responses {
            margin-top: 12px;
        }

        .poll-responses-header {
            font-weight: bold;
            margin-bottom: 8px;
            color: var(--primary-color);
        }

        .poll-responses-list {
            max-height: 150px;
            overflow-y: auto;
            background: var(--background-color);
            border-radius: 6px;
            padding: 8px;
            border: 1px solid var(--border-color);
        }

        .poll-response-item {
            background: rgba(0, 102, 204, 0.1);
            padding: 6px 10px;
            margin-bottom: 4px;
            border-radius: 4px;
            font-size: 0.85em;
            border-left: 3px solid var(--primary-color);
        }

        .poll-response-item:last-child {
            margin-bottom: 0;
        }

        .poll-winner-announcement {
            margin-top: 12px;
            text-align: center;
            font-weight: bold;
            color: #4caf50;
            background: rgba(76, 175, 80, 0.1);
            padding: 10px;
            border-radius: 8px;
            border: 2px solid #4caf50;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.02); }
            100% { transform: scale(1); }
        }

        .poll-option {
            margin-bottom: 12px;
            background: var(--background-color);
            border-radius: 8px;
            padding: 10px;
            border: 1px solid var(--border-color);
        }

        .poll-option-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 6px;
            font-size: 0.9em;
        }

        .poll-winner {
            font-weight: bold;
            color: #4caf50;
        }

        .poll-progress-bar {
            height: 12px;
            background: var(--progress-bar-bg);
            border-radius: 6px;
            overflow: hidden;
            margin-bottom: 8px;
        }

        .poll-progress-fill {
            height: 100%;
            background: var(--primary-color);
            transition: width 0.4s ease-in-out;
            border-radius: 6px;
        }

        .poll-progress-fill.winner {
            background: #4caf50;
            box-shadow: 0 0 8px rgba(76, 175, 80, 0.4);
        }

        .poll-vote-btn {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85em;
            transition: all 0.3s ease;
        }

        .poll-vote-btn:hover {
            background: var(--secondary-color);
            color: var(--primary-color);
            transform: translateY(-1px);
        }

        .poll-bar {
            height: 8px;
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 4px;
        }

        .poll-bar-fill {
            height: 100%;
            transition: width 0.2s ease-in-out;
        }

        .poll-bar-sim {
            background: #4caf50;
        }

        .poll-bar-nao {
            background: #f44336;
        }

        .poll-error {
            color: #f44336;
            font-style: italic;
            text-align: center;
            padding: 10px;
            background: rgba(244, 67, 54, 0.1);
            border-radius: 6px;
            margin-top: 8px;
        }
    </style>
</head>
<body>
    <div class="loading-screen" id="loading-screen">
        <img
            src="https://i.postimg.cc/Ssk9kkHb/1757343420124.png"
            alt="GPV Logo"
            class="loading-logo"
        />
        <p class="loading-text">Iniciando GPV Chat...</p>
    </div>
    <div id="root"></div>
    <script type="text/babel">
        const AudioPlayer = ({ src }) => {
            const audioRef = React.useRef(null);
            const [isPlaying, setIsPlaying] = React.useState(false);
            const [progress, setProgress] = React.useState(0);

            const togglePlay = () => {
                if (isPlaying) {
                    audioRef.current.pause();
                } else {
                    audioRef.current.play();
                }
                setIsPlaying(!isPlaying);
            };

            const handleTimeUpdate = () => {
                const current = audioRef.current.currentTime;
                const duration = audioRef.current.duration;
                setProgress((current / duration) * 100);
            };

            const handleSeek = (e) => {
                const seekTime = (e.target.value / 100) * audioRef.current.duration;
                audioRef.current.currentTime = seekTime;
                setProgress(e.target.value);
            };

            return (
                <div className="message-audio">
                    <button onClick={togglePlay} className="control-button">
                        <i className={`fas ${isPlaying ? 'fa-pause' : 'fa-play'}`}></i>
                    </button>
                    <div className="waveform">
                        {Array.from({ length: 10 }).map((_, i) => (
                            <div
                                key={i}
                                className="wave-bar"
                                style={{ height: `${10 + Math.random() * 10}px` }}
                            ></div>
                        ))}
                    </div>
                    <input
                        type="range"
                        value={progress}
                        onChange={handleSeek}
                        min="0"
                        max="100"
                        className="w-full h-1 bg-gray-200 rounded-lg"
                    />
                    <audio
                        ref={audioRef}
                        src={src}
                        onTimeUpdate={handleTimeUpdate}
                        onEnded={() => setIsPlaying(false)}
                    />
                </div>
            );
        };

        const PollComponent = ({ id, question, options, votes, onVote }) => {
            let pollData;
            try {
                pollData = JSON.parse(options || '{}');
            } catch (error) {
                console.error('Erro ao parsear opções da enquete:', error);
                pollData = { options: [] };
            }
            
            const voteArray = votes ? votes.split('|').filter(v => v.trim() !== '') : [];
            const optionLabels = pollData.options || [];
            
            if (optionLabels.length === 0) {
                return (
                    <div className="poll-container">
                        <div className="poll-question">{question}</div>
                        <div className="poll-error">Erro: Nenhuma opção encontrada</div>
                    </div>
                );
            }
            
            // Contar palavras em todos os votos para determinar vencedor
            const wordCount = {};
            voteArray.forEach(vote => {
                const words = vote.toLowerCase().split(/\s+/);
                words.forEach(word => {
                    if (word.length > 0) {
                        wordCount[word] = (wordCount[word] || 0) + 1;
                    }
                });
            });
            
            // Encontrar palavra mais repetida
            let mostRepeatedWord = '';
            let maxCount = 0;
            Object.entries(wordCount).forEach(([word, count]) => {
                if (count > maxCount) {
                    maxCount = count;
                    mostRepeatedWord = word;
                }
            });

            const totalVotes = voteArray.length;

            return (
                <div className="poll-container">
                    <div className="poll-question">{question}</div>
                    <div className="poll-stats">Total de respostas: {totalVotes}</div>
                    
                    <div className="poll-options-grid">
                        {optionLabels.map((option, index) => (
                            <button 
                                key={index}
                                className="poll-option-button"
                                onClick={() => onVote(id, option)}
                            >
                                {option}
                            </button>
                        ))}
                    </div>
                    
                    {maxCount > 1 && (
                        <div className="poll-winner-announcement">
                            🏆 Palavra mais repetida: "{mostRepeatedWord}" ({maxCount} vezes)
                        </div>
                    )}
                    
                    {totalVotes > 0 && (
                        <div className="poll-responses">
                            <div className="poll-responses-header">Respostas ({totalVotes}):</div>
                            <div className="poll-responses-list">
                                {voteArray.map((vote, index) => (
                                    <div key={index} className="poll-response-item">
                                        {vote}
                                    </div>
                                ))}
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const ChatMessage = ({ id, usuario, mensagem, data, fotoPerfil, isRight, mensacao, laughs, sads, arquivosGravados, quotedMsg, enquete, citacao, onLike, onLaugh, onSad, onQuote, onImageClick, onDelete, onVote }) => {
            const [isAnimating, setIsAnimating] = React.useState(false);
            const [hearts, setHearts] = React.useState([]);
            
            const formatDate = (dateString) => {
                const date = new Date(dateString);
                return date.toLocaleString('pt-BR', {
                    hour: '2-digit',
                    minute: '2-digit'
                });
            };

            const handleLike = () => {
                if (!isAnimating) {
                    setIsAnimating(true);
                    const newHearts = Array.from({ length: 10 }, (_, i) => ({
                        id: i,
                        left: `${Math.random() * 100}%`,
                        animationDelay: `${Math.random() * 0.5}s`
                    }));
                    setHearts(newHearts);
                    onLike(id, mensacao);
                    setTimeout(() => {
                        setIsAnimating(false);
                        setHearts([]);
                    }, 1000);
                }
            };

            const handleLaugh = () => {
                onLaugh(id, laughs);
            };

            const handleSad = () => {
                onSad(id, sads);
            };

            const handleQuote = () => {
                onQuote({ id, usuario, mensagem, data, fotoPerfil, mensacao, laughs, sads, arquivosGravados });
            };

            const handleDelete = async () => {
                if (window.confirm('Tem certeza que deseja apagar esta mensagem para todos?')) {
                    onDelete(id);
                }
            };

            const isImage = /\.(jpg|jpeg|png|gif|webp|bmp)$/i.test(mensagem) || mensagem?.startsWith('blob:');
            const isVideo = /\.(mp4|webm|ogg|avi|mov)$/i.test(mensagem);
            const isPoll = enquete !== undefined && enquete !== null && citacao && citacao.includes('options');
            const cleanMessage = mensagem ? mensagem.replace(/[\r\n]+/g, ' ').trim() : '';
            const parts = cleanMessage.split(/(@\w+)/g);
            const renderedMessage = parts.map((part, index) => {
                if (part.startsWith('@')) {
                    return <span key={index} className="mention">{part}</span>;
                }
                return part;
            });

            const likeCount = parseInt(mensacao || '0', 10);
            const laughCount = parseInt(laughs || '0', 10);
            const sadCount = parseInt(sads || '0', 10);
            const audioFile = arquivosGravados && arquivosGravados.length > 0 ? arquivosGravados[0] : null;
            const replyText = quotedMsg ? 'Resposta ao' : '';
            const userDisplay = usuario && usuario !== 'string' ? usuario : 'Anônimo';

            return (
                <div className={`flex ${isRight ? 'justify-end' : 'justify-start'} mb-4 message message-${isRight ? 'right' : 'left'}`}>
                    <div className={`flex ${isRight ? 'flex-row-reverse' : 'flex-row'} items-start w-full`}>
                        <img
                            src={fotoPerfil || 'https://i.postimg.cc/Ssk9kkHb/1757343420124.png'}
                            alt="Profile"
                            className="w-10 h-10 rounded-full object-cover mt-2"
                        />
                        <div className="flex flex-col mx-2 w-full relative">
                            <div className={`message-bubble ${isAnimating ? 'radiate' : ''}`}>
                                <span className="text-xs font-semibold" style={{ color: isRight ? 'var(--primary-color)' : '#ffffff' }}>{userDisplay}</span>
                                {quotedMsg && (
                                    <div className="quoted-message">
                                        <span className="quoted-user">{quotedMsg.Usuario}</span>
                                        <p className="quoted-text">{quotedMsg.DIGIOTOU}</p>
                                    </div>
                                )}
                                {citacao && <p className="quoted-text">{citacao}</p>}
                                {isPoll ? (
                                    <PollComponent 
                                        id={id} 
                                        question={mensagem} 
                                        options={citacao} 
                                        votes={enquete} 
                                        onVote={onVote} 
                                    />
                                ) : isImage ? (
                                    <img
                                        src={mensagem}
                                        alt="Message"
                                        className="message-image"
                                        onClick={() => onImageClick(mensagem)}
                                    />
                                ) : isVideo ? (
                                    <video
                                        src={mensagem}
                                        controls
                                        className="message-image"
                                    />
                                ) : audioFile ? (
                                    <AudioPlayer src={audioFile.url} />
                                ) : (
                                    mensagem && <p className="text-sm leading-relaxed mt-1">{renderedMessage}</p>
                                )}
                                <div className="flex items-center justify-end mt-1">
                                    <span className="text-xs text-gray-500">{formatDate(data)}</span>
                                    {isRight && <i className="fas fa-check text-xs text-gray-500 ml-1"></i>}
                                </div>
                            </div>
                            <div className="heart-rain">
                                {hearts.map(heart => (
                                    <i
                                        key={heart.id}
                                        className="fas fa-heart heart"
                                        style={{
                                            left: heart.left,
                                            animationDelay: heart.animationDelay
                                        }}
                                    ></i>
                                ))}
                            </div>
                            <div className="reaction-buttons">
                                {!isRight && (
                                    <div className="reaction-button like-button" onClick={handleLike}>
                                        <i className="fas fa-heart"></i>
                                        <span>{likeCount}</span>
                                    </div>
                                )}
                                {!isRight && (
                                    <div className="reaction-button laugh-button" onClick={handleLaugh}>
                                        <i className="fas fa-laugh"></i>
                                        <span>{laughCount}</span>
                                    </div>
                                )}
                                {!isRight && (
                                    <div className="reaction-button sad-button" onClick={handleSad}>
                                        <i className="fas fa-sad-tear"></i>
                                        <span>{sadCount}</span>
                                    </div>
                                )}
                                {!isRight && (
                                    <div className="reaction-button quote-button" onClick={handleQuote}>
                                        <i className="fas fa-reply"></i>
                                        <span>Citar</span>
                                    </div>
                                )}
                                <div className="reaction-button delete-button" onClick={handleDelete}>
                                    <i className="fas fa-trash"></i>
                                    <span>Apagar</span>
                                </div>
                            </div>
                            {replyText && <span className="reply-text">{replyText}</span>}
                        </div>
                    </div>
                </div>
            );
        };

        const FullscreenImage = ({ src, onClose }) => {
            return (
                <div className="fullscreen-image" onClick={onClose}>
                    <img src={src} alt="Fullscreen" />
                    <button className="close-button" onClick={onClose}>
                        <i className="fas fa-times"></i>
                    </button>
                </div>
            );
        };

        const RecordingAnimation = ({ duration }) => {
            return (
                <div className="recording-animation">
                    <i className="fas fa-microphone recording-icon"></i>
                    <div className="recording-wave">
                        <div className="recording-wave-bar"></div>
                        <div className="recording-wave-bar"></div>
                        <div className="recording-wave-bar"></div>
                        <div className="recording-wave-bar"></div>
                        <div className="recording-wave-bar"></div>
                    </div>
                    <span className="text-xs font-semibold" style={{ color: 'var(--primary-color)' }}>
                        Gravando... {duration}s
                    </span>
                </div>
            );
        };

        const ProgressBar = ({ progress }) => {
            return (
                <div className="progress-bar-container">
                    <div className="progress-bar">
                        <div
                            className="progress-bar-fill"
                            style={{ width: `${progress}%` }}
                        ></div>
                    </div>
                    <div className="progress-text">Enviando: {Math.round(progress)}%</div>
                </div>
            );
        };

        const TypingIndicator = ({ user, avatar }) => {
            return (
                <div className="typing-indicator">
                    <img src={avatar || 'https://i.postimg.cc/Ssk9kkHb/1757343420124.png'} 
                         alt="Avatar" className="typing-avatar" />
                    <span className="typing-text">{user} está digitando</span>
                    <div className="flex gap-1">
                        <div className="dot"></div>
                        <div className="dot"></div>
                        <div className="dot"></div>
                    </div>
                </div>
            );
        };

        const ChatApp = () => {
            const [messages, setMessages] = React.useState([]);
            const [typingUser, setTypingUser] = React.useState(null);
            const [typingUserData, setTypingUserData] = React.useState(null);
            const [isLoading, setIsLoading] = React.useState(true);
            const [fullscreenImage, setFullscreenImage] = React.useState(null);
            const [inputText, setInputText] = React.useState('');
            const [isRecording, setIsRecording] = React.useState(false);
            const [userData, setUserData] = React.useState(null);
            const [currentUserId, setCurrentUserId] = React.useState(null);
            const [mediaRecorder, setMediaRecorder] = React.useState(null);
            const [theme, setTheme] = React.useState('light');
            const [fontSize, setFontSize] = React.useState('medium');
            const [showThemeMenu, setShowThemeMenu] = React.useState(false);
            const [showFontMenu, setShowFontMenu] = React.useState(false);
            const [uploadProgress, setUploadProgress] = React.useState(null);
            const [fabOpen, setFabOpen] = React.useState(false);
            const [recordingDuration, setRecordingDuration] = React.useState(0);
            const [quotedMessage, setQuotedMessage] = React.useState(null);
            const [loadingTimer, setLoadingTimer] = React.useState(null);
            const messagesEndRef = React.useRef(null);

            const currentUser = userData?.NOME || "Usuário";
            const defaultProfilePic = 'https://i.postimg.cc/Ssk9kkHb/1757343420124.png';
            const apiToken = 'UkqZsuMMnwE59fMqs8OwXX60SASP7FOd';

            // Mock data for fallback
            const mockMessages = [
                {
                    id: 1,
                    Usuario: "Sistema",
                    DIGIOTOU: "Bem-vindo ao GPV Chat! O chat está funcionando no modo offline.",
                    DATAENVIO: new Date().toISOString(),
                    FOTOPERFIL: defaultProfilePic,
                    mensacao: '0',
                    laughs: '0',
                    sads: '0',
                    ArquivosGravados: [],
                    enquete: null,
                    citacao: null
                }
            ];

            const mockUserData = {
                NOME: "Usuário",
                PERFIL: defaultProfilePic
            };

            // Função para remover a tela de loading após timeout
            const hideLoadingScreen = React.useCallback(() => {
                console.log('Ocultando tela de carregamento...');
                setIsLoading(false);
                const loadingScreen = document.getElementById('loading-screen');
                if (loadingScreen) {
                    loadingScreen.classList.add('hidden');
                }
            }, []);

            // Aplicar tema e tamanho da fonte
            React.useEffect(() => {
                document.body.setAttribute('data-theme', theme);
                document.body.className = `text-${fontSize}`;
            }, [theme, fontSize]);

            // Auto-scroll para o final das mensagens
            React.useEffect(() => {
                if (messagesEndRef.current) {
                    messagesEndRef.current.scrollIntoView({ behavior: 'smooth' });
                }
            }, [messages]);

            // Timer de fallback para loading screen
            React.useEffect(() => {
                const timer = setTimeout(() => {
                    hideLoadingScreen();
                }, 3000); // Remove loading após 3 segundos no máximo

                setLoadingTimer(timer);

                return () => {
                    if (timer) clearTimeout(timer);
                };
            }, [hideLoadingScreen]);

            const fetchUserData = async () => {
                try {
                    const response = await Promise.race([
                        axios({
                            method: 'GET',
                            url: 'https://api.baserow.io/api/database/rows/table/221009/?user_field_names=true',
                            headers: { Authorization: `Token ${apiToken}` },
                            timeout: 5000
                        }),
                        new Promise((_, reject) => setTimeout(() => reject(new Error('Timeout')), 5000))
                    ]);

                    const results = response.data.results;
                    const activeUserRow = results.find(row => row.ultimoclick && row.ultimoclick.trim() !== '');
                    
                    if (activeUserRow) {
                        const userId = activeUserRow.id;
                        setCurrentUserId(userId);
                        setUserData({ NOME: activeUserRow.NOME, PERFIL: activeUserRow.PERFIL });
                        console.log('Usuário ativo encontrado:', activeUserRow.NOME);
                        
                        // Limpar o campo ultimoclick
                        await axios({
                            method: 'PATCH',
                            url: `https://api.baserow.io/api/database/rows/table/221009/${userId}/?user_field_names=true`,
                            headers: { Authorization: `Token ${apiToken}` },
                            data: { ultimoclick: '' },
                            timeout: 3000
                        });
                        
                        return true;
                    } else {
                        throw new Error('Nenhum usuário ativo encontrado');
                    }
                } catch (error) {
                    console.log('Usando dados mock para usuário (erro na API ou timeout)');
                    setCurrentUserId(1);
                    setUserData(mockUserData);
                    return false;
                }
            };

            const fetchMessages = async () => {
                try {
                    const response = await Promise.race([
                        axios({
                            method: 'GET',
                            url: 'https://api.baserow.io/api/database/rows/table/459281/?user_field_names=true',
                            headers: { Authorization: `Token ${apiToken}` },
                            timeout: 5000
                        }),
                        new Promise((_, reject) => setTimeout(() => reject(new Error('Timeout')), 5000))
                    ]);

                    const results = response.data.results;
                    const processedMessages = results.map(msg => {
                        if (msg.QuotedId) {
                            const quotedId = parseInt(msg.QuotedId, 10);
                            const quotedMsg = results.find(m => m.id === quotedId);
                            return { ...msg, quotedMsg };
                        }
                        return msg;
                    });
                    
                    setMessages(processedMessages);
                    console.log(`${processedMessages.length} mensagens carregadas da API`);
                    return true;
                } catch (error) {
                    console.log('Usando mensagens mock devido a erro na API ou timeout');
                    setMessages(mockMessages);
                    return false;
                }
            };

            const fetchTypingStatus = async () => {
                try {
                    const response = await Promise.race([
                        axios({
                            method: 'GET',
                            url: 'https://api.baserow.io/api/database/rows/table/314649/?user_field_names=true',
                            headers: { Authorization: `Token ${apiToken}` },
                            timeout: 3000
                        }),
                        new Promise((_, reject) => setTimeout(() => reject(new Error('Timeout')), 3000))
                    ]);

                    const typingData = response.data.results.find(user => 
                        user.digitandotruefalse === 'true' && user.DigitandoUser !== currentUser
                    );
                    
                    if (typingData) {
                        setTypingUser(typingData.DigitandoUser);
                        setTypingUserData({ NOME: typingData.DigitandoUser, PERFIL: defaultProfilePic });
                    } else {
                        setTypingUser(null);
                        setTypingUserData(null);
                    }
                    return true;
                } catch (error) {
                    console.log('Erro ao verificar status de digitação (continuando normalmente)');
                    return false;
                }
            };

            const updateTypingStatus = async (isTyping) => {
                if (!currentUserId) return;
                try {
                    await axios({
                        method: 'PATCH',
                        url: `https://api.baserow.io/api/database/rows/table/314649/${currentUserId}/?user_field_names=true`,
                        headers: { Authorization: `Token ${apiToken}` },
                        data: {
                            digitandotruefalse: isTyping ? 'true' : 'false',
                            DigitandoUser: currentUser
                        },
                        timeout: 2000
                    });
                } catch (error) {
                    console.log('Erro ao atualizar status de digitação (continuando normalmente)');
                }
            };

            const likeMessage = async (id, currentLikes) => {
                try {
                    const currentCount = parseInt(currentLikes || '0', 10);
                    const newCount = currentCount + 1;
                    
                    // Atualizar localmente primeiro
                    setMessages(messages.map(msg => 
                        msg.id === id ? { ...msg, mensacao: newCount.toString() } : msg
                    ));

                    await axios({
                        method: 'PATCH',
                        url: `https://api.baserow.io/api/database/rows/table/459281/${id}/?user_field_names=true`,
                        data: { mensacao: newCount.toString() },
                        headers: { Authorization: `Token ${apiToken}` },
                        timeout: 3000
                    });
                } catch (error) {
                    console.log('Erro ao curtir mensagem (mantendo mudança local)');
                }
            };

            const laughMessage = async (id, currentLaughs) => {
                try {
                    const currentCount = parseInt(currentLaughs || '0', 10);
                    const newCount = currentCount + 1;
                    
                    setMessages(messages.map(msg => 
                        msg.id === id ? { ...msg, laughs: newCount.toString() } : msg
                    ));

                    await axios({
                        method: 'PATCH',
                        url: `https://api.baserow.io/api/database/rows/table/459281/${id}/?user_field_names=true`,
                        data: { laughs: newCount.toString() },
                        headers: { Authorization: `Token ${apiToken}` },
                        timeout: 3000
                    });
                } catch (error) {
                    console.log('Erro ao reagir com riso (mantendo mudança local)');
                }
            };

            const sadMessage = async (id, currentSads) => {
                try {
                    const currentCount = parseInt(currentSads || '0', 10);
                    const newCount = currentCount + 1;
                    
                    setMessages(messages.map(msg => 
                        msg.id === id ? { ...msg, sads: newCount.toString() } : msg
                    ));

                    await axios({
                        method: 'PATCH',
                        url: `https://api.baserow.io/api/database/rows/table/459281/${id}/?user_field_names=true`,
                        data: { sads: newCount.toString() },
                        headers: { Authorization: `Token ${apiToken}` },
                        timeout: 3000
                    });
                } catch (error) {
                    console.log('Erro ao reagir com tristeza (mantendo mudança local)');
                }
            };

            const deleteMessage = async (id) => {
                try {
                    await axios({
                        method: 'DELETE',
                        url: `https://api.baserow.io/api/database/rows/table/459281/${id}/`,
                        headers: { Authorization: `Token ${apiToken}` },
                        timeout: 5000
                    });
                    
                    setMessages(messages.filter(msg => msg.id !== id));
                } catch (error) {
                    console.log('Erro ao apagar mensagem da API, removendo apenas localmente');
                    setMessages(messages.filter(msg => msg.id !== id));
                }
            };

            const handleSendMessage = async (fileData = null) => {
                if (!inputText.trim() && !fileData) return;

                const tempId = Date.now();
                const newMessage = {
                    id: tempId,
                    Usuario: currentUser,
                    DIGIOTOU: inputText || (fileData && !fileData.isAudio ? fileData.url : ''),
                    DATAENVIO: new Date().toISOString(),
                    FOTOPERFIL: userData?.PERFIL || defaultProfilePic,
                    mensacao: '0',
                    laughs: '0',
                    sads: '0',
                    ArquivosGravados: fileData && fileData.isAudio ? [fileData] : [],
                    quotedMsg: quotedMessage
                };

                // Adicionar mensagem localmente primeiro
                setMessages(prevMessages => [...prevMessages, newMessage]);
                setInputText('');
                setQuotedMessage(null);

                try {
                    const data = {
                        Usuario: currentUser,
                        DIGIOTOU: inputText || (fileData && !fileData.isAudio ? fileData.url : ''),
                        DATAENVIO: new Date().toISOString(),
                        FOTOPERFIL: userData?.PERFIL || defaultProfilePic,
                        mensacao: '0'
                    };

                    if (quotedMessage) {
                        data.QuotedId = quotedMessage.id.toString();
                    }

                    if (fileData && fileData.isAudio) {
                        data.ArquivosGravados = [{ name: fileData.name, url: fileData.url }];
                    }

                    await axios({
                        method: 'POST',
                        url: 'https://api.baserow.io/api/database/rows/table/459281/?user_field_names=true',
                        data,
                        headers: { Authorization: `Token ${apiToken}` },
                        timeout: 10000
                    });
                    
                    console.log('Mensagem enviada com sucesso para a API');
                } catch (error) {
                    console.log('Erro ao enviar mensagem para API, mantendo apenas localmente');
                }
            };

            const votePoll = async (id, vote) => {
                try {
                    const message = messages.find(msg => msg.id === id);
                    const currentVotes = message?.enquete || '';
                    const newVotes = currentVotes ? currentVotes + '|' + vote : vote;
                    
                    setMessages(messages.map(msg => 
                        msg.id === id ? { ...msg, enquete: newVotes } : msg
                    ));

                    await axios({
                        method: 'PATCH',
                        url: `https://api.baserow.io/api/database/rows/table/459281/${id}/?user_field_names=true`,
                        data: { enquete: newVotes },
                        headers: { Authorization: `Token ${apiToken}` },
                        timeout: 3000
                    });
                } catch (error) {
                    console.log('Erro ao votar na enquete (mantendo mudança local)');
                }
            };

            const createPoll = async () => {
                const question = prompt('Digite a pergunta da enquete:');
                if (!question) return;

                let numOptions = prompt('Quantas opções terá a enquete? (2-10)');
                numOptions = parseInt(numOptions);
                
                if (!numOptions || numOptions < 2 || numOptions > 10) {
                    alert('Número de opções deve ser entre 2 e 10');
                    return;
                }

                const options = [];
                for (let i = 0; i < numOptions; i++) {
                    const option = prompt(`Digite a opção ${i + 1}:`);
                    if (!option) {
                        alert('Todas as opções devem ser preenchidas');
                        return;
                    }
                    options.push(option);
                }

                const pollOptions = { options: options };
                
                const newMessage = {
                    id: Date.now(),
                    Usuario: currentUser,
                    DIGIOTOU: question,
                    DATAENVIO: new Date().toISOString(),
                    FOTOPERFIL: userData?.PERFIL || defaultProfilePic,
                    mensacao: '0',
                    laughs: '0',
                    sads: '0',
                    enquete: '', // Votos vazios inicialmente
                    citacao: JSON.stringify(pollOptions) // Opções da enquete
                };
                
                setMessages(prevMessages => [...prevMessages, newMessage]);

                // Tentar enviar para API
                try {
                    await axios({
                        method: 'POST',
                        url: 'https://api.baserow.io/api/database/rows/table/459281/?user_field_names=true',
                        data: {
                            Usuario: currentUser,
                            DIGIOTOU: question,
                            DATAENVIO: new Date().toISOString(),
                            FOTOPERFIL: userData?.PERFIL || defaultProfilePic,
                            mensacao: '0',
                            enquete: '',
                            citacao: JSON.stringify(pollOptions)
                        },
                        headers: { Authorization: `Token ${apiToken}` },
                        timeout: 10000
                    });
                } catch (error) {
                    console.log('Erro ao enviar enquete para API, mantendo apenas localmente');
                }
            };

            const deleteAllMessages = async () => {
                const password = prompt('Digite a senha para apagar todas as mensagens:');
                if (password === 'admincordeiro') {
                    setMessages([]);
                    alert('Todas as mensagens foram apagadas localmente.');
                } else if (password) {
                    alert('Senha incorreta!');
                }
            };

            const handleImageClick = (src) => {
                setFullscreenImage(src);
            };

            const closeFullscreenImage = () => {
                setFullscreenImage(null);
            };

            const handleUploadPhoto = () => {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = 'image/*';
                input.onchange = async (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        // Simular progress bar de upload
                        setUploadProgress(0);
                        const intervals = [10, 30, 50, 70, 85, 100];
                        let currentStep = 0;
                        
                        const progressInterval = setInterval(() => {
                            if (currentStep < intervals.length) {
                                setUploadProgress(intervals[currentStep]);
                                currentStep++;
                            } else {
                                clearInterval(progressInterval);
                                setTimeout(() => {
                                    setUploadProgress(null);
                                    const mockFile = { url: URL.createObjectURL(file), name: file.name };
                                    handleSendMessage(mockFile);
                                }, 500);
                            }
                        }, 200);
                    }
                };
                input.click();
                setFabOpen(false);
            };

            const requestMicrophonePermission = async () => {
                try {
                    await navigator.mediaDevices.getUserMedia({ audio: true });
                    console.log('Permissão de microfone concedida');
                    return true;
                } catch (error) {
                    console.error('Permissão de microfone negada:', error);
                    alert('Para gravar áudio, é necessário permitir o acesso ao microfone. Por favor, clique em "Permitir" quando solicitado.');
                    return false;
                }
            };

            const handleRecordAudio = async () => {
                if (isRecording) {
                    if (mediaRecorder) {
                        mediaRecorder.stop();
                    }
                    setFabOpen(false);
                    return;
                }

                // Solicitar permissão primeiro
                const hasPermission = await requestMicrophonePermission();
                if (!hasPermission) {
                    return;
                }

                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    const recorder = new MediaRecorder(stream);
                    const audioChunks = [];
                    const startTime = Date.now();

                    const updateDuration = () => {
                        setRecordingDuration(Math.floor((Date.now() - startTime) / 1000));
                    };

                    const durationInterval = setInterval(updateDuration, 1000);

                    recorder.ondataavailable = (event) => {
                        audioChunks.push(event.data);
                    };

                    recorder.onstop = async () => {
                        clearInterval(durationInterval);
                        setRecordingDuration(0);
                        const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                        const mockAudio = { 
                            url: URL.createObjectURL(audioBlob), 
                            name: `audio_${Date.now()}.webm`, 
                            isAudio: true 
                        };
                        await handleSendMessage(mockAudio);
                        stream.getTracks().forEach(track => track.stop());
                        setIsRecording(false);
                        setMediaRecorder(null);
                    };

                    recorder.start();
                    setMediaRecorder(recorder);
                    setIsRecording(true);
                    setFabOpen(false);
                } catch (error) {
                    console.error('Erro ao gravar áudio:', error);
                    alert('Não foi possível acessar o microfone. Verifique as permissões do navegador.');
                    setIsRecording(false);
                }
            };

            const handleKeyPress = (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    handleSendMessage();
                }
            };

            const handleInputChange = (e) => {
                setInputText(e.target.value);
                updateTypingStatus(e.target.value.length > 0);
            };

            const toggleFab = () => {
                setFabOpen(!fabOpen);
                setShowThemeMenu(false);
                setShowFontMenu(false);
            };

            const changeTheme = (newTheme) => {
                setTheme(newTheme);
                setShowThemeMenu(false);
                setFabOpen(false);
            };

            const changeFontSize = (newSize) => {
                setFontSize(newSize);
                setShowFontMenu(false);
                setFabOpen(false);
            };

            // Inicialização do app
            React.useEffect(() => {
                const initializeApp = async () => {
                    console.log('Iniciando aplicação GPV Chat...');
                    
                    try {
                        // Tentar carregar dados da API com timeout
                        const [userSuccess, messagesSuccess] = await Promise.allSettled([
                            fetchUserData(),
                            fetchMessages()
                        ]);

                        console.log('Dados carregados:', {
                            usuario: userSuccess.status === 'fulfilled' && userSuccess.value,
                            mensagens: messagesSuccess.status === 'fulfilled' && messagesSuccess.value
                        });

                        // Iniciar verificação de status de digitação se possível
                        if (userSuccess.status === 'fulfilled') {
                            fetchTypingStatus();
                        }
                        
                    } catch (error) {
                        console.log('Erro durante inicialização, usando dados mock');
                    }

                    // Remover tela de loading
                    hideLoadingScreen();
                };

                initializeApp();

                // Intervalos para atualização mais rápida
                const messageInterval = setInterval(() => {
                    if (currentUserId) fetchMessages();
                }, 3000); // Reduzido de 10 para 3 segundos

                const typingInterval = setInterval(() => {
                    if (currentUserId) fetchTypingStatus();
                }, 2000); // Reduzido de 5 para 2 segundos

                return () => {
                    clearInterval(messageInterval);
                    clearInterval(typingInterval);
                    if (mediaRecorder) {
                        mediaRecorder.stop();
                    }
                };
            }, [currentUserId, hideLoadingScreen]);

            // Event listeners para clicks fora dos menus
            React.useEffect(() => {
                const handleClickOutside = (event) => {
                    if (!event.target.closest('.fab-container') && !event.target.closest('.fab-sub-menu')) {
                        setShowThemeMenu(false);
                        setShowFontMenu(false);
                        setFabOpen(false);
                    }
                };
                document.addEventListener('mousedown', handleClickOutside);
                return () => {
                    document.removeEventListener('mousedown', handleClickOutside);
                };
            }, []);

            return (
                <div className="chat-container">
                    <div className="chat-header">
                        <h1 className="text-lg font-bold">GPV Chat</h1>
                        <div className="flex items-center gap-2">
                            <span className="text-sm">{currentUser}</span>
                            <img 
                                src={userData?.PERFIL || defaultProfilePic} 
                                alt="User" 
                                className="w-8 h-8 rounded-full object-cover"
                            />
                        </div>
                    </div>

                    <div className="chat-messages">
                        {messages.map((msg) => (
                            <ChatMessage
                                key={msg.id}
                                id={msg.id}
                                usuario={msg.Usuario}
                                mensagem={msg.DIGIOTOU}
                                data={msg.DATAENVIO}
                                fotoPerfil={msg.FOTOPERFIL}
                                isRight={msg.Usuario === currentUser}
                                mensacao={msg.mensacao}
                                laughs={msg.laughs}
                                sads={msg.sads}
                                arquivosGravados={msg.ArquivosGravados}
                                quotedMsg={msg.quotedMsg}
                                enquete={msg.enquete}
                                citacao={msg.citacao}
                                onLike={likeMessage}
                                onLaugh={laughMessage}
                                onSad={sadMessage}
                                onQuote={setQuotedMessage}
                                onImageClick={handleImageClick}
                                onDelete={deleteMessage}
                                onVote={votePoll}
                            />
                        ))}
                        {typingUser && (
                            <TypingIndicator 
                                user={typingUser} 
                                avatar={typingUserData?.PERFIL || defaultProfilePic} 
                            />
                        )}
                        <div ref={messagesEndRef} />
                    </div>

                    <div className="chat-footer">
                        {isRecording && <RecordingAnimation duration={recordingDuration} />}
                        {uploadProgress !== null && <ProgressBar progress={uploadProgress} />}
                        {quotedMessage && (
                            <div className="quoted-preview">
                                <span>Citando {quotedMessage.usuario}:</span>
                                <p>{quotedMessage.mensagem?.substring(0, 50)}...</p>
                                <button onClick={() => setQuotedMessage(null)}>
                                    <i className="fas fa-times"></i>
                                </button>
                            </div>
                        )}
                        <div className="input-container">
                            <input
                                type="text"
                                className="chat-input"
                                placeholder="Digite uma mensagem..."
                                value={inputText}
                                onChange={handleInputChange}
                                onKeyPress={handleKeyPress}
                            />
                            <button
                                className={`send-button ${inputText.trim() ? 'visible' : ''}`}
                                onClick={() => handleSendMessage()}
                                disabled={!inputText.trim()}
                                title="Enviar mensagem"
                            >
                                <i className="fas fa-paper-plane"></i>
                            </button>
                            <div className="fab-container">
                                <button
                                    className={`fab-main ${fabOpen ? 'open' : ''}`}
                                    onClick={toggleFab}
                                    title="Mais opções"
                                >
                                    <i className="fas fa-plus"></i>
                                </button>
                                <div className={`fab-actions ${fabOpen ? 'open' : ''}`}>
                                    <button
                                        className={`fab-action ${isRecording ? 'recording' : ''}`}
                                        onClick={handleRecordAudio}
                                        title={isRecording ? 'Parar gravação' : 'Gravar áudio'}
                                        disabled={isRecording && !mediaRecorder}
                                    >
                                        <i className="fas fa-microphone"></i>
                                    </button>
                                    <button className="fab-action" onClick={handleUploadPhoto} title="Enviar foto">
                                        <i className="fas fa-camera"></i>
                                    </button>
                                    <button className="fab-action" onClick={() => setShowThemeMenu(!showThemeMenu)} title="Alterar tema">
                                        <i className="fas fa-palette"></i>
                                    </button>
                                    <button className="fab-action" onClick={() => setShowFontMenu(!showFontMenu)} title="Tamanho do texto">
                                        <i className="fas fa-text-height"></i>
                                    </button>
                                    <button className="fab-action" onClick={createPoll} title="Criar enquete">
                                        <i className="fas fa-poll"></i>
                                    </button>
                                    <button className="fab-action" onClick={deleteAllMessages} title="Apagar todas as mensagens">
                                        <i className="fas fa-trash-alt"></i>
                                    </button>
                                </div>
                                <div className={`fab-sub-menu ${showThemeMenu ? 'open' : ''}`}>
                                    <div className="fab-sub-menu-item" onClick={() => changeTheme('light')}>
                                        <i className="fas fa-sun"></i> Claro
                                    </div>
                                    <div className="fab-sub-menu-item" onClick={() => changeTheme('dark')}>
                                        <i className="fas fa-moon"></i> Escuro
                                    </div>
                                    <div className="fab-sub-menu-item" onClick={() => changeTheme('nature')}>
                                        <i className="fas fa-leaf"></i> Natureza
                                    </div>
                                </div>
                                <div className={`fab-sub-menu ${showFontMenu ? 'open' : ''}`}>
                                    <div className="fab-sub-menu-item" onClick={() => changeFontSize('small')}>Pequeno</div>
                                    <div className="fab-sub-menu-item" onClick={() => changeFontSize('medium')}>Médio</div>
                                    <div className="fab-sub-menu-item" onClick={() => changeFontSize('large')}>Grande</div>
                                    <div className="fab-sub-menu-item" onClick={() => changeFontSize('xlarge')}>Extra Grande</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    {fullscreenImage && (
                        <FullscreenImage src={fullscreenImage} onClose={closeFullscreenImage} />
                    )}
                </div>
            );
        };

        ReactDOM.render(<ChatApp />, document.getElementById('root'));
    </script>
</body>
</html>
