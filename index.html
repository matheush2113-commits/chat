<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Neon Pool 3D - TheuZ IA Edition</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary-color: #00f3ff; 
            --bg-color: #050505;
            --panel-bg: rgba(10, 15, 20, 0.95);
            --danger-color: #ff3333;
            --win-color: #ffd700;
            --bot-anger-color: #ff4500;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; user-select: none; -webkit-user-select: none; }
        
        html, body {
            height: 100%;
            overflow: hidden;
            touch-action: none; 
        }

        body {
            background-color: var(--bg-color);
            background-image: 
                radial-gradient(circle at 50% 50%, #151515, #000),
                linear-gradient(0deg, rgba(0, 243, 255, 0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(0, 243, 255, 0.03) 1px, transparent 1px);
            background-size: 100% 100%, 40px 40px, 40px 40px;
            font-family: 'Orbitron', sans-serif;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
        }

        .game-wrapper {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 2vh;
            width: 100%;
            max-width: 1400px; 
            padding: 1vh 2vw;
            height: 100vh;
            overflow: hidden;
        }

        .hud-panel {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 95vw;
            max-width: 1000px;
            background: var(--panel-bg);
            padding: 12px 25px;
            border-radius: 16px;
            border: 1px solid #333;
            border-bottom: 3px solid var(--primary-color);
            box-shadow: 0 0 25px rgba(0, 243, 255, 0.15);
            position: relative;
            z-index: 10;
        }

        .player-section {
            display: flex;
            align-items: center;
            gap: 15px;
            opacity: 0.4;
            transition: 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            filter: grayscale(100%);
            position: relative;
        }
        .player-section.active-turn { 
            opacity: 1; 
            transform: scale(1.05); 
            filter: grayscale(0%);
        }

        #p2-section.bot-angry .avatar-img {
            box-shadow: 0 0 15px 5px var(--bot-anger-color);
            transition: box-shadow 0.3s;
        }

        .avatar-container {
            position: relative;
            width: 64px; height: 64px;
            display: flex; align-items: center; justify-content: center;
        }
        .timer-svg {
            position: absolute; top: 0; left: 0;
            width: 64px; height: 64px;
            transform: rotate(-90deg);
        }
        .timer-circle-bg { fill: none; stroke: #222; stroke-width: 5; }
        .timer-circle-fg { 
            fill: none; stroke: var(--primary-color); stroke-width: 5; 
            stroke-dasharray: 175; 
            stroke-dashoffset: 0;
            transition: stroke-dashoffset 0.1s linear, stroke 0.3s;
            stroke-linecap: round;
        }

        .avatar-img {
            width: 50px; height: 50px;
            border-radius: 50%;
            background-size: cover; background-position: center;
            border: 2px solid #fff;
            z-index: 2;
            box-shadow: 0 0 10px rgba(255,255,255,0.3);
        }

        .chat-btn {
            position: absolute;
            bottom: 0px; 
            right: 0px; 
            width: 24px; height: 24px;
            border-radius: 50%;
            background: rgba(0, 243, 255, 0.9);
            border: 2px solid var(--bg-color);
            display: flex; align-items: center; justify-content: center;
            cursor: pointer;
            z-index: 5;
            transition: 0.2s;
            box-shadow: 0 0 10px rgba(0, 243, 255, 0.5);
        }
        .chat-btn:hover { background: var(--primary-color); transform: scale(1.1); }
        .chat-btn svg { width: 14px; height: 14px; fill: #000; }
        
        #p2-section .chat-btn {
            left: 0px; 
            right: auto;
            background: var(--bot-anger-color);
            box-shadow: 0 0 10px rgba(255, 69, 0, 0.5);
        }

        .p-info { display: flex; flex-direction: column; }
        .p-name { font-weight: 900; font-size: 14px; letter-spacing: 1px; color: #fff; text-shadow: 0 0 5px var(--primary-color); }
        .p-type { font-size: 10px; color: #aaa; margin-top: 3px; font-weight: bold; }
        .win-counter { font-size: 10px; color: var(--win-color); font-weight: bold; margin-top: 4px; text-shadow: 0 0 5px rgba(255, 215, 0, 0.5); }

        .score-dots { display: flex; gap: 5px; margin-top: 6px; }
        .dot { width: 8px; height: 8px; background: #222; border-radius: 50%; border: 1px solid #444; transition: 0.3s; }
        .dot.active { background: var(--primary-color); border-color: #fff; box-shadow: 0 0 8px var(--primary-color); transform: scale(1.2); }

        .main-area {
            display: flex;
            gap: 3vw;
            justify-content: center;
            width: 100%;
            flex-grow: 1; 
        }

        .table-wrapper {
            position: relative;
            aspect-ratio: 1.743 / 1; 
            max-width: 1000px;
            align-self: center;
            width: clamp(300px, 85vw, 1000px); 
            height: auto; 
        }

        #game-container {
            position: absolute;
            inset: 0;
            width: 100%;
            height: 100%;
            padding: calc(30 / 680 * 100%);
            background: #0b0b0b;
            border-radius: calc(35 / 680 * 100%);
            box-shadow: 
                0 0 0 2px #222, 
                0 20px 50px rgba(0,0,0,0.8), 
                inset 0 0 60px rgba(0,0,0,0.9);
            overflow: hidden;
        }

        #game-inner {
            position: relative; width: 100%; height: 100%;
            border-radius: calc(16 / 620 * 100%);
            overflow: hidden; background: #000; 
            border: 4px solid #1a1a1a;
            box-shadow: inset 0 0 20px #000;
        }
        
        canvas { position: absolute; top: 0; left: 0; }
        #input-layer { position: absolute; inset: 0; z-index: 100; cursor: crosshair; }
        #three-canvas { pointer-events: none; z-index: 2; }
        #fx-canvas { pointer-events: none; z-index: 3; }

        .side-controls {
            display: flex; flex-direction: column; gap: 12px; padding: 15px;
            background: var(--panel-bg); border-radius: 16px; border: 1px solid #333;
            height: 100%; justify-content: center; align-items: center; position: relative;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
            width: 12vw;
            max-width: 150px; 
        }

        .btn-neon {
            width: 60px; height: 60px; background: rgba(255,255,255,0.02);
            border: 1px solid rgba(255,255,255,0.1); border-radius: 12px;
            cursor: pointer; display: flex; flex-direction: column; align-items: center; justify-content: center;
            color: var(--primary-color); transition: all 0.2s; position: relative; overflow: hidden;
        }
        .btn-neon:hover { background: rgba(0, 243, 255, 0.1); border-color: var(--primary-color); box-shadow: 0 0 15px var(--primary-color); transform: translateY(-2px); }
        .btn-neon:active { transform: scale(0.95); }
        .btn-neon svg { width: 22px; height: 22px; fill: currentColor; margin-bottom: 4px; }
        .btn-neon span { font-size: 8px; font-weight:900; text-transform:uppercase; letter-spacing:1px; }

        #spin-popover {
            position: absolute; top: 10px; right: 90px;
            width: 120px; height: 140px; background: rgba(10, 12, 16,0.98);
            border: 1px solid var(--primary-color); border-radius: 12px;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            opacity: 0; visibility: hidden; transition: 0.3s; z-index: 200;
            box-shadow: 0 0 20px rgba(0,0,0,0.8);
            transform: scale(0.8);
        }
        #spin-popover.visible { opacity: 1; visibility: visible; transform: scale(1); right: 80px;}
        .spin-ball { width: 80px; height: 80px; background: radial-gradient(circle at 35% 35%, #fff, #ddd, #888); border-radius: 50%; margin-top: 8px; cursor: pointer; position: relative; box-shadow: inset 0 -5px 10px rgba(0,0,0,0.5); }
        #spin-dot { width: 10px; height: 10px; background: #ff3333; border-radius: 50%; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); box-shadow: 0 0 5px #ff3333; pointer-events: none;}
        #bot-spin-dot { width: 10px; height: 10px; background: #33ff33; border-radius: 50%; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); box-shadow: 0 0 5px #33ff33; pointer-events: none; opacity: 0;}

        #taunt-popover {
            position: absolute; top: 80px; left: 90px;
            width: 200px; background: rgba(10, 12,16,0.98);
            border: 1px solid var(--primary-color); border-radius: 12px;
            padding: 12px;
            display: flex; flex-wrap: wrap; gap: 6px;
            opacity: 0; visibility: hidden; transition: 0.3s; z-index: 200;
            box-shadow: 0 0 20px rgba(0,0,0,0.8);
            transform: scale(0.8);
        }
        #taunt-popover.visible { opacity: 1; visibility: visible; transform: scale(1); left: 80px;}

        .taunt-btn {
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            padding: 6px 8px; border-radius: 8px;
            font-size: 10px; color: var(--primary-color);
            cursor: pointer; flex: 1 1 45%;
            text-align: center;
            transition: 0.2s;
            font-weight: 700;
        }
        .taunt-btn:hover { background: rgba(0, 243, 255, 0.2); transform: scale(1.05); }
        .taunt-btn-emoji { font-size: 20px; line-height: 1; padding: 4px; }

        #ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 150; pointer-events: none; display: flex; justify-content: center; align-items: flex-start; padding-top: 150px;}
        .toast {
            background: rgba(0,0,0,0.9); color: #fff; padding: 8px 20px;
            border: 1px solid var(--primary-color); border-radius: 50px;
            font-size: 16px;
            font-weight: 900; text-transform: uppercase; letter-spacing: 2px;
            opacity: 0; transition: 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); transform: scale(0.5);
            box-shadow: 0 0 20px var(--primary-color), inset 0 0 10px rgba(0, 243, 255, 0.2);
            text-shadow: 0 0 5px var(--primary-color);
            text-align: center; margin-bottom: 10px;
            align-self: center;
        }
        .toast.show { opacity: 1; transform: scale(1); }
        .toast.bad { border-color: #ff3333; box-shadow: 0 0 20px #ff3333; text-shadow: 0 0 5px #ff3333; color: #ff3333; }
        .toast.taunt { border-color: #ffd700; box-shadow: 0 0 20px #ffd700; text-shadow: 0 0 5px #ffd700; color: #ffd700; }

        .chat-bubble {
            position: absolute; top: 60px; 
            background: #fff; color: #000; padding: 8px 12px; 
            border-radius: 16px; font-size: 14px; font-weight: bold;
            opacity: 0; transform: 0.3s;
            z-index: 20; box-shadow: 0 5px 15px rgba(0,0,0,0.5); pointer-events: none;
            max-width: 180px; 
            text-align: center;
        }
        .chat-bubble.show { opacity: 1; transform: translateY(0); }
        #p1-bubble { left: 10px; border-top-left-radius: 0; }
        #p2-bubble { right: 10px; left: auto; border-top-right-radius: 0; }

        /* RESPONSIVO MELHORADO */
        @media (max-width: 768px) {
            .game-wrapper { justify-content: flex-start; }
            .main-area { flex-direction: column; gap: 2vh; }
            .table-wrapper { width: 98vw; max-height: 58vh; }
            .side-controls { flex-direction: row; gap: 8vw; height: auto; padding: 10px 0; width: 98vw; }
            .btn-neon { width: 15vw; height: 15vw; max-width: 60px; max-height: 60px; }
            #spin-popover { width: 30vw; height: 35vw; top: auto; bottom: 100px; }
            #spin-popover.visible { right: 50%; transform: translateX(50%) scale(1); }
            #taunt-popover { width: 70vw; top: auto; bottom: 100px; }
            #taunt-popover.visible { left: 50%; transform: translateX(-50%) scale(1); }
            .taunt-btn { font-size: 9px; }
        }

        @media (orientation: landscape) {
            .main-area { flex-direction: row; }
            .table-wrapper { 
                width: 80vw; 
                max-width: 1100px;
                max-height: 90vh;
            }
            .side-controls { 
                width: auto; 
                height: 80vh; 
                flex-direction: column;
            }
            .hud-panel { width: 90vw; }
        }
    </style>
</head>
<body>

    <div class="game-wrapper">
        <div class="hud-panel">
            <div class="player-section active-turn" id="p1-section">
                <div id="taunt-popover">
                    <button class="taunt-btn" onclick="tauntPlayer(1,'S√≥ isso que voc√™ sabe fazer?')">S√≥ isso que voc√™ sabe fazer?</button>
                    <button class="taunt-btn" onclick="tauntPlayer(1,'TheuZ, voc√™ √© p√©ssimo!')">TheuZ, voc√™ √© p√©ssimo!</button>
                    <button class="taunt-btn" onclick="tauntPlayer(1,'Vai chorar pro servidor?')">Vai chorar pro servidor?</button>
                    <button class="taunt-btn" onclick="tauntPlayer(1,'Meu cachorro joga melhor')">Meu cachorro joga melhor</button>
                    <button class="taunt-btn" onclick="tauntPlayer(1,'Errou feio, errou rude')">Errou feio, errou rude</button>
                    <button class="taunt-btn" onclick="tauntPlayer(1,'T√° com medo de perder?')">T√° com medo de perder?</button>
                    <button class="taunt-btn" onclick="tauntPlayer(1,'Vou te humilhar em 4K')">Vou te humilhar em 4K</button>
                    <button class="taunt-btn" onclick="tauntPlayer(1,'Voc√™ √© uma vergonha pra IA')">Vergonha pra IA</button>
                    <button class="taunt-btn taunt-btn-emoji" onclick="tauntPlayer(1,'ü§°')">ü§°</button>
                    <button class="taunt-btn taunt-btn-emoji" onclick="tauntPlayer(1,'üóëÔ∏è')">üóëÔ∏è</button>
                    <button class="taunt-btn taunt-btn-emoji" onclick="tauntPlayer(1,'üí©')">üí©</button>
                    <button class="taunt-btn taunt-btn-emoji" onclick="tauntPlayer(1,'üòπ')">üòπ</button>
                    <button class="taunt-btn taunt-btn-emoji" onclick="tauntPlayer(1,'ü§è')">ü§è</button>
                    <button class="taunt-btn taunt-btn-emoji" onclick="tauntPlayer(1,'üçº')">üçº</button>
                </div>

                <div class="avatar-container">
                    <svg class="timer-svg">
                        <circle class="timer-circle-bg" cx="32" cy="32" r="28"></circle>
                        <circle id="p1-timer" class="timer-circle-fg" cx="32" cy="32" r="28"></circle>
                    </svg>
                    <div class="avatar-img" style="background-image: url('https://api.dicebear.com/7.x/avataaars/svg?seed=King');"></div>
                    <div class="chat-btn" onclick="toggleTauntMenu(event)">
                        <svg viewBox="0 0 24 24"><path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm-2 12H6v-2h12v2zm0-3H6V9h12v2zm0-3H6V6h12v2z"/></svg>
                    </div>
                </div>
                <div class="p-info">
                    <span class="p-name">VOC√ä</span>
                    <span class="p-type" id="p1-type-label">--</span>
                    <div class="win-counter" id="p1-wins-display">VIT√ìRIAS: 0</div>
                    <div class="score-dots" id="p1-score"></div>
                </div>
                <div class="chat-bubble" id="p1-bubble"></div>
            </div>

            <div style="font-size: 24px; font-weight:900; opacity: 0.2; font-style: italic;">VS</div>

            <div class="player-section" id="p2-section">
                <div class="chat-bubble" id="p2-bubble"></div>
                <div class="p-info" style="align-items: flex-end;">
                    <span class="p-name">THEUZ IA</span> <span class="p-type" id="p2-type-label">--</span>
                    <div class="win-counter" id="p2-wins-display">VIT√ìRIAS: 0</div>
                    <div class="score-dots" id="p2-score"></div>
                </div>
                <div class="avatar-container">
                    <svg class="timer-svg">
                        <circle class="timer-circle-bg" cx="32" cy="32" r="28"></circle>
                        <circle id="p2-timer" class="timer-circle-fg" cx="32" cy="32" r="28"></circle>
                    </svg>
                    <div class="avatar-img" style="background-image: url('https://api.dicebear.com/7.x/bottts/svg?seed=Terminator');"></div>
                    <div class="chat-btn">
                        <svg viewBox="0 0 24 24"><path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm-2 12H6v-2h12v2zm0-3H6V9h12v2zm0-3H6V6h12v2z"/></svg>
                    </div>
                </div>
            </div>
        </div>

        <div class="main-area">
            <div class="table-wrapper">
                <div id="game-container">
                    <div id="game-inner">
                        <canvas id="table-canvas"></canvas>
                        <canvas id="fx-canvas"></canvas>
                        <div id="input-layer"></div>
                    </div>
                    <div id="ui-layer">
                        <div id="game-toast" class="toast"></div>
                    </div>
                </div>
            </div>

            <div class="side-controls">
                <div id="spin-popover">
                    <span style="font-size:9px; color:#aaa; margin-bottom:5px;">PONTO DE BATIDA</span>
                    <div class="spin-ball" id="spin-control">
                        <div id="spin-dot"></div>
                        <div id="bot-spin-dot"></div>
                        <div style="position:absolute; top:50%; left:0; width:100%; height:1px; background:rgba(0,0,0,0.2);"></div>
                        <div style="position:absolute; top:0; left:50%; width:1px; height:100%; background:rgba(0,0,0,0.2);"></div>
                    </div>
                </div>

                <button class="btn-neon" onclick="toggleSpinMenu()">
                    <svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8z"/><circle cx="12" cy="12" r="3"/></svg>
                    <span>Efeito</span>
                </button>

                <button class="btn-neon" onclick="cycleTheme()">
                    <svg viewBox="0 0 24 24"><path d="M12 3c-4.97 0-9 4.03-9 9s4.03 9 9 9c.83 0 1.5-.67 1.5-1.5 0-.39-.15-.74-.39-1.01-.23-.26-.38-.61-.38-.99 0-.83.67-1.5 1.5-1.5H16c2.76 0 5-2.24 5-5 0-4.42-4.03-8-9-8zm-5.5 9c-.83 0-1.5-.67-1.5-1.5S5.67 9 6.5 9 8 9.67 8 10.5 7.33 12 6.5 12zm3-4C8.67 8 8 7.33 8 6.5S8.67 5 9.5 5s1.5.67 1.5 1.5S10.33 8 9.5 8zm5 0c-.83 0-1.5-.67-1.5-1.5S13.67 5 14.5 5s1.5.67 1.5 1.5S15.33 8 14.5 8zm3 4c-.83 0-1.5-.67-1.5-1.5S16.67 9 17.5 9s1.5.67 1.5 1.5-.67 1.5-1.5 1.5z"/></svg>
                    <span>Tema</span>
                </button>

                <div style="flex-grow:1;"></div>

                <button class="btn-neon" onclick="manualReset()" style="color:#ff4757; border-color:rgba(255,71,87,0.3)">
                    <svg viewBox="0 0 24 24"><path d="M12 5V1L7 6l5 5V7c3.31 0 6 2.69 6 6 0 1.1-.27 2.12-.74 3.02l1.53 1.53C19.65 16.17 20 14.14 20 12c0-4.42-3.58-8-8-8zm-5.47 2.47l1.53 1.53C7.27 9.88 7 10.9 7 12c0 3.31 2.69 6 6 6v-4l5 5-5 5v-4c-4.42 0-8-3.58-8-8 0-2.14.35-4.17.96-5.99z"/></svg>
                    <span>Reiniciar</span>
                </button>
            </div>
        </div>
    </div>

<script>
    const WIDTH = 620;       
    const HEIGHT = 330;      
    const BALL_RADIUS = 10;
    const POCKET_RADIUS = 24;
    const TABLE_MARGIN = 30;

    let p1Wins = 0;
    let p2Wins = 0;

    const MAX_DRAG_DISTANCE = 100;
    const POWER_MULTIPLIER = 0.35;
    const MAX_POWER = MAX_DRAG_DISTANCE * POWER_MULTIPLIER; 

    const THEMES = [
        { primary: '#00f3ff', feltStart: '#081015', feltEnd: '#000000', lightColor: 0x00f3ff },
        { primary: '#39ff14', feltStart: '#051005', feltEnd: '#000500', lightColor: 0x39ff14 },
        { primary: '#ff0099', feltStart: '#051005', feltEnd: '#050005', lightColor: 0xff0099 },
        { primary: '#ffae00', feltStart: '#151005', feltEnd: '#050200', lightColor: 0xffae00 }
    ];
    let currentThemeIdx = 0;
    function getTheme() { return THEMES[currentThemeIdx]; }

    const BALL_COLORS = [
        0xffffff, // 0 - Cue
        0xffd700, 0x0044ff, 0xff3333, 0x800080, 0xff8800, 0x008800, 0x880000, // 1-7
        0x111111, // 8
        0xffd700, 0x0044ff, 0xff3333, 0x800080, 0xff8800, 0x008800, 0x880000  // 9-15
    ];

    const scene = new THREE.Scene();
    const camera = new THREE.OrthographicCamera(WIDTH/-2, WIDTH/2, HEIGHT/2, HEIGHT/-2, 1, 1000);
    camera.position.z = 500;

    const renderer = new THREE.WebGLRenderer({ alpha: true, antialias: true });
    renderer.domElement.id = "three-canvas";
    document.getElementById('game-inner').appendChild(renderer.domElement);

    const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
    scene.add(ambientLight);
    const themeLight = new THREE.PointLight(getTheme().lightColor, 0.6, 500);
    themeLight.position.set(0, 0, 150);
    scene.add(themeLight);

    function createBallTexture(n, colorHex) {
        const canvas = document.createElement('canvas');
        canvas.width = 128; canvas.height = 64;
        const ctx = canvas.getContext('2d');
        const w = canvas.width, h = canvas.height;
        const color = '#' + new THREE.Color(colorHex).getHexString();

        if (n === 0) { 
            ctx.fillStyle = '#eeeeee'; ctx.fillRect(0,0,w,h);
            ctx.fillStyle = '#cc0000'; ctx.beginPath(); ctx.arc(w/2, h/2, 4, 0, Math.PI*2); ctx.fill();
        } else if (n === 8) {
            ctx.fillStyle = '#151515'; ctx.fillRect(0,0,w,h);
        } else if (n < 9) {
            ctx.fillStyle = color; ctx.fillRect(0,0,w,h);
        } else {
            ctx.fillStyle = '#eeeeee'; ctx.fillRect(0,0,w,h);
            ctx.fillStyle = color; ctx.fillRect(0, h/4, w, h/2);
        }

        if (n > 0) {
            ctx.fillStyle = 'white'; ctx.beginPath(); ctx.arc(w/4, h/2, 14, 0, Math.PI*2); ctx.fill();
            ctx.beginPath(); ctx.arc(w*0.75, h/2, 14, 0, Math.PI*2); ctx.fill();
            ctx.font = 'bold 16px Arial'; ctx.textAlign = 'center'; ctx.textBaseline = 'middle'; ctx.fillStyle = 'black';
            ctx.fillText(n, w/4, h/2+2); ctx.fillText(n, w*0.75, h/2+2);
        }
        return new THREE.CanvasTexture(canvas);
    }

    class Ball {
        constructor(x, y, number) {
            this.x = x; this.y = y;
            this.vx = 0; this.vy = 0;
            this.number = number;
            this.radius = BALL_RADIUS;
            this.active = true;
            this.falling = false;
            this.isCue = (number === 0);
            this.isEight = (number === 8);
            this.isSolid = (number > 0 && number < 8);
            this.isStripe = (number > 8);
            
            const geo = new THREE.SphereGeometry(this.radius, 32, 32);
            const mat = new THREE.MeshPhongMaterial({ 
                map: createBallTexture(number, BALL_COLORS[number]), 
                shininess: 150,
                specular: 0x444444
            });
            this.mesh = new THREE.Mesh(geo, mat);
            scene.add(this.mesh);
            this.updateMeshPosition();
        }

        update() {
            if (!this.active && !this.falling) { this.mesh.visible = false; return; }
            this.mesh.visible = true;

            if (this.falling) { 
                this.fallAnimation(); 
                return; 
            }

            let friction = 0.986;
            let currentSpin = this.isCue ? (gameState.turn === 1 ? gameState.playerSpin : gameState.botSpin) : {x:0,y:0};

            if (this.isCue && Math.abs(currentSpin.y) > 0.1) friction += currentSpin.y * 0.002; 
            
            this.vx *= friction; this.vy *= friction;
            
            if (Math.abs(this.vx) < 0.03) this.vx = 0;
            if (Math.abs(this.vy) < 0.03) this.vy = 0;

            this.x += this.vx; 
            this.y += this.vy;

            let hitWall = false;
            if (this.x < TABLE_MARGIN + this.radius) { this.x = TABLE_MARGIN + this.radius; this.vx *= -0.9; hitWall=true; }
            if (this.x > WIDTH - TABLE_MARGIN - this.radius) { this.x = WIDTH - TABLE_MARGIN - this.radius; this.vx *= -0.9; hitWall=true; }
            if (this.y < TABLE_MARGIN + this.radius) { this.y = TABLE_MARGIN + this.radius; this.vy *= -0.9; hitWall=true; }
            if (this.y > HEIGHT - TABLE_MARGIN - this.radius) { this.y = HEIGHT - TABLE_MARGIN - this.radius; this.vy *= -0.9; hitWall=true; }
            
            if(hitWall && this.isCue) { 
                if(Math.abs(this.vx)>0.5) this.vy += currentSpin.x * 0.8; 
                currentSpin.x *= 0.5;
            }

            getPockets().forEach(p => {
                let dx = this.x - p.x, dy = this.y - p.y;
                if (dx*dx + dy*dy < POCKET_RADIUS**2) {
                    this.falling = true; 
                    this.active = false; 
                    this.pocketTarget = {x:p.x, y:p.y};
                    gameState.pocketedThisTurn.push(this);
                }
            });

            this.updateMeshPosition();
            this.updateRotation();
        }

        fallAnimation() {
            this.x += (this.pocketTarget.x - this.x) * 0.25;
            this.y += (this.pocketTarget.y - this.y) * 0.25;
            const scale = this.mesh.scale.x * 0.85;
            this.mesh.scale.set(scale, scale, scale);
            this.mesh.rotation.x += 0.3; 
            this.mesh.rotation.y += 0.3;
            this.updateMeshPosition();
            
            if (scale < 0.1) {
                this.falling = false; 
                this.mesh.visible = false; 
                this.mesh.scale.set(1,1,1);
                spawnExplosion(this.pocketTarget.x, this.pocketTarget.y, getTheme().primary);
            }
        }

        updateMeshPosition() {
            this.mesh.position.x = this.x - WIDTH / 2;
            this.mesh.position.y = -(this.y - HEIGHT / 2);
            this.mesh.position.z = 0;
        }

        updateRotation() {
            const v = Math.sqrt(this.vx**2 + this.vy**2);
            if (v > 0.01) {
                const axis = new THREE.Vector3(-this.vy, this.vx, 0).normalize();
                const q = new THREE.Quaternion().setFromAxisAngle(axis, v/this.radius);
                this.mesh.quaternion.multiplyQuaternions(q, this.mesh.quaternion);
            }
        }
    }

    function getPockets() {
        return [
            {x: TABLE_MARGIN+2, y: TABLE_MARGIN+2}, 
            {x: WIDTH/2, y: TABLE_MARGIN-5}, 
            {x: WIDTH-TABLE_MARGIN-2, y: TABLE_MARGIN+2},
            {x: TABLE_MARGIN+2, y: HEIGHT-TABLE_MARGIN-2}, 
            {x: WIDTH/2, y: HEIGHT-TABLE_MARGIN+5}, 
            {x: WIDTH-TABLE_MARGIN-2, y: HEIGHT-TABLE_MARGIN-2}
        ];
    }

    const ctx2D = document.getElementById('table-canvas').getContext('2d');
    const ctxFX = document.getElementById('fx-canvas').getContext('2d');
    const inputLayer = document.getElementById('input-layer');
    
    let balls = [], cueBall, particles = [];
    let gameState = {
        turn: 1, 
        p1Type: null, 
        p2Type: null,
        isMoving: false, 
        isDragging: false,
        dragStart: {x:0, y:0}, 
        dragCurrent: {x:0, y:0},
        power: 0, 
        angle: 0,
        pocketedThisTurn: [], 
        gameOver: false, 
        ballInHand: false, 
        playerSpin: {x:0, y:0}, 
        botSpin: {x:0, y:0}     
    };

    let botState = {
        phase: 'idle',
        targetBall: null,
        aimAngle: 0,
        aimPower: 0,
        scanLines: [],
        aimTargetAngle: 0, 
        aimTargetPower: 0, 
        timer: 0,
        angerLevel: 0,
        currentScanTarget: 0,
        scanTargets: [],
        aimMode: 'direct'
    };

    let turnTimer = null;
    let timeLeft = 30;
    const MAX_TIME = 30;

    function startTimer() {
        clearInterval(turnTimer);
        timeLeft = MAX_TIME;
        updateTimerVisuals();
        if(gameState.gameOver) return;
        turnTimer = setInterval(() => {
            if (gameState.turn === 2 && botState.phase !== 'idle' && botState.phase !== 'scanning') return; 
            timeLeft -= 0.1;
            updateTimerVisuals();
            if (timeLeft <= 0) { clearInterval(turnTimer); handleTimeOut(); }
        }, 100);
    }

    function updateTimerVisuals() {
        const p1 = document.getElementById('p1-timer'), p2 = document.getElementById('p2-timer');
        const offset = 175 - (175 * (timeLeft / MAX_TIME));
        if(gameState.turn === 1) {
            p1.style.strokeDashoffset = offset; p2.style.strokeDashoffset = 175;
            p1.style.stroke = timeLeft < 5 ? '#ff3333' : getTheme().primary;
        } else {
            p2.style.strokeDashoffset = offset; p1.style.strokeDashoffset = 175;
            p2.style.stroke = timeLeft < 5 ? '#ff3333' : '#ff4757';
        }
    }

    function handleTimeOut() {
        showToast("TEMPO ESGOTADO!", true);
        tauntBotAutomatic(1, 'üí§');
        gameState.ballInHand = true;
        gameState.turn = gameState.turn === 1 ? 2 : 1;
        updateHUD();
        if(gameState.turn === 2) setTimeout(initBotTurn, 1000); else startTimer();
    }

    function drawTable2D() {
        ctx2D.clearRect(0, 0, WIDTH, HEIGHT); 
        ctxFX.clearRect(0, 0, WIDTH, HEIGHT);
        
        const theme = getTheme();

        const grad = ctx2D.createRadialGradient(WIDTH/2, HEIGHT/2, 50, WIDTH/2, HEIGHT/2, WIDTH*0.8);
        grad.addColorStop(0, theme.feltStart); 
        grad.addColorStop(1, theme.feltEnd);
        ctx2D.fillStyle = grad; 
        ctx2D.fillRect(TABLE_MARGIN, TABLE_MARGIN, WIDTH-TABLE_MARGIN*2, HEIGHT-TABLE_MARGIN*2);

        getPockets().forEach(p => {
            ctx2D.fillStyle = "#000"; 
            ctx2D.beginPath(); ctx2D.arc(p.x, p.y, POCKET_RADIUS, 0, Math.PI*2); ctx2D.fill();
            
            ctx2D.shadowColor = theme.primary; ctx2D.shadowBlur = 10;
            ctx2D.strokeStyle = theme.primary; ctx2D.lineWidth = 2; 
            ctx2D.beginPath(); ctx2D.arc(p.x, p.y, POCKET_RADIUS-2, 0, Math.PI*2); ctx2D.stroke();
            ctx2D.shadowBlur = 0;
        });

        if (gameState.turn === 1 && !gameState.isMoving && !gameState.ballInHand) {
            if (gameState.isDragging || gameState.power > 0) { 
                
                const aimData = calculateAimTrajectory(cueBall, gameState.angle);
                
                // COR DA MIRA VERMELHA SE BOLA ERRADA
                let aimColor = getTheme().primary;
                if (aimData.target && gameState.p1Type !== null) {
                    const mySolid = gameState.p1Type === 'solids';
                    if (aimData.target.isEight) {
                        const myRemaining = balls.filter(b => b.active && !b.isCue && !b.isEight && (mySolid ? b.isSolid : b.isStripe)).length;
                        if (myRemaining > 0) aimColor = '#ff3333';
                    } else if (mySolid !== aimData.target.isSolid) {
                        aimColor = '#ff3333';
                    }
                }
                
                drawAimLines(cueBall, aimData, aimColor, false);

                const powerPct = Math.min(gameState.power / MAX_POWER, 1);
                const startAngle = -Math.PI / 2;
                const endAngle = startAngle + (Math.PI * 2 * powerPct);
                
                let pColor = '#39ff14';
                if(powerPct > 0.5) pColor = '#ffff00';
                if(powerPct > 0.8) pColor = '#ff0000';

                ctxFX.beginPath();
                ctxFX.arc(cueBall.x, cueBall.y, BALL_RADIUS + 12, startAngle, endAngle, false);
                ctxFX.lineWidth = 4;
                ctxFX.lineCap = 'round';
                ctxFX.strokeStyle = pColor;
                ctxFX.shadowColor = pColor;
                ctxFX.shadowBlur = 15;
                ctxFX.stroke();
                ctxFX.shadowBlur = 0;

                drawCueStick(cueBall.x, cueBall.y, gameState.angle, -20 - (gameState.power * 0.5));
            }
        }

        if (gameState.turn === 2 && !gameState.isMoving) {
            if(botState.phase === 'aiming' || botState.phase === 'shooting') {
                botState.aimAngle = lerpAngle(botState.aimAngle, botState.aimTargetAngle, 0.08);
                botState.aimPower = lerp(botState.aimPower, botState.aimTargetPower, 0.15); 
            }

            if (botState.phase === 'scanning' && botState.scanLines.length > 0) {
                botState.scanLines.forEach(line => {
                    ctxFX.beginPath();
                    ctxFX.moveTo(cueBall.x, cueBall.y);
                    ctxFX.lineTo(line.tx, line.ty);
                    ctxFX.strokeStyle = 'rgba(255, 255, 255, 0.2)';
                    ctxFX.setLineDash([5, 10]);
                    ctxFX.lineWidth = 1;
                    ctxFX.stroke();
                    ctxFX.setLineDash([]);
                });
            }
            
            if ((botState.phase === 'aiming' || botState.phase === 'shooting') && botState.targetBall) {
                const aimData = calculateAimTrajectory(cueBall, botState.aimAngle);
                
                if(botState.aimMode === 'bank') {
                    const pocket = botState.finalChoice.pocket;
                    const wallPoint = botState.finalChoice.wallPoint;
                    ctxFX.beginPath(); 
                    ctxFX.moveTo(cueBall.x, cueBall.y);
                    ctxFX.lineTo(wallPoint.x, wallPoint.y);
                    ctxFX.lineWidth = 2; 
                    ctxFX.setLineDash([4, 4]); 
                    ctxFX.strokeStyle = '#ff3333';
                    ctxFX.shadowColor = '#ff3333'; 
                    ctxFX.shadowBlur = 10; 
                    ctxFX.stroke(); 
                    
                    ctxFX.beginPath(); 
                    ctxFX.moveTo(wallPoint.x, wallPoint.y);
                    ctxFX.lineTo(pocket.x, pocket.y);
                    ctxFX.lineWidth = 2; 
                    ctxFX.setLineDash([4, 4]); 
                    ctxFX.strokeStyle = '#ff3333';
                    ctxFX.shadowColor = '#ff3333'; 
                    ctxFX.shadowBlur = 10; 
                    ctxFX.stroke(); 
                    ctxFX.shadowBlur = 0; 
                    ctxFX.setLineDash([]);
                } else {
                   drawAimLines(cueBall, aimData, '#ff3333', true);
                }

                const powerPct = Math.min(botState.aimPower / MAX_POWER, 1);
                ctxFX.beginPath();
                ctxFX.arc(cueBall.x, cueBall.y, BALL_RADIUS + 12, -Math.PI/2, -Math.PI/2 + (Math.PI*2*powerPct));
                ctxFX.lineWidth = 4; ctxFX.strokeStyle = '#ff3333'; ctxFX.stroke();

                drawCueStick(cueBall.x, cueBall.y, botState.aimAngle, -20 - (botState.aimPower * 0.5));
            }
        }

        if (gameState.ballInHand && gameState.turn === 1) {
            const time = Date.now() * 0.005;
            const pulse = 1 + Math.sin(time) * 0.1;
            
            ctxFX.save();
            ctxFX.translate(cueBall.x, cueBall.y);
            ctxFX.scale(pulse, pulse);
            
            ctxFX.beginPath();
            ctxFX.arc(0, 0, BALL_RADIUS * 2.5, 0, Math.PI*2);
            ctxFX.strokeStyle = theme.primary;
            ctxFX.lineWidth = 2;
            ctxFX.setLineDash([5, 5]);
            ctxFX.stroke();
            
            ctxFX.fillStyle = "#fff";
            ctxFX.font = "bold 10px Orbitron";
            ctxFX.textAlign = "center";
            ctxFX.fillText("ARRASTE", 0, -25);
            
            ctxFX.restore();
        }

        for(let i=particles.length-1; i>=0; i--) {
            let p = particles[i]; 
            p.x += p.vx; p.y += p.vy; p.life -= 0.04;
            if(p.life<=0) { particles.splice(i,1); continue; }
            ctxFX.fillStyle = p.color; 
            ctxFX.globalAlpha = p.life;
            ctxFX.beginPath(); ctxFX.arc(p.x, p.y, p.size, 0, Math.PI*2); ctxFX.fill(); 
            ctxFX.globalAlpha = 1;
        }
    }

    // ... (todas as outras fun√ß√µes permanecem iguais at√© o final, apenas com as corre√ß√µes acima)

    // TAUNTS AMPLIADOS
    const BOT_TAUNTS = [
        'S√≥ isso que voc√™ sabe fazer, humano?',
        'TheuZ √© perfeito. Voc√™ n√£o.',
        'Meu processador t√° rindo de voc√™',
        'Erro cr√≠tico na sua mira',
        'Vou te resetar pra f√°brica',
        'Sua jogada foi uma piada',
        'Meu cachorro joga melhor que isso',
        'Voc√™ √© uma desonra para os humanos',
        'Pat√©tico',
        'EZ',
        'Pr√≥ximo',
        'üòà',
        'ü§°',
        'üóëÔ∏è',
        'üí©',
        'üçº'
    ];

    function toggleTauntMenu(e) { 
        e.stopPropagation();
        if(gameState.turn !== 1 || gameState.isMoving || gameState.ballInHand) return;
        const popover = document.getElementById('taunt-popover');
        popover.classList.toggle('visible');
    }

    function tauntPlayer(player, msg) {
        if(player === 1) {
            document.getElementById('taunt-popover').classList.remove('visible');
            showBubble(1, msg);
            
            botState.angerLevel = Math.min(100, botState.angerLevel + 28);
            document.getElementById('p2-section').classList.add('bot-angry');
            
            setTimeout(() => {
                const botMsg = BOT_TAUNTS[Math.floor(Math.random() * BOT_TAUNTS.length)];
                showBubble(2, botMsg);
            }, 800);
        }
    }

    // ... resto do c√≥digo exatamente como na vers√£o anterior, com as corre√ß√µes de mira vermelha e responsivo landscape j√° aplicadas acima.

    function initGame() {
        // ... igual
        botState.angerLevel = 0;
        document.getElementById('p2-section').classList.remove('bot-angry');
        // ...
    }

    // LOOP E RESIZE permanecem iguais

    window.addEventListener('resize', resizeGame);
    window.addEventListener('orientationchange', resizeGame);

    initGame();
    resizeGame();
    animate();
</script>
</body>
</html>
