<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat App</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/html5-qrcode/minified/html5-qrcode.min.js"></script>
    <script src="https://unpkg.com/wavesurfer.js"></script>
    <style>
        :root {
            --primary-color: #0066cc;
            --secondary-color: #e6f7ff;
            --background-color: #ffffff;
            --text-color: #000000;
            --message-bg-left: #e6f7ff;
            --message-bg-right: #ffffff;
            --header-bg: #0066cc;
            --footer-bg: #ffffff;
            --border-color: #e5e7eb;
            --text-size: 14px;
            --progress-bar-bg: #e5e7eb;
            --progress-bar-fill: #0066cc;
            --quoted-color: #f0f0f0;
            --error-bg: #fef2f2;
            --error-text: #ef4444;
            --reaction-bg: #f0f0f0;
            --reaction-icon-color: #4a5568;
        }
        [data-theme="dark"] {
            --primary-color: #4a9eff;
            --secondary-color: #1a365d;
            --background-color: #1a202c;
            --text-color: #ffffff;
            --message-bg-left: #2d3748;
            --message-bg-right: #4a5568;
            --header-bg: #2d3748;
            --footer-bg: #2d3748;
            --border-color: #4a5568;
            --progress-bar-bg: #4a5568;
            --progress-bar-fill: #4a9eff;
            --quoted-color: #2d3748;
            --error-bg: #451a1a;
            --error-text: #fca5a5;
            --reaction-bg: #4a5568;
            --reaction-icon-color: #a0aec0;
        }
        [data-theme="nature"] {
            --primary-color: #22c55e;
            --secondary-color: #dcfce7;
            --background-color: #f0fdf4;
            --text-color: #166534;
            --message-bg-left: #16a34a;
            --message-bg-right: #ffffff;
            --header-bg: transparent;
            --footer-bg: #ffffff;
            --border-color: #bbf7d0;
            --progress-bar-bg: #bbf7d0;
            --progress-bar-fill: #22c55e;
            --quoted-color: #dcfce7;
            --error-bg: #fef2f2;
            --error-text: #ef4444;
            --reaction-bg: #dcfce7;
            --reaction-icon-color: #166534;
        }
        body {
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            background: var(--background-color);
            overscroll-behavior: none;
            position: relative;
            color: var(--text-color);
            font-size: var(--text-size);
            transition: all 0.3s ease;
        }
        .text-small { --text-size: 12px; }
        .text-medium { --text-size: 14px; }
        .text-large { --text-size: 16px; }
        .text-xlarge { --text-size: 18px; }
        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #ffffff;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: #0066cc;
            z-index: 9999;
            transition: opacity 0.7s ease-out;
        }
        .loading-screen.hidden {
            opacity: 0;
            pointer-events: none;
        }
        .loading-logo {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            object-fit: cover;
            margin-bottom: 20px;
            box-shadow: 0 0 15px rgba(0, 102, 204, 0.2);
            animation: logoScale 1.5s ease-in-out infinite;
        }
        @keyframes logoScale {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        .loading-text {
            font-size: 1.5rem;
            font-weight: 500;
            color: #0066cc;
        }
        .chat-container {
            height: 100vh;
            width: 100vw;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            touch-action: manipulation;
            position: relative;
        }
        .particles-background {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            z-index: 0;
        }
        .particle {
            position: absolute;
            background: rgba(0, 102, 204, 0.3);
            border-radius: 50%;
            animation: moveParticles 20s linear infinite;
        }
        @keyframes moveParticles {
            0% { transform: translate(0, 0); opacity: 0; }
            50% { opacity: 1; }
            100% { transform: translate(var(--x), var(--y)); opacity: 0; }
        }
        .chat-header {
            background: var(--header-bg);
            color: #ffffff;
            padding: 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            z-index: 10;
            border-bottom-left-radius: 20px;
            border-bottom-right-radius: 20px;
        }
        .error-message {
            background: var(--error-bg);
            color: var(--error-text);
            padding: 12px;
            text-align: center;
            font-weight: bold;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            position: sticky;
            top: 0;
            z-index: 20;
            animation: slideInDown 0.5s ease-out;
            cursor: pointer;
        }
        @keyframes slideInDown {
            from { transform: translateY(-100%); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        .global-delete-button {
            cursor: pointer;
            color: #ffffff;
            font-size: 1.2rem;
        }
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            scrollbar-width: thin;
            scrollbar-color: var(--primary-color) var(--border-color);
            padding: 16px;
            background: transparent;
            width: 100%;
            padding-bottom: 120px;
            position: relative;
            z-index: 1;
        }
        .chat-messages::-webkit-scrollbar {
            width: 6px;
        }
        .chat-messages::-webkit-scrollbar-track {
            background: var(--border-color);
        }
        .chat-messages::-webkit-scrollbar-thumb {
            background: var(--primary-color);
            border-radius: 3px;
        }
        .message {
            animation: fadeIn 0.3s ease-out;
            width: 100%;
            position: relative;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .message-bubble {
            position: relative;
            border-radius: 10px;
            padding: 10px 14px;
            max-width: 90%;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
            white-space: pre-wrap;
            word-wrap: normal;
            margin-bottom: 4px;
            display: inline-block;
            font-size: var(--text-size);
        }
        .message-bubble.radiate {
            animation: radiateBorder 0.5s ease-out;
        }
        @keyframes radiateBorder {
            0% { box-shadow: 0 0 0 0 rgba(0, 102, 204, 0.7); }
            100% { box-shadow: 0 0 0 10px rgba(0, 102, 204, 0); }
        }
        .message-bubble::after {
            content: '';
            position: absolute;
            width: 0;
            height: 0;
            border: 8px solid transparent;
        }
        .message-left .message-bubble {
            background: var(--message-bg-left);
            color: var(--primary-color);
        }
        .message-left .message-bubble::after {
            border-right-color: var(--message-bg-left);
            border-left: 0;
            left: -8px;
            top: 12px;
        }
        .message-right .message-bubble {
            background: var(--message-bg-right);
            color: var(--text-color);
        }
        .message-right .message-bubble::after {
            border-left-color: var(--message-bg-right);
            border-right: 0;
            right: -8px;
            top: 12px;
        }
        .message-image {
            max-width: 200px;
            border-radius: 10px;
            cursor: pointer;
            display: block;
        }
        .message-audio {
            max-width: 250px;
            border-radius: 20px;
            padding: 8px;
            background: #f0f0f0;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        .waveform {
            display: flex;
            gap: 2px;
            flex: 1;
            height: 20px;
            align-items: center;
        }
        .wave-bar {
            width: 4px;
            background: var(--primary-color);
            border-radius: 2px;
            animation: audioWave 1.5s infinite ease-in-out;
        }
        .wave-bar:nth-child(2) { animation-delay: -0.3s; }
        .wave-bar:nth-child(3) { animation-delay: -0.6s; }
        .wave-bar:nth-child(4) { animation-delay: -0.9s; }
        .wave-bar:nth-child(5) { animation-delay: -1.2s; }
        @keyframes audioWave {
            0%, 100% { height: 10px; }
            50% { height: 20px; }
        }
        .fullscreen-image {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .fullscreen-image img {
            max-width: 90%;
            max-height: 90%;
            object-fit: contain;
        }
        .close-button {
            position: absolute;
            top: 20px;
            right: 20px;
            background: var(--secondary-color);
            color: var(--primary-color);
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            font-size: 20px;
        }
        .reaction-button {
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: calc(var(--text-size) * 0.8);
            margin-top: 4px;
            background: var(--reaction-bg);
            border-radius: 20px;
            padding: 4px 8px;
            transition: background 0.3s;
        }
        .reaction-button:hover {
            background: var(--secondary-color);
        }
        .reaction-button i {
            color: var(--reaction-icon-color);
        }
        .reaction-button.like-button i {
            color: #ff6347; /* Tomato */
        }
        .reaction-button.laugh-button i {
            color: #ff6347; /* Tomato */
        }
        .reaction-button.sad-button i {
            color: #ff6347; /* Tomato */
        }
        .quote-button, .delete-button {
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 4px;
            color: var(--primary-color);
            font-size: calc(var(--text-size) * 0.8);
            margin-top: 4px;
            background: var(--reaction-bg);
            border-radius: 20px;
            padding: 4px 8px;
            transition: background 0.3s;
        }
        .quote-button:hover, .delete-button:hover {
            background: var(--secondary-color);
        }
        .heart-rain {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 10;
        }
        .heart {
            position: absolute;
            color: var(--primary-color);
            font-size: 12px;
            opacity: 0;
            animation: heartRain 1s ease-out forwards;
        }
        @keyframes heartRain {
            0% { opacity: 1; transform: translateY(0) scale(1); }
            100% { opacity: 0; transform: translateY(100px) scale(0.5); }
        }
        .mention {
            color: var(--primary-color);
            font-weight: bold;
        }
        .typing-indicator {
            position: sticky;
            bottom: 60px;
            left: 16px;
            background: var(--secondary-color);
            border-radius: 15px;
            padding: 12px 16px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
            color: var(--text-color);
            font-size: calc(var(--text-size) * 0.9);
            display: flex;
            align-items: center;
            gap: 8px;
            animation: pulse 1.5s ease-in-out infinite;
            margin-top: 8px;
            width: fit-content;
            border: 2px solid var(--primary-color);
        }
        .typing-avatar {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            object-fit: cover;
        }
        .typing-text {
            font-weight: 600;
            font-size: calc(var(--text-size) * 1.1);
        }
        .dot {
            width: 6px;
            height: 6px;
            background: var(--primary-color);
            border-radius: 50%;
            animation: bounce 1.2s infinite ease-in-out;
        }
        .dot:nth-child(2) { animation-delay: -0.4s; }
        .dot:nth-child(3) { animation-delay: -0.8s; }
        @keyframes bounce {
            0%, 80%, 100% { transform: translateY(0); }
            40% { transform: translateY(-5px); }
        }
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        .chat-footer {
            background: var(--footer-bg);
            padding: 10px 16px;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 -2px 5px rgba(0, 0, 0, 0.1);
            z-index: 10;
            border-top-left-radius: 20px;
            border-top-right-radius: 20px;
            position: relative;
            flex-direction: column;
        }
        .chat-input {
            flex: 1;
            padding: 12px 16px;
            border: 2px solid var(--primary-color);
            border-radius: 20px;
            outline: none;
            font-size: var(--text-size);
            transition: border-color 0.3s ease, transform 0.2s ease;
            background: var(--background-color);
            color: var(--text-color);
            width: 100%;
        }
        .chat-input:focus {
            border-color: var(--secondary-color);
            transform: scale(1.02);
        }
        .fab-container {
            position: relative;
            display: flex;
            align-items: center;
        }
        .fab-main {
            background: var(--primary-color);
            color: #ffffff;
            border: none;
            border-radius: 50%;
            width: 48px;
            height: 48px;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: transform 0.3s ease;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }
        .fab-main:hover {
            background: var(--secondary-color);
            color: var(--primary-color);
            transform: scale(1.1);
        }
        .fab-main.open {
            transform: rotate(45deg);
        }
        .fab-actions {
            position: absolute;
            bottom: 60px;
            right: 16px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            opacity: 0;
            pointer-events: none;
            transform: translateY(20px);
            transition: all 0.3s ease;
        }
        .fab-actions.open {
            opacity: 1;
            pointer-events: auto;
            transform: translateY(0);
        }
        .fab-action {
            background: var(--primary-color);
            color: #ffffff;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }
        .fab-action:hover {
            background: var(--secondary-color);
            color: var(--primary-color);
            transform: scale(1.1);
        }
        .fab-action.recording {
            background: var(--primary-color);
            animation: pulseRecording 1s infinite;
        }
        .fab-action:disabled {
            background: #cccccc;
            cursor: not-allowed;
            transform: none;
        }
        @keyframes pulseRecording {
            0% { transform: scale(1); }
            50% { transform: scale(1.15); }
            100% { transform: scale(1); }
        }
        .send-button {
            background: var(--primary-color);
            color: #ffffff;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            opacity: 0;
            transform: scale(0);
            position: relative;
            overflow: hidden;
        }
        .send-button.visible {
            opacity: 1;
            transform: scale(1);
        }
        .send-button:hover {
            background: var(--secondary-color);
            color: var(--primary-color);
            transform: scale(1.1);
        }
        .send-button .particle-effect {
            position: absolute;
            top: 50%;
            left: 50%;
            background: rgba(255, 255, 255, 0.8);
            border-radius: 50%;
            animation: shootParticles 1s ease-out forwards;
        }
        @keyframes shootParticles {
            0% {
                transform: translate(-50%, -50%) scale(1);
                opacity: 1;
            }
            100% {
                transform: translate(var(--x), var(--y)) scale(0);
                opacity: 0;
            }
        }
        .fab-sub-menu {
            position: absolute;
            bottom: 60px;
            right: 60px;
            background-color: var(--background-color);
            min-width: 160px;
            box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
            z-index: 1000;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            display: none;
        }
        .fab-sub-menu.open {
            display: block;
        }
        .fab-sub-menu-item {
            color: var(--text-color);
            padding: 12px 16px;
            text-decoration: none;
            display: block;
            cursor: pointer;
            border-radius: 8px;
            margin: 4px;
            transition: background-color 0.3s;
        }
        .fab-sub-menu-item:hover {
            background-color: var(--secondary-color);
        }
        .recording-animation {
            position: absolute;
            bottom: 60px;
            left: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
            background: var(--secondary-color);
            border-radius: 20px;
            padding: 8px 16px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            z-index: 9;
            animation: slideIn 0.3s ease-out;
        }
        .recording-icon {
            font-size: 1.5rem;
            color: var(--primary-color);
            animation: pulseIcon 1.5s infinite;
        }
        .recording-wave {
            display: flex;
            gap: 4px;
            align-items: center;
        }
        .recording-wave-bar {
            width: 6px;
            height: 20px;
            background: var(--primary-color);
            border-radius: 3px;
            animation: wave 1.2s infinite ease-in-out;
        }
        .recording-wave-bar:nth-child(2) { animation-delay: -0.3s; }
        .recording-wave-bar:nth-child(3) { animation-delay: -0.6s; }
        .recording-wave-bar:nth-child(4) { animation-delay: -0.9s; }
        .recording-wave-bar:nth-child(5) { animation-delay: -1.2s; }
        @keyframes wave {
            0%, 100% { transform: scaleY(1); }
            50% { transform: scaleY(2.5); }
        }
        @keyframes pulseIcon {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.3); }
        }
        @keyframes slideIn {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        .progress-bar-container {
            position: absolute;
            bottom: 80px;
            left: 16px;
            width: 200px;
            background: var(--secondary-color);
            border-radius: 12px;
            padding: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            z-index: 9;
            animation: slideIn 0.3s ease-out;
        }
        .progress-bar {
            height: 8px;
            background: var(--progress-bar-bg);
            border-radius: 4px;
            overflow: hidden;
        }
        .progress-bar-fill {
            height: 100%;
            background: var(--progress-bar-fill);
            transition: width 0.2s ease-in-out;
        }
        .progress-text {
            font-size: calc(var(--text-size) * 0.8);
            color: var(--primary-color);
            margin-top: 4px;
            text-align: center;
        }
        .quoted-message {
            background: var(--quoted-color);
            padding: 8px;
            border-radius: 8px;
            margin-bottom: 8px;
            border-left: 4px solid var(--primary-color);
        }
        .quoted-user {
            font-weight: bold;
            color: var(--primary-color);
        }
        .quoted-text {
            font-size: 0.9em;
        }
        .quoted-preview {
            background: var(--quoted-color);
            padding: 8px;
            border-radius: 8px;
            margin-bottom: 8px;
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            width: 100%;
        }
        .quoted-preview button {
            background: transparent;
            border: none;
            color: var(--primary-color);
            cursor: pointer;
            align-self: flex-end;
        }
        .input-container {
            display: flex;
            align-items: center;
            gap: 8px;
            width: 100%;
        }
        .input-icons-wrapper {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            display: flex;
            gap: 8px;
        }
        .reply-text {
            color: var(--primary-color);
            font-size: calc(var(--text-size) * 0.8);
            margin-top: 4px;
        }
        .poll-container {
            margin-top: 8px;
            background: rgba(255, 255, 255, 0.8);
            padding: 12px;
            border-radius: 12px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .poll-question {
            font-weight: bold;
            font-size: 1.1em;
            margin-bottom: 8px;
        }
        .poll-option-button {
            width: 100%;
            background: #e0e0e0;
            color: #333;
            padding: 8px;
            border-radius: 8px;
            margin-bottom: 4px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            transition: background-color 0.2s;
            border: none;
        }
        .poll-option-button:hover {
            background: #d4d4d4;
        }
        .poll-option-button.voted-option {
            background: #d1e7dd;
        }
        .poll-option-button:disabled {
            cursor: not-allowed;
            background: #e9ecef;
        }
        .poll-option-bar-container {
            flex-grow: 1;
            height: 10px;
            background: #c2e0ff;
            border-radius: 5px;
            margin-right: 8px;
            position: relative;
        }
        .poll-option-bar {
            height: 100%;
            background: var(--primary-color);
            border-radius: 5px;
            transition: width 0.3s ease;
        }
        .poll-option-text {
            font-weight: 500;
        }
        .poll-option-count {
            font-weight: bold;
        }
        .poll-winner-message {
            margin-top: 8px;
            font-weight: bold;
            text-align: center;
            color: var(--primary-color);
        }
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1001;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }
        .modal-overlay.open {
            opacity: 1;
            pointer-events: auto;
        }
        .modal {
            background: var(--background-color);
            color: var(--text-color);
            padding: 24px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            max-width: 90%;
            width: 400px;
            transform: translateY(-20px);
            transition: transform 0.3s ease, opacity 0.3s ease;
        }
        .modal-overlay.open .modal {
            transform: translateY(0);
        }
        .modal-header {
            font-size: 1.5rem;
            font-weight: bold;
            margin-bottom: 16px;
            color: var(--primary-color);
        }
        .modal-input {
            width: 100%;
            padding: 12px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            margin-bottom: 16px;
            outline: none;
            font-size: var(--text-size);
            background: var(--background-color);
            color: var(--text-color);
        }
        .modal-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 12px;
        }
        .modal-button {
            padding: 10px 20px;
            border-radius: 20px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .modal-button.cancel {
            background: #e5e7eb;
            color: #4b5563;
        }
        .modal-button.create {
            background: var(--primary-color);
            color: #ffffff;
        }
        .modal-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }
        #qr-scanner-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1002;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        #qr-scanner-container.open {
            display: flex;
        }
        .camera-preview-box {
            position: relative;
            width: 100%;
            max-width: 500px;
            height: 0;
            padding-bottom: 75%;
            background: black;
        }
        #qr-scanner-video {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            transform: scaleX(-1);
            object-fit: cover;
        }
        #interactive-camera-content {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            pointer-events: none;
        }
        #qr-scanner-result {
            color: #fff;
            margin-top: 20px;
            font-size: 1.2rem;
            text-align: center;
        }
        #qr-camera-buttons {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 20px;
        }
        .qr-camera-button {
            background: var(--primary-color);
            color: #fff;
            border: none;
            padding: 10px 20px;
            border-radius: 20px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .qr-camera-button:hover {
            background: var(--secondary-color);
            color: var(--primary-color);
        }
        .paste-button {
            background: var(--primary-color);
            color: #ffffff;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            z-index: 9;
            opacity: 0;
            transform: scale(0);
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
        }
        .paste-button.visible {
            opacity: 1;
            transform: translateY(-50%) scale(1);
        }
        .audio-player-container {
            display: flex;
            align-items: center;
            background: #f0f0f0;
            border-radius: 20px;
            padding: 8px 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            max-width: 250px;
        }
        .audio-player-container.right {
            background: #dcf8c6;
        }
        .play-button {
            background: var(--primary-color);
            color: white;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            border: none;
            margin-right: 8px;
        }
        .wave-line {
            height: 20px;
            flex-grow: 1;
            position: relative;
        }
        .wave-line::before, .wave-line::after {
            content: '';
            position: absolute;
            width: 100%;
            height: 2px;
            background: #ccc;
            top: 50%;
            transform: translateY(-50%);
            border-radius: 1px;
        }
        .audio-seeker {
            width: 100%;
            -webkit-appearance: none;
            height: 4px;
            background: #ccc;
            outline: none;
            border-radius: 2px;
            cursor: pointer;
            transition: background 0.2s ease-in-out;
            margin: 0 8px;
        }
        .audio-seeker::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 12px;
            height: 12px;
            background: var(--primary-color);
            border-radius: 50%;
            cursor: pointer;
        }
        .audio-time {
            font-size: 0.75rem;
            color: #777;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        const initialMessages = [
            {
                id: 1,
                Usuario: 'Bot Cordeiro',
                FOTOPERFIL: 'https://i.postimg.cc/Ssk9kkHb/1757343420124.png',
                DIGIOTOU: 'Olá! Sou seu assistente de chat. Como posso ajudar hoje?',
                DATAENVIO: '2025-01-01T10:00:00Z',
                mensacao: '0',
                laughs: '0',
                sads: '0',
                is_read: false
            },
            {
                id: 2,
                Usuario: 'Anônimo',
                FOTOPERFIL: 'https://i.postimg.cc/Ssk9kkHb/1757343420124.png',
                DIGIOTOU: 'Olá! Estou feliz em falar com você.',
                DATAENVIO: '2025-01-01T10:05:00Z',
                mensacao: '5',
                laughs: '0',
                sads: '0',
                is_read: true
            }
        ];

        const generateRandomId = () => Math.floor(Math.random() * 1000000);

        const LoadingScreen = () => {
            const [isLoaded, setIsLoaded] = useState(false);
            useEffect(() => {
                const timer = setTimeout(() => {
                    setIsLoaded(true);
                }, 3000);
                return () => clearTimeout(timer);
            }, []);
            return (
                <div className={`loading-screen ${isLoaded ? 'hidden' : ''}`}>
                    <img src="https://i.postimg.cc/Ssk9kkHb/1757343420124.png" alt="Logo" className="loading-logo" />
                    <p className="loading-text">Carregando...</p>
                </div>
            );
        };

        const ParticlesBackground = () => {
            const [particles, setParticles] = useState([]);
            useEffect(() => {
                const newParticles = Array.from({ length: 30 }, (_, i) => ({
                    id: i,
                    size: `${Math.random() * 10 + 5}px`,
                    x: `${Math.random() * 100}vw`,
                    y: `${Math.random() * 100}vh`,
                    animationDuration: `${Math.random() * 10 + 10}s`,
                    animationDelay: `${Math.random() * 5}s`,
                    endX: `${(Math.random() - 0.5) * 50}vw`,
                    endY: `${(Math.random() - 0.5) * 50}vh`
                }));
                setParticles(newParticles);
            }, []);
            return (
                <div className="particles-background">
                    {particles.map(p => (
                        <div
                            key={p.id}
                            className="particle"
                            style={{
                                width: p.size,
                                height: p.size,
                                top: p.y,
                                left: p.x,
                                animationDuration: p.animationDuration,
                                animationDelay: p.animationDelay,
                                '--x': p.endX,
                                '--y': p.endY
                            }}
                        ></div>
                    ))}
                </div>
            );
        };

        const ChatMessage = ({ id, Usuario, DIGIOTOU, DATAENVIO, FOTOPERFIL, isRight, mensacao, laughs, sads, ArquivosGravados, quotedMsg, EnqueteArmazenamento, citacao, onLike, onLaugh, onSad, onQuote, onImageClick, onDelete, onVote, onCopyText }) => {
            const [isAnimating, setIsAnimating] = useState(false);
            const [hearts, setHearts] = useState([]);
            const formatDate = (dateString) => {
                const date = new Date(dateString);
                return date.toLocaleString('pt-BR', { hour: '2-digit', minute: '2-digit' });
            };
            const handleLike = () => {
                if (!isAnimating) {
                    setIsAnimating(true);
                    const newHearts = Array.from({ length: 10 }, (_, i) => ({
                        id: i,
                        left: `${Math.random() * 100}%`,
                        animationDelay: `${Math.random() * 0.5}s`
                    }));
                    setHearts(newHearts);
                    onLike(id, mensacao);
                    setTimeout(() => {
                        setIsAnimating(false);
                        setHearts([]);
                    }, 1000);
                }
            };
            const handleLaugh = () => { onLaugh(id, laughs); };
            const handleSad = () => { onSad(id, sads); };
            const handleQuote = () => { onQuote({ id, Usuario, DIGIOTOU, DATAENVOS, FOTOPERFIL, mensacao, laughs, sads, ArquivosGravados }); };
            const handleDelete = async () => {
                const password = prompt('Tem certeza que deseja apagar esta mensagem para todos?');
                if (password === 'admincordeiro') {
                    onDelete(id);
                } else {
                    console.error('Senha incorreta!');
                }
            };
            const isImage = Array.isArray(ArquivosGravados) && ArquivosGravados.length > 0 && ArquivosGravados[0].is_image;
            const isVideo = Array.isArray(ArquivosGravados) && ArquivosGravados.length > 0 && ArquivosGravados[0].mime_type.startsWith('video/');
            const isAudio = Array.isArray(ArquivosGravados) && ArquivosGravados.length > 0 && ArquivosGravados[0].mime_type.startsWith('audio/');
            const isPoll = EnqueteArmazenamento;
            let pollData = null;
            if (isPoll) {
                try {
                    pollData = JSON.parse(EnqueteArmazenamento);
                } catch (e) {
                    console.error("Failed to parse poll data:", e);
                    isPoll = false;
                }
            }
            const cleanMessage = DIGIOTOU ? DIGIOTOU.replace(/[\r\n]+/g, ' ').trim() : '';
            const parts = cleanMessage.split(/(@\w+)/g);
            const renderedMessage = parts.map((part, index) => {
                if (part.startsWith('@')) {
                    return <span key={index} className="mention">{part}</span>;
                }
                return part;
            });
            const likeCount = parseInt(mensacao || '0', 10);
            const laughCount = parseInt(laughs || '0', 10);
            const sadCount = parseInt(sads || '0', 10);
            const userDisplay = Usuario && Usuario !== 'string' ? Usuario : 'Anônimo';
            return (
                <div className={`flex ${isRight ? 'justify-end' : 'justify-start'} mb-4 message message-${isRight ? 'right' : 'left'}`}>
                    <div className={`flex ${isRight ? 'flex-row-reverse' : 'flex-row'} items-start w-full`}>
                        <img src={FOTOPERFIL || 'https://i.postimg.cc/Ssk9kkHb/1757343420124.png'} alt="Profile" className="w-10 h-10 rounded-full object-cover mt-2" />
                        <div className="flex flex-col mx-2 w-full relative">
                            <div className={`message-bubble ${isAnimating ? 'radiate' : ''}`} onDoubleClick={() => onCopyText(DIGIOTOU)}>
                                <span className="text-xs font-semibold" style={{ color: isRight ? 'var(--primary-color)' : '#ffffff' }}>{userDisplay}</span>
                                {(quotedMsg || citacao) && (
                                    <div className="quoted-message">
                                        <span className="quoted-user">{quotedMsg ? quotedMsg.Usuario : 'Mensagem citada'}</span>
                                        <p className="quoted-text">{quotedMsg ? quotedMsg.DIGIOTOU : citacao}</p>
                                    </div>
                                )}
                                {isPoll && pollData ? (
                                    <PollComponent id={id} question={pollData.question} options={pollData.options} votes={pollData.votes} onVote={onVote} />
                                ) : isImage ? (
                                    <img src={ArquivosGravados[0].url} alt="Message" className="message-image" onClick={() => onImageClick(ArquivosGravados[0].url)} />
                                ) : isVideo ? (
                                    <video src={ArquivosGravados[0].url} controls className="message-image" />
                                ) : isAudio ? (
                                    <AudioPlayer src={ArquivosGravados[0].url} />
                                ) : (
                                    DIGIOTOU && <p className="text-sm leading-relaxed mt-1">{renderedMessage}</p>
                                )}
                                <div className="flex items-center justify-end mt-1">
                                    <span className="text-xs text-gray-500">{formatDate(DATAENVIO)}</span>
                                    {isRight && <i className="fas fa-check text-xs text-gray-500 ml-1"></i>}
                                </div>
                            </div>
                            <div className="heart-rain">
                                {hearts.map(heart => (
                                    <i key={heart.id} className="fas fa-heart heart" style={{ left: heart.left, animationDelay: heart.animationDelay }}></i>
                                ))}
                            </div>
                            <div className="flex gap-2">
                                {!isRight && (
                                    <div className="reaction-button like-button" onClick={handleLike}>
                                        <i className="fas fa-heart"></i>
                                        <span>{likeCount}</span>
                                    </div>
                                )}
                                {!isRight && (
                                    <div className="reaction-button laugh-button" onClick={handleLaugh}>
                                        <i className="fas fa-laugh"></i>
                                        <span>{laughCount}</span>
                                    </div>
                                )}
                                {!isRight && (
                                    <div className="reaction-button sad-button" onClick={handleSad}>
                                        <i className="fas fa-sad-tear"></i>
                                        <span>{sadCount}</span>
                                    </div>
                                )}
                                {!isRight && (
                                    <div className="quote-button" onClick={handleQuote}>
                                        <i className="fas fa-reply"></i>
                                    </div>
                                )}
                                <div className="delete-button" onClick={handleDelete}>
                                    <i className="fas fa-trash"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const AudioPlayer = ({ src }) => {
            const wavesurferRef = useRef(null);
            const waveformRef = useRef(null);
            const [isPlaying, setIsPlaying] = useState(false);
            const [currentTime, setCurrentTime] = useState(0);
            const [duration, setDuration] = useState(0);

            useEffect(() => {
                if (waveformRef.current) {
                    const wavesurfer = WavesSurfer.create({
                        container: waveformRef.current,
                        waveColor: 'var(--primary-color)',
                        progressColor: 'var(--primary-color)',
                        cursorColor: 'transparent',
                        barWidth: 2,
                        barRadius: 3,
                        responsive: true,
                        height: 30,
                    });
                    wavesurfer.load(src);
                    wavesurfer.on('ready', () => {
                        setDuration(wavesurfer.getDuration());
                    });
                    wavesurfer.on('audioprocess', () => {
                        setCurrentTime(wavesurfer.getCurrentTime());
                    });
                    wavesurfer.on('finish', () => {
                        setIsPlaying(false);
                    });
                    wavesurferRef.current = wavesurfer;
                    return () => wavesurfer.destroy();
                }
            }, [src]);

            const handlePlayPause = () => {
                if (wavesurferRef.current) {
                    wavesurferRef.current.playPause();
                    setIsPlaying(wavesurferRef.current.isPlaying());
                }
            };

            const formatTime = (time) => {
                const minutes = Math.floor(time / 60);
                const seconds = Math.floor(time % 60);
                return `${minutes}:${seconds.toString().padStart(2, '0')}`;
            };

            return (
                <div className="audio-player-container">
                    <button className="play-button" onClick={handlePlayPause}>
                        <i className={`fas ${isPlaying ? 'fa-pause' : 'fa-play'}`}></i>
                    </button>
                    <div ref={waveformRef} className="wave-line"></div>
                    <span className="audio-time">{formatTime(currentTime)} / {formatTime(duration)}</span>
                </div>
            );
        };

        const PollComponent = ({ id, question, options, votes, onVote }) => {
            const totalVotes = votes.reduce((sum, v) => sum + v, 0);
            const [voted, setVoted] = useState(false);
            const handleVote = (index) => {
                onVote(id, index);
                setVoted(true);
            };
            const winningOptionIndex = votes.indexOf(Math.max(...votes));
            return (
                <div className="poll-container">
                    <p className="poll-question">{question}</p>
                    {options.map((option, index) => {
                        const voteCount = votes[index];
                        const percentage = totalVotes > 0 ? (voteCount / totalVotes) * 100 : 0;
                        return (
                            <button
                                key={index}
                                className={`poll-option-button ${voted ? 'disabled' : ''} ${index === winningOptionIndex ? 'voted-option' : ''}`}
                                onClick={() => handleVote(index)}
                                disabled={voted}
                            >
                                <span className="poll-option-text">{option}</span>
                                <div className="poll-option-bar-container">
                                    <div className="poll-option-bar" style={{ width: `${percentage}%` }}></div>
                                </div>
                                <span className="poll-option-count">{voteCount}</span>
                            </button>
                        );
                    })}
                    {voted && totalVotes > 0 && (
                        <p className="poll-winner-message">"{options[winningOptionIndex]}" está ganhando!</p>
                    )}
                </div>
            );
        };

        const RecordingAnimation = ({ duration }) => {
            const formatTime = (seconds) => {
                const minutes = Math.floor(seconds / 60);
                const remainingSeconds = Math.floor(seconds % 60);
                return `${minutes.toString().padStart(2, '0')}:${remainingSeconds.toString().padStart(2, '0')}`;
            };
            return (
                <div className="recording-animation">
                    <i className="fas fa-microphone recording-icon"></i>
                    <div className="recording-wave">
                        <span className="recording-wave-bar"></span>
                        <span className="recording-wave-bar"></span>
                        <span className="recording-wave-bar"></span>
                        <span className="recording-wave-bar"></span>
                        <span className="recording-wave-bar"></span>
                    </div>
                    <span className="text-sm font-semibold">{formatTime(duration)}</span>
                </div>
            );
        };

        const ProgressBar = ({ progress }) => {
            return (
                <div className="progress-bar-container">
                    <div className="progress-bar">
                        <div className="progress-bar-fill" style={{ width: `${progress}%` }}></div>
                    </div>
                    <p className="progress-text">Enviando... {progress}%</p>
                </div>
            );
        };

        const App = () => {
            const [messages, setMessages] = useState(initialMessages);
            const [inputText, setInputText] = useState('');
            const [isTyping, setIsTyping] = useState(false);
            const [showFullscreenImage, setShowFullscreenImage] = useState(null);
            const [fabOpen, setFabOpen] = useState(false);
            const [showThemeMenu, setShowThemeMenu] = useState(false);
            const [showFontMenu, setShowFontMenu] = useState(false);
            const [theme, setTheme] = useState('light');
            const [isCameraOpen, setIsCameraOpen] = useState(false);
            const [qrScanner, setQrScanner] = useState(null);
            const [qrCodeResult, setQrCodeResult] = useState('');
            const [quotedMessage, setQuotedMessage] = useState(null);
            const [isPollModalOpen, setIsPollModalOpen] = useState(false);
            const [pollQuestion, setPollQuestion] = useState('');
            const [pollOptions, setPollOptions] = useState(['', '', '']);
            const [mediaRecorder, setMediaRecorder] = useState(null);
            const [audioChunks, setAudioChunks] = useState([]);
            const [isRecording, setIsRecording] = useState(false);
            const [recordingDuration, setRecordingDuration] = useState(0);
            const [recordingInterval, setRecordingInterval] = useState(null);
            const [uploadProgress, setUploadProgress] = useState(null);
            const [showPasteButton, setShowPasteButton] = useState(false);
            const [sendParticles, setSendParticles] = useState([]);
            const messagesEndRef = useRef(null);
            const chatInputRef = useRef(null);

            useEffect(() => {
                messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });
            }, [messages]);

            const scrollToBottom = () => {
                messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });
            };

            const handleInputChange = (e) => {
                setInputText(e.target.value);
                setIsTyping(e.target.value.length > 0);
                if (quotedMessage) {
                    const mention = `@${quotedMessage.Usuario.replace(/\s/g, '')} `;
                    if (!e.target.value.startsWith(mention)) {
                        setQuotedMessage(null);
                    }
                }
                setShowPasteButton(e.target.value.length === 0 && !!navigator.clipboard?.readText);
                resizeInput();
            };

            const handleKeyPress = (e) => {
                if (e.key === 'Enter') {
                    handleSendMessage();
                }
            };
            
            const resizeInput = () => {
                const input = chatInputRef.current;
                if (input) {
                    const rightWidth = inputText.trim() ? 135 : 90;
                    input.style.paddingRight = `${rightWidth}px`;
                    const leftWidth = showPasteButton ? 55 : 16;
                    input.style.paddingLeft = `${leftWidth}px`;
                }
            };

            useEffect(() => {
                resizeInput();
                window.addEventListener('resize', resizeInput);
                return () => window.removeEventListener('resize', resizeInput);
            }, [isRecording, inputText, showPasteButton]);

            const handleSendMessage = () => {
                if (inputText.trim() === '') return;
                const newMessage = {
                    id: generateRandomId(),
                    Usuario: 'Anônimo',
                    FOTOPERFIL: 'https://i.postimg.cc/Ssk9kkHb/1757343420124.png',
                    DIGIOTOU: inputText,
                    DATAENVIO: new Date().toISOString(),
                    mensacao: '0',
                    laughs: '0',
                    sads: '0',
                    is_read: false,
                    quotedMsg: quotedMessage
                };
                setMessages(prevMessages => [...prevMessages, newMessage]);
                setInputText('');
                setIsTyping(false);
                setQuotedMessage(null);
                
                // Particle Effect
                const newParticles = Array.from({ length: 15 }, (_, i) => ({
                    id: i,
                    size: `${Math.random() * 5 + 2}px`,
                    x: `${(Math.random() - 0.5) * 60}px`,
                    y: `${-Math.random() * 60 - 20}px`
                }));
                setSendParticles(newParticles);
                setTimeout(() => setSendParticles([]), 1000);

                setTimeout(() => scrollToBottom(), 100);
            };

            const handleLike = (id, currentLikes) => {
                setMessages(prevMessages =>
                    prevMessages.map(msg =>
                        msg.id === id ? { ...msg, mensacao: (parseInt(currentLikes, 10) + 1).toString() } : msg
                    )
                );
            };

            const handleLaugh = (id, currentLaughs) => {
                setMessages(prevMessages =>
                    prevMessages.map(msg =>
                        msg.id === id ? { ...msg, laughs: (parseInt(currentLaughs, 10) + 1).toString() } : msg
                    )
                );
            };

            const handleSad = (id, currentSads) => {
                setMessages(prevMessages =>
                    prevMessages.map(msg =>
                        msg.id === id ? { ...msg, sads: (parseInt(currentSads, 10) + 1).toString() } : msg
                    )
                );
            };

            const handleQuote = (message) => {
                setQuotedMessage(message);
                setInputText(`@${message.Usuario.replace(/\s/g, '')} `);
                document.querySelector('.chat-input').focus();
            };

            const handleImageClick = (url) => {
                setShowFullscreenImage(url);
            };

            const closeFullscreenImage = () => {
                setShowFullscreenImage(null);
            };

            const deleteAllMessages = () => {
                const password = prompt('Tem certeza que deseja apagar TODAS as mensagens?');
                if (password === 'admincordeiro') {
                    setMessages([]);
                } else {
                    console.error('Senha incorreta!');
                }
            };

            const handleDeleteMessage = (id) => {
                setMessages(prevMessages => prevMessages.filter(msg => msg.id !== id));
            };

            const handleCopyText = (text) => {
                navigator.clipboard.writeText(text).then(() => {
                    alert('Texto copiado para a área de transferência!');
                }).catch(err => {
                    console.error('Falha ao copiar texto: ', err);
                });
            };

            const toggleFab = () => {
                setFabOpen(prev => !prev);
                setShowThemeMenu(false);
                setShowFontMenu(false);
            };

            const toggleThemeMenu = (e) => {
                e.stopPropagation();
                setShowThemeMenu(prev => !prev);
                setShowFontMenu(false);
            };

            const toggleFontMenu = (e) => {
                e.stopPropagation();
                setShowFontMenu(prev => !prev);
                setShowThemeMenu(false);
            };

            const changeTheme = (newTheme) => {
                document.documentElement.setAttribute('data-theme', newTheme);
                setTheme(newTheme);
                setShowThemeMenu(false);
            };

            const changeFontSize = (size) => {
                document.documentElement.className = `text-${size}`;
                setShowFontMenu(false);
            };

            const handleUploadPhoto = () => {
                const fileInput = document.createElement('input');
                fileInput.type = 'file';
                fileInput.accept = 'image/*';
                fileInput.onchange = (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onloadstart = () => setUploadProgress(0);
                        reader.onprogress = (event) => {
                            if (event.lengthComputable) {
                                const percent = Math.round((event.loaded / event.total) * 100);
                                setUploadProgress(percent);
                            }
                        };
                        reader.onload = (e) => {
                            setUploadProgress(100);
                            const newMessage = {
                                id: generateRandomId(),
                                Usuario: 'Anônimo',
                                FOTOPERFIL: 'https://i.postimg.cc/Ssk9kkHb/1757343420124.png',
                                DIGIOTOU: null,
                                DATAENVIO: new Date().toISOString(),
                                ArquivosGravados: [{ url: e.target.result, is_image: true, mime_type: file.type }],
                                mensacao: '0',
                                laughs: '0',
                                sads: '0',
                                is_read: false
                            };
                            setMessages(prevMessages => [...prevMessages, newMessage]);
                            setTimeout(() => {
                                setUploadProgress(null);
                                scrollToBottom();
                            }, 500);
                        };
                        reader.readAsDataURL(file);
                    }
                };
                fileInput.click();
                setFabOpen(false);
            };

            const handleUploadAudio = () => {
                alert('Funcionalidade de upload de áudio em desenvolvimento.');
                setFabOpen(false);
            };

            const handleUploadVideo = () => {
                alert('Funcionalidade de upload de vídeo em desenvolvimento.');
                setFabOpen(false);
            };

            const handlePasteText = async () => {
                try {
                    const text = await navigator.clipboard.readText();
                    setInputText(text);
                    setShowPasteButton(false);
                } catch (err) {
                    console.error('Falha ao colar: ', err);
                }
            };

            const handleRecordAudio = async () => {
                if (isRecording) {
                    mediaRecorder.stop();
                    setIsRecording(false);
                    clearInterval(recordingInterval);
                } else {
                    try {
                        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                        const newMediaRecorder = new MediaRecorder(stream);
                        newMediaRecorder.start();
                        setIsRecording(true);
                        setRecordingDuration(0);
                        const interval = setInterval(() => {
                            setRecordingDuration(prev => prev + 1);
                        }, 1000);
                        setRecordingInterval(interval);
                        setAudioChunks([]);
                        newMediaRecorder.ondataavailable = (e) => {
                            setAudioChunks(prev => [...prev, e.data]);
                        };
                        newMediaRecorder.onstop = () => {
                            const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                            const audioUrl = URL.createObjectURL(audioBlob);
                            const newMessage = {
                                id: generateRandomId(),
                                Usuario: 'Anônimo',
                                FOTOPERFIL: 'https://i.postimg.cc/Ssk9kkHb/1757343420124.png',
                                DIGIOTOU: null,
                                DATAENVIO: new Date().toISOString(),
                                ArquivosGravados: [{ url: audioUrl, mime_type: 'audio/webm' }],
                                mensacao: '0',
                                laughs: '0',
                                sads: '0',
                                is_read: false
                            };
                            setMessages(prevMessages => [...prevMessages, newMessage]);
                            stream.getTracks().forEach(track => track.stop());
                            setTimeout(() => scrollToBottom(), 100);
                        };
                        setMediaRecorder(newMediaRecorder);
                    } catch (error) {
                        alert('Não foi possível iniciar a gravação: ' + error.message);
                        setIsRecording(false);
                    }
                }
            };

            const openPollModal = () => {
                setIsPollModalOpen(true);
                setFabOpen(false);
            };

            const closePollModal = () => {
                setIsPollModalOpen(false);
                setPollQuestion('');
                setPollOptions(['', '', '']);
            };

            const handlePollOptionChange = (index, value) => {
                const newOptions = [...pollOptions];
                newOptions[index] = value;
                setPollOptions(newOptions);
            };

            const createPoll = () => {
                const validOptions = pollOptions.filter(opt => opt.trim() !== '');
                if (pollQuestion.trim() === '' || validOptions.length < 2) {
                    alert('A enquete precisa de uma pergunta e no mínimo duas opções.');
                    return;
                }
                const newPoll = {
                    question: pollQuestion,
                    options: validOptions,
                    votes: validOptions.map(() => 0),
                };
                const newMessage = {
                    id: generateRandomId(),
                    Usuario: 'Anônimo',
                    FOTOPERFIL: 'https://i.postimg.cc/Ssk9kkHb/1757343420124.png',
                    DIGIOTOU: null,
                    DATAENVIO: new Date().toISOString(),
                    EnqueteArmazenamento: JSON.stringify(newPoll),
                    mensacao: '0',
                    laughs: '0',
                    sads: '0',
                    is_read: false
                };
                setMessages(prevMessages => [...prevMessages, newMessage]);
                closePollModal();
                setTimeout(() => scrollToBottom(), 100);
            };

            const handleVote = (messageId, optionIndex) => {
                setMessages(prevMessages =>
                    prevMessages.map(msg => {
                        if (msg.id === messageId && msg.EnqueteArmazenamento) {
                            const pollData = JSON.parse(msg.EnqueteArmazenamento);
                            if (pollData) {
                                const newVotes = [...pollData.votes];
                                newVotes[optionIndex] += 1;
                                const updatedPollData = { ...pollData, votes: newVotes };
                                return { ...msg, EnqueteArmazenamento: JSON.stringify(updatedPollData) };
                            }
                        }
                        return msg;
                    })
                );
            };

            const handleScan = (decodedText) => {
                setQrCodeResult(decodedText);
                alert('QR Code detectado: ' + decodedText);
                setIsCameraOpen(false);
                if (qrScanner) {
                    qrScanner.stop().then(() => {
                        console.log("QR Code scanner stopped.");
                    }).catch(err => {
                        console.error("Failed to stop QR code scanner.", err);
                    });
                }
            };

            const handleError = (err) => {
                console.error("QR Code scanner error: ", err);
            };

            useEffect(() => {
                if (isCameraOpen) {
                    const html5QrCode = new Html5Qrcode("qr-scanner-video");
                    const config = { fps: 10, qrbox: { width: 250, height: 250 } };
                    html5QrCode.start({ facingMode: "environment" }, config, handleScan, handleError)
                        .then(() => {
                            setQrScanner(html5QrCode);
                            console.log("QR Code scanner started.");
                        }).catch(err => {
                            console.error("Failed to start QR code scanner: ", err);
                            setIsCameraOpen(false);
                        });
                }
                return () => {
                    if (qrScanner) {
                        qrScanner.stop().then(() => {
                            console.log("QR Code scanner stopped on unmount.");
                        }).catch(err => {
                            console.error("Failed to stop QR code scanner on unmount.", err);
                        });
                    }
                };
            }, [isCameraOpen]);

            return (
                <div className="chat-container bg-gray-100 dark:bg-gray-900 transition-all duration-300">
                    <LoadingScreen />
                    <ParticlesBackground />
                    <header className="chat-header">
                        <div className="flex items-center">
                            <img src="https://i.postimg.cc/Ssk9kkHb/1757343420124.png" alt="Profile" className="w-10 h-10 rounded-full object-cover mr-4" />
                            <h1 className="text-lg font-bold">Chat Bot</h1>
                        </div>
                        <i className="fas fa-trash-alt global-delete-button" onClick={deleteAllMessages}></i>
                    </header>
                    <main className="chat-messages flex flex-col overflow-y-auto p-4">
                        {messages.map((msg, index) => {
                            const isRight = msg.Usuario === 'Anônimo';
                            return (
                                <ChatMessage
                                    key={msg.id}
                                    id={msg.id}
                                    Usuario={msg.Usuario}
                                    DIGIOTOU={msg.DIGIOTOU}
                                    DATAENVIO={msg.DATAENVIO}
                                    FOTOPERFIL={msg.FOTOPERFIL}
                                    isRight={isRight}
                                    mensacao={msg.mensacao}
                                    laughs={msg.laughs}
                                    sads={msg.sads}
                                    ArquivosGravados={msg.ArquivosGravados}
                                    quotedMsg={msg.quotedMsg}
                                    EnqueteArmazenamento={msg.EnqueteArmazenamento}
                                    onLike={handleLike}
                                    onLaugh={handleLaugh}
                                    onSad={handleSad}
                                    onQuote={handleQuote}
                                    onImageClick={handleImageClick}
                                    onDelete={handleDeleteMessage}
                                    onVote={handleVote}
                                    onCopyText={handleCopyText}
                                />
                            );
                        })}
                        <div ref={messagesEndRef} />
                    </main>
                    {isTyping && (
                        <div className="typing-indicator flex items-center justify-center">
                            <img src="https://i.postimg.cc/Ssk9kkHb/1757343420124.png" alt="Avatar" className="typing-avatar" />
                            <span className="typing-text">Digitando...</span>
                            <div className="dot"></div>
                            <div className="dot"></div>
                            <div className="dot"></div>
                        </div>
                    )}
                    <div className="chat-footer">
                        {isRecording && <RecordingAnimation duration={recordingDuration} />}
                        {uploadProgress !== null && <ProgressBar progress={uploadProgress} />}
                        {quotedMessage && (
                            <div className="quoted-preview">
                                <span>Citando {quotedMessage.Usuario}:</span>
                                <p>{quotedMessage.DIGIOTOU.substring(0, 50)}...</p>
                                <button onClick={() => setQuotedMessage(null)}>X</button>
                            </div>
                        )}
                        <div className="input-container relative">
                            <input
                                type="text"
                                className="chat-input"
                                placeholder="Digite uma mensagem..."
                                value={inputText}
                                onChange={handleInputChange}
                                onKeyPress={handleKeyPress}
                                ref={chatInputRef}
                            />
                            <div className="input-icons-wrapper">
                                <button
                                    className="fab-action"
                                    onClick={() => setIsCameraOpen(true)}
                                    title="Abrir Câmera"
                                >
                                    <i className="fas fa-camera"></i>
                                </button>
                                <button
                                    className={`fab-action ${isRecording ? 'recording' : ''}`}
                                    onClick={handleRecordAudio}
                                    title={isRecording ? 'Parar gravação' : 'Gravar áudio'}
                                >
                                    <i className="fas fa-microphone"></i>
                                </button>
                                <button
                                    className={`send-button ${inputText.trim() ? 'visible' : ''}`}
                                    onClick={handleSendMessage}
                                    disabled={!inputText.trim()}
                                    title="Enviar mensagem"
                                >
                                    <i className="fas fa-paper-plane"></i>
                                    {sendParticles.map(p => (
                                        <div
                                            key={p.id}
                                            className="particle-effect"
                                            style={{
                                                width: p.size,
                                                height: p.size,
                                                '--x': p.x,
                                                '--y': p.y
                                            }}
                                        ></div>
                                    ))}
                                </button>
                            </div>
                            <button
                                className={`paste-button ${showPasteButton ? 'visible' : ''}`}
                                onClick={handlePasteText}
                                title="Colar texto copiado"
                            >
                                <i className="fas fa-paste"></i>
                            </button>
                            <div className="fab-container">
                                <button className={`fab-main ${fabOpen ? 'open' : ''}`} onClick={toggleFab} title="Mais opções">
                                    <i className="fas fa-plus"></i>
                                </button>
                                <div className={`fab-actions ${fabOpen ? 'open' : ''}`}>
                                    <button className="fab-action" onClick={handleUploadPhoto} title="Enviar foto">
                                        <i className="fas fa-image"></i>
                                    </button>
                                    <button className="fab-action" onClick={handleUploadAudio} title="Enviar áudio">
                                        <i className="fas fa-file-audio"></i>
                                    </button>
                                    <button className="fab-action" onClick={handleUploadVideo} title="Enviar vídeo">
                                        <i className="fas fa-video"></i>
                                    </button>
                                    <button className="fab-action" onClick={toggleThemeMenu} title="Alterar tema">
                                        <i className="fas fa-palette"></i>
                                    </button>
                                    <button className="fab-action" onClick={toggleFontMenu} title="Tamanho do texto">
                                        <i className="fas fa-text-height"></i>
                                    </button>
                                    <button className="fab-action" onClick={openPollModal} title="Criar enquete">
                                        <i className="fas fa-poll"></i>
                                    </button>
                                    <button className="fab-action" onClick={deleteAllMessages} title="Apagar todas as mensagens">
                                        <i className="fas fa-trash-alt"></i>
                                    </button>
                                </div>
                                <div className={`fab-sub-menu ${showThemeMenu ? 'open' : ''}`}>
                                    <div className="fab-sub-menu-item" onClick={() => changeTheme('light')}>
                                        <i className="fas fa-sun mr-2"></i>Claro
                                    </div>
                                    <div className="fab-sub-menu-item" onClick={() => changeTheme('dark')}>
                                        <i className="fas fa-moon mr-2"></i>Escuro
                                    </div>
                                    <div className="fab-sub-menu-item" onClick={() => changeTheme('nature')}>
                                        <i className="fas fa-leaf mr-2"></i>Natureza
                                    </div>
                                </div>
                                <div className={`fab-sub-menu ${showFontMenu ? 'open' : ''}`}>
                                    <div className="fab-sub-menu-item" onClick={() => changeFontSize('small')}>Pequeno</div>
                                    <div className="fab-sub-menu-item" onClick={() => changeFontSize('medium')}>Médio</div>
                                    <div className="fab-sub-menu-item" onClick={() => changeFontSize('large')}>Grande</div>
                                    <div className="fab-sub-menu-item" onClick={() => changeFontSize('xlarge')}>Extra Grande</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    {showFullscreenImage && (
                        <div className="fullscreen-image" onClick={closeFullscreenImage}>
                            <img src={showFullscreenImage} alt="Fullscreen" />
                            <button className="close-button">
                                <i className="fas fa-times"></i>
                            </button>
                        </div>
                    )}
                    <div className={`modal-overlay ${isPollModalOpen ? 'open' : ''}`} onClick={closePollModal}>
                        <div className="modal" onClick={e => e.stopPropagation()}>
                            <div className="modal-header">Criar Enquete</div>
                            <input
                                type="text"
                                className="modal-input"
                                placeholder="Pergunta da enquete"
                                value={pollQuestion}
                                onChange={(e) => setPollQuestion(e.target.value)}
                            />
                            {pollOptions.map((option, index) => (
                                <input
                                    key={index}
                                    type="text"
                                    className="modal-input"
                                    placeholder={`Opção ${index + 1}`}
                                    value={option}
                                    onChange={(e) => handlePollOptionChange(index, e.target.value)}
                                />
                            ))}
                            <div className="modal-buttons">
                                <button className="modal-button cancel" onClick={closePollModal}>Cancelar</button>
                                <button className="modal-button create" onClick={createPoll}>Criar</button>
                            </div>
                        </div>
                    </div>
                    <div id="qr-scanner-container" className={isCameraOpen ? 'open' : ''}>
                        <div className="camera-preview-box">
                            <video id="qr-scanner-video" playsInline autoPlay></video>
                        </div>
                        <div id="interactive-camera-content"></div>
                        <div id="qr-camera-buttons">
                            <button className="qr-camera-button" onClick={() => setIsCameraOpen(false)}>Fechar Câmera</button>
                        </div>
                    </div>
                </div>
            );
        };

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
