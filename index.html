<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>GPV Chat</title>
    <script src="https://cdn.jsdelivr.net/npm/react@18.2.0/umd/react.production.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/react-dom@18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios@1.6.2/dist/axios.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@babel/standalone@7.20.6/babel.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <style>
        :root {
            --primary-color: #0047ab; /* Azul mais forte */
            --secondary-color: #e6f7ff;
            --background-color: #ffffff;
            --text-color: #000000;
            --message-bg-left: #e6f7ff;
            --message-bg-right: #ffffff;
            --header-bg: #0047ab;
            --footer-bg: #ffffff;
            --border-color: #e5e7eb;
            --text-size: 14px;
            --progress-bar-bg: #e5e7eb;
            --progress-bar-fill: #0047ab;
            --quoted-color: #f0f0f0; /* Nova cor para citação */
        }

        [data-theme="dark"] {
            --primary-color: #4a9eff;
            --secondary-color: #1a365d;
            --background-color: #1a202c;
            --text-color: #ffffff;
            --message-bg-left: #2d3748;
            --message-bg-right: #4a5568;
            --header-bg: #2d3748;
            --footer-bg: #2d3748;
            --border-color: #4a5568;
            --progress-bar-bg: #4a5568;
            --progress-bar-fill: #4a9eff;
            --quoted-color: #2d3748;
        }

        [data-theme="nature"] {
            --primary-color: #22c55e;
            --secondary-color: #dcfce7;
            --background-color: #f0fdf4;
            --text-color: #166534;
            --message-bg-left: #16a34a;
            --message-bg-right: #ffffff;
            --header-bg: transparent;
            --footer-bg: #ffffff;
            --border-color: #bbf7d0;
            --progress-bar-bg: #bbf7d0;
            --progress-bar-fill: #22c55e;
            --quoted-color: #dcfce7;
        }

        body {
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            background: var(--background-color);
            overscroll-behavior: none;
            position: relative;
            color: var(--text-color);
            font-size: var(--text-size);
            transition: all 0.3s ease;
        }

        .text-small { --text-size: 12px; }
        .text-medium { --text-size: 14px; }
        .text-large { --text-size: 16px; }
        .text-xlarge { --text-size: 18px; }
        .text-xxlarge { --text-size: 20px; } /* Novo tamanho extra extra large */

        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #ffffff; /* Fundo branco para aparência profissional */
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: #0066cc;
            z-index: 9999;
            transition: opacity 0.7s ease-out;
        }

        .loading-screen.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .loading-logo {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            object-fit: cover;
            margin-bottom: 20px;
            box-shadow: 0 0 15px rgba(0, 102, 204, 0.2);
            animation: logoScale 1.5s ease-in-out infinite;
        }

        @keyframes logoScale {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        .loading-text {
            font-size: 1.5rem;
            font-weight: 500;
            color: #0066cc;
        }

        .chat-container {
            height: 100vh;
            width: 100vw;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            touch-action: manipulation;
        }

        .chat-header {
            background: var(--header-bg);
            color: #ffffff;
            padding: 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            z-index: 10;
            border-bottom-left-radius: 20px;
            border-bottom-right-radius: 20px;
        }

        .global-delete-button {
            cursor: pointer;
            color: #ffffff;
            font-size: 1.2rem;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            scrollbar-width: thin;
            scrollbar-color: var(--primary-color) var(--border-color);
            padding: 16px;
            background: transparent;
            width: 100%;
            padding-bottom: 120px;
        }

        .chat-messages::-webkit-scrollbar {
            width: 6px;
        }

        .chat-messages::-webkit-scrollbar-track {
            background: var(--border-color);
        }

        .chat-messages::-webkit-scrollbar-thumb {
            background: var(--primary-color);
            border-radius: 3px;
        }

        .message {
            animation: fadeIn 0.3s ease-out;
            width: 100%;
            position: relative;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .message-bubble {
            position: relative;
            border-radius: 10px;
            padding: 10px 14px;
            max-width: 90%;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
            white-space: pre-wrap;
            word-wrap: normal;
            margin-bottom: 4px;
            display: inline-block;
            font-size: var(--text-size);
        }

        .message-bubble.radiate {
            animation: radiateBorder 0.5s ease-out;
        }

        @keyframes radiateBorder {
            0% { box-shadow: 0 0 0 0 rgba(0, 102, 204, 0.7); }
            100% { box-shadow: 0 0 0 10px rgba(0, 102, 204, 0); }
        }

        .message-bubble::after {
            content: '';
            position: absolute;
            width: 0;
            height: 0;
            border: 8px solid transparent;
        }

        .message-left .message-bubble {
            background: var(--message-bg-left);
            color: var(--primary-color);
        }

        .message-left .message-bubble::after {
            border-right-color: var(--message-bg-left);
            border-left: 0;
            left: -8px;
            top: 12px;
        }

        .message-right .message-bubble {
            background: var(--message-bg-right);
            color: var(--text-color);
        }

        .message-right .message-bubble::after {
            border-left-color: var(--message-bg-right);
            border-right: 0;
            right: -8px;
            top: 12px;
        }

        .message-image {
            max-width: 200px;
            border-radius: 10px;
            cursor: pointer;
            display: block;
        }

        .message-audio {
            max-width: 250px;
            border-radius: 20px; /* Mais arredondado para visual melhor */
            padding: 8px;
            background: #f0f0f0;
            display: flex;
            flex-direction: column;
            gap: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .waveform {
            display: flex;
            gap: 2px;
            flex: 1;
            height: 30px;
            align-items: flex-end;
        }

        .wave-bar {
            width: 4px;
            background: var(--primary-color);
            border-radius: 2px;
            transition: height 0.3s ease;
        }

        .fullscreen-image {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .fullscreen-image img {
            max-width: 90%;
            max-height: 90%;
            object-fit: contain;
        }

        .close-button {
            position: absolute;
            top: 20px;
            right: 20px;
            background: var(--secondary-color);
            color: var(--primary-color);
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            font-size: 20px;
        }

        .like-button, .quote-button, .delete-button {
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 4px;
            color: var(--primary-color);
            font-size: calc(var(--text-size) * 0.8);
            margin-top: 4px;
            background: #f0f0f0;
            border-radius: 20px;
            padding: 4px 8px;
            transition: background 0.3s;
        }

        .like-button:hover, .quote-button:hover, .delete-button:hover {
            background: var(--secondary-color);
        }

        .heart-rain {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 10;
        }

        .heart {
            position: absolute;
            color: var(--primary-color);
            font-size: 12px;
            opacity: 0;
            animation: heartRain 1s ease-out forwards;
        }

        @keyframes heartRain {
            0% { opacity: 1; transform: translateY(0) scale(1); }
            100% { opacity: 0; transform: translateY(100px) scale(0.5); }
        }

        .mention {
            color: var(--primary-color);
            font-weight: bold;
        }

        .typing-indicator {
            position: sticky;
            bottom: 60px;
            left: 16px;
            background: var(--secondary-color);
            border-radius: 15px;
            padding: 12px 16px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
            color: var(--text-color);
            font-size: calc(var(--text-size) * 0.9);
            display: flex;
            align-items: center;
            gap: 8px;
            animation: pulse 1.5s ease-in-out infinite;
            margin-top: 8px;
            width: fit-content;
            border: 2px solid var(--primary-color);
        }

        .typing-avatar {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            object-fit: cover;
        }

        .typing-text {
            font-weight: 600;
            font-size: calc(var(--text-size) * 1.1);
        }

        .dot {
            width: 6px;
            height: 6px;
            background: var(--primary-color);
            border-radius: 50%;
            animation: bounce 1.2s infinite ease-in-out;
        }

        .dot:nth-child(2) {
            animation-delay: -0.4s;
        }

        .dot:nth-child(3) {
            animation-delay: -0.8s;
        }

        @keyframes bounce {
            0%, 80%, 100% { transform: translateY(0); }
            40% { transform: translateY(-5px); }
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .chat-footer {
            background: var(--footer-bg);
            padding: 10px 16px;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 -2px 5px rgba(0, 0, 0, 0.1);
            z-index: 10;
            border-top-left-radius: 20px;
            border-top-right-radius: 20px;
            position: relative;
            flex-direction: column; /* Mudar para coluna para empilhar */
        }

        .chat-input {
            flex: 1;
            padding: 12px 16px;
            border: 2px solid var(--primary-color);
            border-radius: 20px;
            outline: none;
            font-size: var(--text-size);
            transition: border-color 0.3s ease, transform 0.2s ease;
            background: var(--background-color);
            color: var(--text-color);
            width: 100%; /* Para ocupar toda largura */
        }

        .chat-input:focus {
            border-color: var(--secondary-color);
            transform: scale(1.02);
        }

        .fab-container {
            position: relative;
            display: flex;
            align-items: center;
        }

        .fab-main {
            background: var(--primary-color);
            color: #ffffff;
            border: none;
            border-radius: 50%;
            width: 48px;
            height: 48px;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: transform 0.3s ease;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }

        .fab-main:hover {
            background: var(--secondary-color);
            color: var(--primary-color);
            transform: scale(1.1);
        }

        .fab-main.open {
            transform: rotate(45deg);
        }

        .fab-actions {
            position: absolute;
            bottom: 60px;
            right: 16px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            opacity: 0;
            pointer-events: none;
            transform: translateY(20px);
            transition: all 0.3s ease;
        }

        .fab-actions.open {
            opacity: 1;
            pointer-events: auto;
            transform: translateY(0);
        }

        .fab-action {
            background: var(--primary-color);
            color: #ffffff;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }

        .fab-action:hover {
            background: var(--secondary-color);
            color: var(--primary-color);
            transform: scale(1.1);
        }

        .fab-action.recording {
            background: var(--primary-color);
            animation: pulseRecording 1s infinite;
        }

        .fab-action:disabled {
            background: #cccccc;
            cursor: not-allowed;
            transform: none;
        }

        @keyframes pulseRecording {
            0% { transform: scale(1); }
            50% { transform: scale(1.15); }
            100% { transform: scale(1); }
        }

        .send-button {
            background: var(--primary-color);
            color: #ffffff;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            opacity: 0;
            transform: scale(0);
        }

        .send-button.visible {
            opacity: 1;
            transform: scale(1);
        }

        .send-button:hover {
            background: var(--secondary-color);
            color: var(--primary-color);
            transform: scale(1.1);
        }

        .fab-sub-menu {
            position: absolute;
            bottom: 60px;
            right: 60px;
            background-color: var(--background-color);
            min-width: 160px;
            box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
            z-index: 1000;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            display: none;
        }

        .fab-sub-menu.open {
            display: block;
        }

        .fab-sub-menu-item {
            color: var(--text-color);
            padding: 12px 16px;
            text-decoration: none;
            display: block;
            cursor: pointer;
            border-radius: 8px;
            margin: 4px;
            transition: background-color 0.3s;
        }

        .fab-sub-menu-item:hover {
            background-color: var(--secondary-color);
        }

        .recording-animation {
            position: absolute;
            bottom: 60px;
            left: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
            background: var(--secondary-color);
            border-radius: 20px; /* Mais arredondado */
            padding: 8px 16px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            z-index: 9;
            animation: slideIn 0.3s ease-out;
        }

        .recording-icon {
            font-size: 1.5rem;
            color: var(--primary-color);
            animation: pulseIcon 1.5s infinite;
        }

        .recording-wave {
            display: flex;
            gap: 4px;
            align-items: center;
        }

        .recording-wave-bar {
            width: 6px;
            background: var(--primary-color);
            border-radius: 3px;
            animation: wave 1.2s infinite ease-in-out;
        }

        .recording-wave-bar:nth-child(1) { height: 10px; animation-delay: 0s; }
        .recording-wave-bar:nth-child(2) { height: 20px; animation-delay: -0.3s; }
        .recording-wave-bar:nth-child(3) { height: 15px; animation-delay: -0.6s; }
        .recording-wave-bar:nth-child(4) { height: 25px; animation-delay: -0.9s; }
        .recording-wave-bar:nth-child(5) { height: 18px; animation-delay: -1.2s; }

        @keyframes wave {
            0%, 100% { transform: scaleY(1); }
            50% { transform: scaleY(1.5); }
        }

        @keyframes pulseIcon {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.3); }
        }

        @keyframes slideIn {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .progress-bar-container {
            position: absolute;
            bottom: 80px;
            left: 16px;
            width: 200px;
            background: var(--secondary-color);
            border-radius: 12px;
            padding: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            z-index: 9;
            animation: slideIn 0.3s ease-out;
        }

        .progress-bar {
            height: 8px;
            background: var(--progress-bar-bg);
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-bar-fill {
            height: 100%;
            background: var(--progress-bar-fill);
            transition: width 0.2s ease-in-out;
        }

        .progress-text {
            font-size: calc(var(--text-size) * 0.8);
            color: var(--primary-color);
            margin-top: 4px;
            text-align: center;
        }

        .quoted-message {
            background: var(--quoted-color);
            padding: 8px;
            border-radius: 8px;
            margin-bottom: 8px;
            border-left: 4px solid var(--primary-color);
        }

        .quoted-user {
            font-weight: bold;
            color: var(--primary-color);
        }

        .quoted-text {
            font-size: 0.9em;
        }

        .quoted-preview {
            background: var(--quoted-color);
            padding: 8px;
            border-radius: 8px;
            margin-bottom: 8px;
            display: flex;
            flex-direction: column; /* Mudar para coluna para empilhar */
            align-items: flex-start;
            width: 100%;
        }

        .quoted-preview button {
            background: transparent;
            border: none;
            color: var(--primary-color);
            cursor: pointer;
            align-self: flex-end;
        }

        .input-container {
            display: flex;
            align-items: center;
            gap: 8px;
            width: 100%;
        }

        .reply-text {
            color: var(--primary-color);
            font-size: calc(var(--text-size) * 0.8);
            margin-top: 4px;
        }

        .poll-container {
            margin-top: 8px;
        }

        .poll-bar {
            height: 8px;
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 4px;
        }

        .poll-bar-fill {
            height: 100%;
            transition: width 0.2s ease-in-out;
        }

        .poll-bar-sim {
            background: #4caf50; /* Verde para sim */
        }

        .poll-bar-nao {
            background: #f44336; /* Vermelho para não */
        }

        .winning {
            font-weight: bold;
        }

        .quoted-image {
            max-width: 100px;
            border-radius: 8px;
        }

        .quoted-audio {
            font-style: italic;
            color: var(--primary-color);
        }

        .stop-recording-button {
            background: var(--primary-color);
            color: #ffffff;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: transform 0.3s ease;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }

        .stop-recording-button:hover {
            transform: scale(1.1);
        }
    </style>
</head>
<body>
    <div class="loading-screen" id="loading-screen">
        <img
            src="https://i.postimg.cc/Ssk9kkHb/1757343420124.png"
            alt="GPV Logo"
            class="loading-logo"
        />
        <p class="loading-text">Iniciando GPV Chat...</p>
    </div>
    <div id="root"></div>
    <script type="text/babel">
        const AudioPlayer = ({ src }) => {
            const audioRef = React.useRef(null);
            const [isPlaying, setIsPlaying] = React.useState(false);
            const [progress, setProgress] = React.useState(0);
            const [duration, setDuration] = React.useState(0);
            const [waveHeights, setWaveHeights] = React.useState(Array(30).fill(1));

            React.useEffect(() => {
                if (audioRef.current) {
                    audioRef.current.addEventListener('loadedmetadata', () => {
                        setDuration(audioRef.current.duration);
                    });
                    audioRef.current.addEventListener('timeupdate', handleTimeUpdate);
                }
                return () => {
                    if (audioRef.current) {
                        audioRef.current.removeEventListener('timeupdate', handleTimeUpdate);
                    }
                };
            }, []);

            const togglePlay = () => {
                if (isPlaying) {
                    audioRef.current.pause();
                } else {
                    audioRef.current.play();
                }
                setIsPlaying(!isPlaying);
            };

            const handleTimeUpdate = () => {
                const current = audioRef.current.currentTime;
                const dur = audioRef.current.duration;
                const prog = (current / dur) * 100;
                setProgress(prog);

                // Simulate wave animation based on progress
                const newHeights = waveHeights.map((h, i) => {
                    const pos = i / waveHeights.length;
                    const dist = Math.abs(pos - (prog / 100));
                    return Math.max(1, 30 * (1 - dist * 5) + Math.random() * 5);
                });
                setWaveHeights(newHeights);
            };

            const handleSeek = (e) => {
                const seekTime = (e.target.value / 100) * audioRef.current.duration;
                audioRef.current.currentTime = seekTime;
                setProgress(e.target.value);
            };

            return (
                <div className="message-audio">
                    <button onClick={togglePlay} className="control-button">
                        <i className={`fas ${isPlaying ? 'fa-pause' : 'fa-play'}`}></i>
                    </button>
                    <div className="waveform">
                        {waveHeights.map((height, i) => (
                            <div
                                key={i}
                                className="wave-bar"
                                style={{ height: `${height}px` }}
                            ></div>
                        ))}
                    </div>
                    <input
                        type="range"
                        value={progress}
                        onChange={handleSeek}
                        min="0"
                        max="100"
                        className="w-full h-1 bg-gray-200 rounded-lg opacity-0 absolute" // Hide the straight line
                    />
                    <audio
                        ref={audioRef}
                        src={src}
                        onEnded={() => setIsPlaying(false)}
                    />
                </div>
            );
        };

        const PollComponent = ({ id, question, votes, onVote }) => {
            let options = [];
            let voteCounts = {};
            let total = 0;
            let pollQuestion = question;
            let isJsonPoll = false;

            try {
                const parsed = JSON.parse(question);
                if (parsed.options && Array.isArray(parsed.options)) {
                    isJsonPoll = true;
                    options = parsed.options;
                    pollQuestion = parsed.question || "Enquete";
                    options.forEach(opt => voteCounts[opt] = 0);
                    total = 0;
                }
            } catch {}

            if (isJsonPoll) {
                if (votes && votes.includes(':')) {
                    votes.split('-').forEach(part => {
                        if (part) {
                            const [opt, cnt] = part.split(':');
                            if (opt && options.includes(opt)) {
                                const count = parseInt(cnt, 10) || 0;
                                voteCounts[opt] = count;
                                total += count;
                            }
                        }
                    });
                }
            } else {
                if (votes && votes.includes(':')) {
                    votes.split('-').forEach(part => {
                        if (part) {
                            const [opt, cnt] = part.split(':');
                            if (opt) {
                                const count = parseInt(cnt, 10) || 0;
                                voteCounts[opt] = count;
                                total += count;
                            }
                        }
                    });
                    options = Object.keys(voteCounts);
                } else {
                    const voteArray = votes ? votes.split('-').filter(v => v) : [];
                    options = ['Sim', 'Não'];
                    voteCounts['Sim'] = voteArray.filter(v => v === 'sim').length;
                    voteCounts['Não'] = voteArray.filter(v => v === 'nao').length;
                    total = voteArray.length;
                }
            }

            const getPercent = (opt) => total > 0 ? (voteCounts[opt] / total) * 100 : 0;

            const maxCount = Math.max(...Object.values(voteCounts), 0);
            const winners = options.filter(opt => voteCounts[opt] === maxCount);
            const winnerText = winners.length > 1 ? 'Empate' : (winners[0] || 'Nenhum voto');

            const colors = ['#4caf50', '#f44336', '#2196f3', '#ffeb3b', '#9c27b0'];

            return (
                <div className="poll-container">
                    <p className="font-bold">{pollQuestion}</p>
                    {options.map((opt, index) => (
                        <div key={opt}>
                            <p>{opt}: {voteCounts[opt] || 0} ({getPercent(opt).toFixed(1)}%)</p>
                            <div className="poll-bar">
                                <div className="poll-bar-fill" style={{ width: `${getPercent(opt)}%`, background: colors[index % colors.length] }}></div>
                            </div>
                        </div>
                    ))}
                    <p className="winning">Vencedor atual: {winnerText}</p>
                    <div className="flex flex-wrap gap-2">
                        {options.map(opt => (
                            <button key={opt} onClick={() => onVote(id, opt)} className="bg-primary-color text-white px-4 py-2 rounded">{opt}</button>
                        ))}
                    </div>
                </div>
            );
        };

        const ChatMessage = ({ id, usuario, mensagem, data, fotoPerfil, isRight, mensacao, laughs, sads, arquivosGravados, quotedMsg, enquete, citacao, onLike, onLaugh, onSad, onQuote, onImageClick, onDelete, onVote }) => {
            const [isAnimating, setIsAnimating] = React.useState(false);
            const [hearts, setHearts] = React.useState([]);
            
            const formatDate = (dateString) => {
                const date = new Date(dateString);
                return date.toLocaleString('pt-BR', {
                    hour: '2-digit',
                    minute: '2-digit'
                });
            };

            const handleLike = () => {
                if (!isAnimating) {
                    setIsAnimating(true);
                    const newHearts = Array.from({ length: 10 }, (_, i) => ({
                        id: i,
                        left: `${Math.random() * 100}%`,
                        animationDelay: `${Math.random() * 0.5}s`
                    }));
                    setHearts(newHearts);
                    onLike(id, mensacao);
                    setTimeout(() => {
                        setIsAnimating(false);
                        setHearts([]);
                    }, 1000);
                }
            };

            const handleLaugh = () => {
                onLaugh(id, laughs);
            };

            const handleSad = () => {
                onSad(id, sads);
            };

            const handleQuote = () => {
                onQuote({ id, usuario, mensagem, data, fotoPerfil, mensacao, laughs, sads, arquivosGravados });
            };

            const handleDelete = async () => {
                if (window.confirm('Tem certeza que deseja apagar esta mensagem para todos?')) {
                    onDelete(id);
                }
            };

            const isImage = /\.(jpg|png|gif)$/i.test(mensagem);
            const isVideo = /\.(mp4|webm|ogg)$/i.test(mensagem);
            let pollOptions = null;
            let pollQuestion = mensagem;
            try {
                const parsed = JSON.parse(mensagem);
                if (parsed.options && Array.isArray(parsed.options)) {
                    pollOptions = parsed.options;
                    pollQuestion = parsed.question || "Enquete";
                }
            } catch {}
            const isPoll = (enquete && enquete.trim() !== '') || pollOptions !== null;
            const cleanMessage = mensagem ? mensagem.replace(/[\r\n]+/g, ' ').trim() : '';
            const parts = cleanMessage.split(/(@\w+)/g);
            const renderedMessage = parts.map((part, index) => {
                if (part.startsWith('@')) {
                    return <span key={index} className="mention">{part}</span>;
                }
                return part;
            });

            const likeCount = parseInt(mensacao || '0', 10);
            const laughCount = parseInt(laughs || '0', 10);
            const sadCount = parseInt(sads || '0', 10);
            const likeText = likeCount > 0 ? `${likeCount} ❤️` : '';
            const laughText = laughCount > 0 ? `${laughCount} 😂` : '';
            const sadText = sadCount > 0 ? `${sadCount} 😢` : '';
            const audioFile = arquivosGravados && arquivosGravados.length > 0 ? arquivosGravados[0] : null;
            const replyText = quotedMsg ? 'Resposta ao' : '';
            const userDisplay = usuario && usuario !== 'string' ? usuario : 'Anônimo';

            let quotedContent = null;
            if (quotedMsg) {
                const qIsImage = /\.(jpg|png|gif)$/i.test(quotedMsg.DIGIOTOU);
                const qIsAudio = quotedMsg.ArquivosGravados && quotedMsg.ArquivosGravados.length > 0;
                if (qIsImage) {
                    quotedContent = <img src={quotedMsg.DIGIOTOU} alt="Imagem citada" className="quoted-image" />;
                } else if (qIsAudio) {
                    quotedContent = <p className="quoted-audio">Áudio citado</p>;
                } else {
                    quotedContent = <p className="quoted-text">{quotedMsg.DIGIOTOU}</p>;
                }
            }

            return (
                <div className={`flex ${isRight ? 'justify-end' : 'justify-start'} mb-4 message message-${isRight ? 'right' : 'left'}`}>
                    <div className={`flex ${isRight ? 'flex-row-reverse' : 'flex-row'} items-start w-full`}>
                        <img
                            src={fotoPerfil || 'https://i.postimg.cc/Ssk9kkHb/1757343420124.png'}
                            alt="Profile"
                            className="w-10 h-10 rounded-full object-cover mt-2"
                        />
                        <div className="flex flex-col mx-2 w-full relative">
                            <div className={`message-bubble ${isAnimating ? 'radiate' : ''}`}>
                                <span className="text-xs font-semibold" style={{ color: isRight ? 'var(--primary-color)' : '#ffffff' }}>{userDisplay}</span>
                                {quotedMsg && (
                                    <div className="quoted-message">
                                        <span className="quoted-user">{quotedMsg.Usuario}</span>
                                        {quotedContent}
                                    </div>
                                )}
                                {citacao && <p className="quoted-text">{citacao}</p>}
                                {isPoll ? (
                                    <PollComponent id={id} question={pollQuestion} votes={enquete} onVote={onVote} />
                                ) : isImage ? (
                                    <img
                                        src={mensagem}
                                        alt="Message"
                                        className="message-image"
                                        onClick={() => onImageClick(mensagem)}
                                    />
                                ) : isVideo ? (
                                    <video
                                        src={mensagem}
                                        controls
                                        className="message-image"
                                    />
                                ) : audioFile ? (
                                    <AudioPlayer src={audioFile.url} />
                                ) : (
                                    mensagem && <p className="text-sm leading-relaxed mt-1">{renderedMessage}</p>
                                )}
                                <div className="flex items-center justify-end mt-1">
                                    <span className="text-xs text-gray-500">{formatDate(data)}</span>
                                    {isRight && <i className="fas fa-check text-xs text-gray-500 ml-1"></i>}
                                </div>
                            </div>
                            <div className="heart-rain">
                                {hearts.map(heart => (
                                    <i
                                        key={heart.id}
                                        className="fas fa-heart heart"
                                        style={{
                                            left: heart.left,
                                            animationDelay: heart.animationDelay
                                        }}
                                    ></i>
                                ))}
                            </div>
                            <div className="flex gap-2">
                                {!isRight && (
                                    <div className="like-button" onClick={handleLike}>
                                        <i className="fas fa-heart"></i>
                                        <span>{likeCount}</span>
                                    </div>
                                )}
                                {!isRight && (
                                    <div className="laugh-button" onClick={handleLaugh}>
                                        <i className="fas fa-laugh"></i>
                                        <span>{laughCount}</span>
                                    </div>
                                )}
                                {!isRight && (
                                    <div className="sad-button" onClick={handleSad}>
                                        <i className="fas fa-sad-tear"></i>
                                        <span>{sadCount}</span>
                                    </div>
                                )}
                                {!isRight && (
                                    <div className="quote-button" onClick={handleQuote}>
                                        <i className="fas fa-reply"></i>
                                    </div>
                                )}
                                <div className="delete-button" onClick={handleDelete}>
                                    <i className="fas fa-trash"></i>
                                </div>
                            </div>
                            {replyText && <span className="reply-text">{replyText}</span>}
                            {likeText && <span className="text-xs text-gray-500">{likeText}</span>}
                        </div>
                    </div>
                </div>
            );
        };

        const FullscreenImage = ({ src, onClose }) => {
            return (
                <div className="fullscreen-image" onClick={onClose}>
                    <img src={src} alt="Fullscreen" />
                    <button className="close-button" onClick={onClose}>
                        <i className="fas fa-times"></i>
                    </button>
                </div>
            );
        };

        const RecordingAnimation = ({ duration, onStop }) => {
            return (
                <div className="recording-animation">
                    <i className="fas fa-microphone recording-icon"></i>
                    <div className="recording-wave">
                        <div className="recording-wave-bar"></div>
                        <div className="recording-wave-bar"></div>
                        <div className="recording-wave-bar"></div>
                        <div className="recording-wave-bar"></div>
                        <div className="recording-wave-bar"></div>
                    </div>
                    <span className="text-xs font-semibold" style={{ color: 'var(--primary-color)' }}>
                        Gravando... {duration}s
                    </span>
                    <button className="stop-recording-button" onClick={onStop}>
                        <i className="fas fa-stop"></i>
                    </button>
                </div>
            );
        };

        const ProgressBar = ({ progress }) => {
            return (
                <div className="progress-bar-container">
                    <div className="progress-bar">
                        <div
                            className="progress-bar-fill"
                            style={{ width: `${progress}%` }}
                        ></div>
                    </div>
                    <div className="progress-text">Enviando: {Math.round(progress)}%</div>
                </div>
            );
        };

        const TypingIndicator = ({ user, avatar }) => {
            return (
                <div className="typing-indicator">
                    <img src={avatar || 'https://i.postimg.cc/Ssk9kkHb/1757343420124.png'} 
                         alt="Avatar" className="typing-avatar" />
                    <span className="typing-text">{user} está digitando</span>
                    <div className="flex gap-1">
                        <div className="dot"></div>
                        <div className="dot"></div>
                        <div className="dot"></div>
                    </div>
                </div>
            );
        };

        const ChatApp = () => {
            const [messages, setMessages] = React.useState([]);
            const [typingUser, setTypingUser] = React.useState(null);
            const [typingUserData, setTypingUserData] = React.useState(null);
            const [isLoading, setIsLoading] = React.useState(true);
            const [fullscreenImage, setFullscreenImage] = React.useState(null);
            const [inputText, setInputText] = React.useState('');
            const [isRecording, setIsRecording] = React.useState(false);
            const [userData, setUserData] = React.useState(null);
            const [currentUserId, setCurrentUserId] = React.useState(null);
            const [mediaRecorder, setMediaRecorder] = React.useState(null);
            const [theme, setTheme] = React.useState('light');
            const [fontSize, setFontSize] = React.useState('medium');
            const [showThemeMenu, setShowThemeMenu] = React.useState(false);
            const [showFontMenu, setShowFontMenu] = React.useState(false);
            const [uploadProgress, setUploadProgress] = React.useState(null);
            const [fabOpen, setFabOpen] = React.useState(false);
            const [recordingDuration, setRecordingDuration] = React.useState(0);
            const [quotedMessage, setQuotedMessage] = React.useState(null);
            const messagesEndRef = React.useRef(null);

            const currentUser = userData?.NOME || "Usuário";
            const defaultProfilePic = 'https://i.postimg.cc/Ssk9kkHb/1757343420124.png';
            const apiToken = 'UkqZsuMMnwE59fMqs8OwXX60SASP7FOd';

            // Mock data for fallback
            const mockMessages = [
                {
                    id: 1,
                    Usuario: "Usuário Mock",
                    DIGIOTOU: "Bem-vindo ao GPV Chat!",
                    DATAENVIO: new Date().toISOString(),
                    FOTOPERFIL: defaultProfilePic,
                    mensacao: '0',
                    laughs: '0',
                    sads: '0',
                    ArquivosGravados: [],
                    enquete: null,
                    citacao: null
                },
                {
                    id: 2,
                    Usuario: currentUser,
                    DIGIOTOU: "Testando o chat!",
                    DATAENVIO: new Date().toISOString(),
                    FOTOPERFIL: defaultProfilePic,
                    mensacao: '1',
                    laughs: '0',
                    sads: '0',
                    ArquivosGravados: [],
                    enquete: null,
                    citacao: null
                }
            ];

            const mockUserData = {
                NOME: "Usuário",
                PERFIL: defaultProfilePic
            };

            const mockTypingUser = {
                DigitandoUser: "Usuário Mock",
                PERFIL: defaultProfilePic
            };

            // Aplicar tema e tamanho da fonte
            React.useEffect(() => {
                document.body.setAttribute('data-theme', theme);
                document.body.className = `text-${fontSize}`;
            }, [theme, fontSize]);

            // Atualizar status de digitação
            const updateTypingStatus = async (isTyping) => {
                if (!currentUserId) return;
                try {
                    await axios({
                        method: 'PATCH',
                        url: `https://api.baserow.io/api/database/rows/table/314649/${currentUserId}/?user_field_names=true`,
                        headers: { Authorization: `Token ${apiToken}` },
                        data: {
                            digitandotruefalse: isTyping ? 'true' : 'false',
                            DigitandoUser: currentUser
                        }
                    });
                    console.log('Status de digitação atualizado:', isTyping);
                } catch (error) {
                    console.error('Erro ao atualizar status de digitação:', error);
                    // Não bloqueia a aplicação
                }
            };

            const createField = async (name, type) => {
                try {
                    const response = await axios({
                        method: 'GET',
                        url: 'https://api.baserow.io/api/database/fields/table/459281/',
                        headers: { Authorization: `Token ${apiToken}` }
                    });
                    const fields = response.data;
                    const hasColumn = fields.some(field => field.name === name);
                    if (!hasColumn) {
                        await axios({
                            method: 'POST',
                            url: 'https://api.baserow.io/api/database/fields/table/459281/',
                            headers: { Authorization: `Token ${apiToken}` },
                            data: {
                                name: name,
                                type: type
                            }
                        });
                        console.log(`Coluna ${name} criada com sucesso`);
                    }
                } catch (error) {
                    console.error(`Erro ao criar/verificar coluna ${name}:`, error);
                }
            };

            const initializeColumns = async () => {
                await createField('ArquivosGravados', 'file');
                await createField('QuotedId', 'text');
                await createField('citacao', 'text');
                await createField('enquete', 'text');
                await createField('laughs', 'text');
                await createField('sads', 'text');
            };

            const fetchUserData = async () => {
                try {
                    const response = await axios({
                        method: 'GET',
                        url: 'https://api.baserow.io/api/database/rows/table/221009/?user_field_names=true',
                        headers: { Authorization: `Token ${apiToken}` }
                    });
                    const results = response.data.results;
                    // Procurar pela linha onde ultimoclick não está vazio
                    const activeUserRow = results.find(row => row.ultimoclick && row.ultimoclick.trim() !== '');
                    if (activeUserRow) {
                        const userId = activeUserRow.id;
                        setCurrentUserId(userId);
                        setUserData({ NOME: activeUserRow.NOME, PERFIL: activeUserRow.PERFIL });
                        console.log('Usuário ativo encontrado:', activeUserRow);
                        // Limpar o campo ultimoclick
                        await axios({
                            method: 'PATCH',
                            url: `https://api.baserow.io/api/database/rows/table/221009/${userId}/?user_field_names=true`,
                            headers: { Authorization: `Token ${apiToken}` },
                            data: { ultimoclick: '' }
                        });
                        console.log('Campo ultimoclick limpo com sucesso');
                    } else {
                        console.error('Nenhum usuário ativo encontrado (ultimoclick vazio)');
                        // Fallback para mock
                        setCurrentUserId(340); // ou outro fallback
                        setUserData(mockUserData);
                    }
                } catch (error) {
                    console.error('Erro ao buscar dados do usuário:', error);
                    console.log('Usando dados mock para usuário');
                    setCurrentUserId(340);
                    setUserData(mockUserData);
                }
            };

            const fetchMessages = async () => {
                try {
                    const response = await axios({
                        method: 'GET',
                        url: 'https://api.baserow.io/api/database/rows/table/459281/?user_field_names=true',
                        headers: { Authorization: `Token ${apiToken}` }
                    });
                    const results = response.data.results;
                    const processedMessages = results.map(msg => {
                        if (msg.QuotedId) {
                            const quotedId = parseInt(msg.QuotedId, 10);
                            const quotedMsg = results.find(m => m.id === quotedId);
                            return { ...msg, quotedMsg };
                        }
                        return msg;
                    });
                    setMessages(processedMessages);
                    console.log('Mensagens obtidas:', processedMessages);
                } catch (error) {
                    console.error('Erro ao buscar mensagens:', error);
                    console.log('Usando mensagens mock devido a erro na API');
                    setMessages(mockMessages);
                }
            };

            const fetchTypingStatus = async () => {
                try {
                    const response = await axios({
                        method: 'GET',
                        url: 'https://api.baserow.io/api/database/rows/table/314649/?user_field_names=true',
                        headers: { Authorization: `Token ${apiToken}` }
                    });
                    const typingData = response.data.results.find(user => user.digitandotruefalse === 'true' && user.DigitandoUser !== currentUser);
                    if (typingData) {
                        setTypingUser(typingData.DigitandoUser);
                        console.log('Usuário digitando detectado:', typingData.DigitandoUser);
                        try {
                            const userResponse = await axios({
                                method: 'GET',
                                url: `https://api.baserow.io/api/database/rows/table/221009/?user_field_names=true`,
                                headers: { Authorization: `Token ${apiToken}` }
                            });
                            const userData = userResponse.data.results.find(user => user.NOME === typingData.DigitandoUser);
                            setTypingUserData(userData || mockTypingUser);
                            console.log('Dados do usuário digitando:', userData || mockTypingUser);
                        } catch (error) {
                            console.error('Erro ao buscar dados do usuário digitando:', error);
                            setTypingUserData(mockTypingUser);
                        }
                    } else {
                        setTypingUser(null);
                        setTypingUserData(null);
                        console.log('Nenhum usuário digitando.');
                    }
                } catch (error) {
                    console.error('Erro ao buscar status de digitação:', error);
                    console.log('Usando dados mock para status de digitação');
                    setTypingUser(mockTypingUser.DigitandoUser);
                    setTypingUserData(mockTypingUser);
                }
            };

            const likeMessage = async (id, currentLikes) => {
                try {
                    const currentCount = parseInt(currentLikes || '0', 10);
                    const newCount = currentCount + 1;
                    await axios({
                        method: 'PATCH',
                        url: `https://api.baserow.io/api/database/rows/table/459281/${id}/?user_field_names=true`,
                        data: { mensacao: newCount.toString() },
                        headers: { Authorization: `Token ${apiToken}` }
                    });
                    fetchMessages();
                } catch (error) {
                    console.error('Erro ao curtir mensagem:', error);
                    // Simula curtida localmente
                    setMessages(messages.map(msg => msg.id === id ? { ...msg, mensacao: (parseInt(msg.mensacao || '0', 10) + 1).toString() } : msg));
                }
            };

            const laughMessage = async (id, currentLaughs) => {
                try {
                    const currentCount = parseInt(currentLaughs || '0', 10);
                    const newCount = currentCount + 1;
                    await axios({
                        method: 'PATCH',
                        url: `https://api.baserow.io/api/database/rows/table/459281/${id}/?user_field_names=true`,
                        data: { laughs: newCount.toString() },
                        headers: { Authorization: `Token ${apiToken}` }
                    });
                    fetchMessages();
                } catch (error) {
                    console.error('Erro ao reagir com riso:', error);
                    setMessages(messages.map(msg => msg.id === id ? { ...msg, laughs: (parseInt(msg.laughs || '0', 10) + 1).toString() } : msg));
                }
            };

            const sadMessage = async (id, currentSads) => {
                try {
                    const currentCount = parseInt(currentSads || '0', 10);
                    const newCount = currentCount + 1;
                    await axios({
                        method: 'PATCH',
                        url: `https://api.baserow.io/api/database/rows/table/459281/${id}/?user_field_names=true`,
                        data: { sads: newCount.toString() },
                        headers: { Authorization: `Token ${apiToken}` }
                    });
                    fetchMessages();
                } catch (error) {
                    console.error('Erro ao reagir com tristeza:', error);
                    setMessages(messages.map(msg => msg.id === id ? { ...msg, sads: (parseInt(msg.sads || '0', 10) + 1).toString() } : msg));
                }
            };

            const votePoll = async (id, vote) => {
                try {
                    const response = await axios({
                        method: 'GET',
                        url: `https://api.baserow.io/api/database/rows/table/459281/${id}/?user_field_names=true`,
                        headers: { Authorization: `Token ${apiToken}` }
                    });
                    let currentVotes = response.data.enquete || '';
                    if (!currentVotes) {
                        const msg = response.data.DIGIOTOU;
                        try {
                            const parsed = JSON.parse(msg);
                            if (parsed.options && Array.isArray(parsed.options)) {
                                currentVotes = parsed.options.map(o => `${o}:0`).join('-');
                            }
                        } catch {}
                    }
                    let newVotes = '';
                    if (currentVotes.includes(':')) {
                        let voteMap = {};
                        currentVotes.split('-').forEach(part => {
                            if (part) {
                                const [opt, cnt] = part.split(':');
                                voteMap[opt] = parseInt(cnt, 10) || 0;
                            }
                        });
                        if (voteMap.hasOwnProperty(vote)) {
                            voteMap[vote] += 1;
                        }
                        newVotes = Object.entries(voteMap).map(([opt, cnt]) => `${opt}:${cnt}`).join('-');
                    } else {
                        newVotes = currentVotes ? currentVotes + '-' + vote.toLowerCase() : vote.toLowerCase();
                    }
                    await axios({
                        method: 'PATCH',
                        url: `https://api.baserow.io/api/database/rows/table/459281/${id}/?user_field_names=true`,
                        data: { enquete: newVotes },
                        headers: { Authorization: `Token ${apiToken}` }
                    });
                    fetchMessages();
                } catch (error) {
                    console.error('Erro ao votar na enquete:', error);
                }
            };

            const deleteMessage = async (id) => {
                try {
                    await axios({
                        method: 'DELETE',
                        url: `https://api.baserow.io/api/database/rows/table/459281/${id}/`,
                        headers: { Authorization: `Token ${apiToken}` }
                    });
                    fetchMessages();
                } catch (error) {
                    console.error('Erro ao apagar mensagem:', error);
                }
            };

            const deleteAllMessages = async () => {
                const password = prompt('Digite a senha para apagar todas as mensagens:');
                if (password === 'admincordeiro') {
                    try {
                        for (const msg of messages) {
                            await axios({
                                method: 'DELETE',
                                url: `https://api.baserow.io/api/database/rows/table/459281/${msg.id}/`,
                                headers: { Authorization: `Token ${apiToken}` }
                            });
                        }
                        fetchMessages();
                    } catch (error) {
                        console.error('Erro ao apagar todas as mensagens:', error);
                    }
                } else {
                    alert('Senha incorreta!');
                }
            };

            const createPoll = async () => {
                const fullInput = prompt('Digite a pergunta da enquete seguida das opções separadas por vírgula (ex: Quem vai ganhar, Eu, Jornane):');
                if (fullInput) {
                    const parts = fullInput.split(',');
                    const question = parts[0].trim();
                    const options = parts.slice(1).map(o => o.trim()).filter(o => o);
                    if (options.length < 2) {
                        alert('Por favor, forneça pelo menos duas opções.');
                        return;
                    }
                    const pollData = { question, options };
                    const initialVotes = options.map(o => `${o}:0`).join('-');
                    await handleSendMessage(null, JSON.stringify(pollData), initialVotes);
                }
            };

            const uploadFile = async (file, fileName) => {
                try {
                    const formData = new FormData();
                    formData.append('file', file, fileName);
                    const response = await axios({
                        method: 'POST',
                        url: 'https://api.baserow.io/api/user-files/upload-file/',
                        headers: {
                            Authorization: `Token ${apiToken}`,
                            'Content-Type': 'multipart/form-data'
                        },
                        data: formData,
                        onUploadProgress: (progressEvent) => {
                            const percentCompleted = Math.round((progressEvent.loaded * 100) / progressEvent.total);
                            setUploadProgress(percentCompleted);
                        }
                    });
                    setUploadProgress(null);
                    return response.data;
                } catch (error) {
                    console.error('Erro ao fazer upload do arquivo:', error);
                    setUploadProgress(null);
                    return null;
                }
            };

            const handleSendMessage = async (fileData = null, pollJson = null, initialVotes = '') => {
                if (inputText.trim() || fileData || pollJson) {
                    try {
                        const data = {
                            Usuario: currentUser,
                            DIGIOTOU: pollJson || inputText || (fileData && !fileData.isAudio ? fileData.url : ''),
                            DATAENVIO: new Date().toISOString(),
                            FOTOPERFIL: userData?.PERFIL || defaultProfilePic,
                            mensacao: '0'
                        };
                        if (quotedMessage) {
                            data.QuotedId = quotedMessage.id.toString();
                        }
                        if (fileData && fileData.isAudio) {
                            data.ArquivosGravados = [{ name: fileData.name, url: fileData.url }];
                        }
                        if (pollJson) {
                            data.enquete = initialVotes;
                        }
                        await axios({
                            method: 'POST',
                            url: 'https://api.baserow.io/api/database/rows/table/459281/?user_field_names=true',
                            data,
                            headers: { Authorization: `Token ${apiToken}` }
                        });
                        setInputText('');
                        setQuotedMessage(null);
                        fetchMessages();
                    } catch (error) {
                        console.error('Erro ao enviar mensagem:', error);
                        console.log('Adicionando mensagem localmente devido a erro na API');
                        setMessages([...messages, {
                            id: Date.now(),
                            Usuario: currentUser,
                            DIGIOTOU: pollJson || inputText || (fileData && !fileData.isAudio ? fileData.url : ''),
                            DATAENVIO: new Date().toISOString(),
                            FOTOPERFIL: userData?.PERFIL || defaultProfilePic,
                            mensacao: '0',
                            QuotedId: quotedMessage ? quotedMessage.id.toString() : null,
                            ArquivosGravados: fileData && fileData.isAudio ? [{ name: fileData.name, url: fileData.url }] : [],
                            enquete: pollJson ? initialVotes : null
                        }]);
                        setInputText('');
                        setQuotedMessage(null);
                    }
                }
            };

            const handleImageClick = (src) => {
                setFullscreenImage(src);
            };

            const closeFullscreenImage = () => {
                setFullscreenImage(null);
            };

            const stopRecording = () => {
                if (mediaRecorder) {
                    mediaRecorder.stop();
                }
                setIsRecording(false);
                setFabOpen(false);
            };

            const handleRecordAudio = async () => {
                if (isRecording) {
                    stopRecording();
                    return;
                }

                try {
                    console.log('Tentando acessar o microfone...');
                    if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                        alert('Seu navegador não suporta gravação de áudio. Tente usar outro navegador, como Chrome ou Firefox.');
                        return;
                    }

                    const permissionStatus = await navigator.permissions.query({ name: 'microphone' });
                    console.log('Status da permissão do microfone:', permissionStatus.state);
                    if (permissionStatus.state === 'denied') {
                        alert('Permissão de microfone negada. Por favor, habilite o acesso ao microfone nas configurações do navegador.');
                        return;
                    }

                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    console.log('Microfone acessado com sucesso');
                    const recorder = new MediaRecorder(stream);
                    const audioChunks = [];
                    const startTime = Date.now();

                    const updateDuration = () => {
                        setRecordingDuration(Math.floor((Date.now() - startTime) / 1000));
                    };

                    const durationInterval = setInterval(updateDuration, 1000);

                    recorder.ondataavailable = (event) => {
                        audioChunks.push(event.data);
                        console.log('Dados de áudio recebidos:', event.data);
                    };

                    recorder.onstop = async () => {
                        clearInterval(durationInterval);
                        setRecordingDuration(0);
                        console.log('Gravação parada, processando áudio...');
                        const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                        const audioFile = await uploadFile(audioBlob, `audio_${Date.now()}.webm`);
                        if (audioFile) {
                            console.log('Áudio enviado com sucesso:', audioFile);
                            await handleSendMessage({ ...audioFile, isAudio: true });
                        } else {
                            console.error('Falha ao enviar áudio');
                            // Simula envio local
                            const mockAudio = { url: URL.createObjectURL(audioBlob), name: `audio_${Date.now()}.webm`, isAudio: true };
                            await handleSendMessage(mockAudio);
                        }
                        stream.getTracks().forEach(track => track.stop());
                        setIsRecording(false);
                        setMediaRecorder(null);
                    };

                    recorder.onerror = (error) => {
                        clearInterval(durationInterval);
                        setRecordingDuration(0);
                        console.error('Erro na gravação de áudio:', error);
                        alert('Erro ao gravar áudio. Verifique as permissões do microfone ou tente novamente.');
                        stream.getTracks().forEach(track => track.stop());
                        setIsRecording(false);
                        setMediaRecorder(null);
                    };

                    recorder.start();
                    console.log('Gravação iniciada');
                    setMediaRecorder(recorder);
                    setIsRecording(true);
                    setFabOpen(false);
                } catch (error) {
                    console.error('Erro ao iniciar gravação:', error);
                    alert('Não foi possível acessar o microfone. Verifique se está usando HTTPS, as permissões do navegador ou tente novamente.');
                    setIsRecording(false);
                }
            };

            const handleUploadPhoto = () => {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = 'image/*';
                input.onchange = async (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        try {
                            const fileData = await uploadFile(file, file.name);
                            if (fileData) {
                                await handleSendMessage(fileData);
                            } else {
                                // Simula envio local
                                const mockFile = { url: URL.createObjectURL(file), name: file.name };
                                await handleSendMessage(mockFile);
                            }
                        } catch (error) {
                            console.error('Erro ao enviar foto:', error);
                            alert('Falha ao enviar a foto. Tente novamente.');
                        }
                    }
                };
                input.click();
                setFabOpen(false);
            };

            const handleUploadAudio = () => {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = 'audio/*';
                input.onchange = async (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        try {
                            const fileData = await uploadFile(file, file.name);
                            if (fileData) {
                                await handleSendMessage({ ...fileData, isAudio: true });
                            } else {
                                // Simula envio local
                                const mockFile = { url: URL.createObjectURL(file), name: file.name, isAudio: true };
                                await handleSendMessage(mockFile);
                            }
                        } catch (error) {
                            console.error('Erro ao enviar áudio:', error);
                            alert('Falha ao enviar o áudio. Tente novamente.');
                        }
                    }
                };
                input.click();
                setFabOpen(false);
            };

            const handleUploadVideo = () => {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = 'video/*';
                input.onchange = async (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        try {
                            const fileData = await uploadFile(file, file.name);
                            if (fileData) {
                                await handleSendMessage(fileData);
                            } else {
                                // Simula envio local
                                const mockFile = { url: URL.createObjectURL(file), name: file.name };
                                await handleSendMessage(mockFile);
                            }
                        } catch (error) {
                            console.error('Erro ao enviar vídeo:', error);
                            alert('Falha ao enviar o vídeo. Tente novamente.');
                        }
                    }
                };
                input.click();
                setFabOpen(false);
            };

            const handleKeyPress = (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    handleSendMessage();
                    setFabOpen(false);
                }
            };

            const handleInputChange = (e) => {
                setInputText(e.target.value);
                updateTypingStatus(e.target.value.length > 0);
            };

            const toggleFab = () => {
                setFabOpen(!fabOpen);
                setShowThemeMenu(false);
                setShowFontMenu(false);
            };

            const toggleThemeMenu = () => {
                setShowThemeMenu(!showThemeMenu);
                setShowFontMenu(false);
            };

            const toggleFontMenu = () => {
                setShowFontMenu(!showFontMenu);
                setShowThemeMenu(false);
            };

            const changeTheme = (newTheme) => {
                setTheme(newTheme);
                setShowThemeMenu(false);
                setFabOpen(false);
            };

            const changeFontSize = (newSize) => {
                setFontSize(newSize);
                setShowFontMenu(false);
                setFabOpen(false);
            };

            React.useEffect(() => {
                const initializeApp = async () => {
                    try {
                        console.log('Iniciando inicialização do aplicativo...');
                        await initializeColumns();
                        await Promise.allSettled([
                            fetchUserData().catch(err => console.error('Falha em fetchUserData:', err)),
                            fetchMessages().catch(err => console.error('Falha em fetchMessages:', err)),
                            fetchTypingStatus().catch(err => console.error('Falha em fetchTypingStatus:', err))
                        ]);
                        console.log('Inicialização concluída, ocultando tela de carregamento...');
                        setTimeout(() => {
                            setIsLoading(false);
                            const loadingScreen = document.getElementById('loading-screen');
                            if (loadingScreen) {
                                loadingScreen.classList.add('hidden');
                            }
                        }, 1000);
                    } catch (error) {
                        console.error('Erro geral na inicialização do aplicativo:', error);
                        console.log('Usando dados mock devido a erro geral');
                        setCurrentUserId(340);
                        setUserData(mockUserData);
                        setMessages(mockMessages);
                        setTypingUser(mockTypingUser.DigitandoUser);
                        setTypingUserData(mockTypingUser);
                        setIsLoading(false);
                        const loadingScreen = document.getElementById('loading-screen');
                        if (loadingScreen) {
                            loadingScreen.classList.add('hidden');
                        }
                    }
                };
                initializeApp();
                const messageInterval = setInterval(fetchMessages, 5000);
                const typingInterval = setInterval(fetchTypingStatus, 2000);
                return () => {
                    clearInterval(messageInterval);
                    clearInterval(typingInterval);
                    if (mediaRecorder) {
                        mediaRecorder.stop();
                    }
                };
            }, [currentUserId]); // Dependência em currentUserId para refetch se necessário

            React.useEffect(() => {
                const handleClickOutside = (event) => {
                    if (!event.target.closest('.fab-container') && !event.target.closest('.fab-sub-menu')) {
                        setShowThemeMenu(false);
                        setShowFontMenu(false);
                        setFabOpen(false);
                    }
                };
                document.addEventListener('mousedown', handleClickOutside);
                return () => {
                    document.removeEventListener('mousedown', handleClickOutside);
                };
            }, []);

            return (
                <div className="chat-container">
                    <div className="chat-header">
                        {/* Título removido */}
                    </div>
                    <div className="chat-messages">
                        {messages.map((msg) => (
                            <ChatMessage
                                key={msg.id}
                                id={msg.id}
                                usuario={msg.Usuario}
                                mensagem={msg.DIGIOTOU}
                                data={msg.DATAENVIO}
                                fotoPerfil={msg.FOTOPERFIL}
                                isRight={msg.Usuario === currentUser}
                                mensacao={msg.mensacao}
                                laughs={msg.laughs}
                                sads={msg.sads}
                                arquivosGravados={msg.ArquivosGravados}
                                quotedMsg={msg.quotedMsg}
                                enquete={msg.enquete}
                                citacao={msg.citacao}
                                onLike={likeMessage}
                                onLaugh={laughMessage}
                                onSad={sadMessage}
                                onQuote={setQuotedMessage}
                                onImageClick={handleImageClick}
                                onDelete={deleteMessage}
                                onVote={votePoll}
                            />
                        ))}
                        {typingUser && (
                            <TypingIndicator 
                                user={typingUser} 
                                avatar={typingUserData?.PERFIL || defaultProfilePic} 
                            />
                        )}
                        <div ref={messagesEndRef} />
                    </div>
                    <div className="chat-footer">
                        {isRecording && <RecordingAnimation duration={recordingDuration} onStop={stopRecording} />}
                        {uploadProgress !== null && <ProgressBar progress={uploadProgress} />}
                        {quotedMessage && (
                            <div className="quoted-preview">
                                <span>Citando {quotedMessage.usuario}:</span>
                                <p>{quotedMessage.mensagem.substring(0, 50)}...</p>
                                <button onClick={() => setQuotedMessage(null)}>X</button>
                            </div>
                        )}
                        <div className="input-container">
                            <input
                                type="text"
                                className="chat-input"
                                placeholder="Digite uma mensagem..."
                                value={inputText}
                                onChange={handleInputChange}
                                onKeyPress={handleKeyPress}
                            />
                            <button
                                className={`send-button ${inputText.trim() ? 'visible' : ''}`}
                                onClick={() => handleSendMessage()}
                                disabled={!inputText.trim()}
                                title="Enviar mensagem"
                            >
                                <i className="fas fa-paper-plane"></i>
                            </button>
                            <div className="fab-container">
                                <button
                                    className={`fab-main ${fabOpen ? 'open' : ''}`}
                                    onClick={toggleFab}
                                    title="Mais opções"
                                >
                                    <i className="fas fa-plus"></i>
                                </button>
                                <div className={`fab-actions ${fabOpen ? 'open' : ''}`}>
                                    <button
                                        className={`fab-action ${isRecording ? 'recording' : ''}`}
                                        onClick={handleRecordAudio}
                                        title={isRecording ? 'Parar gravação' : 'Gravar áudio'}
                                        disabled={isRecording && !mediaRecorder}
                                    >
                                        <i className="fas fa-microphone"></i>
                                    </button>
                                    <button className="fab-action" onClick={handleUploadPhoto} title="Enviar foto">
                                        <i className="fas fa-camera"></i>
                                    </button>
                                    <button className="fab-action" onClick={handleUploadAudio} title="Enviar áudio">
                                        <i className="fas fa-file-audio"></i>
                                    </button>
                                    <button className="fab-action" onClick={handleUploadVideo} title="Enviar vídeo">
                                        <i className="fas fa-video"></i>
                                    </button>
                                    <button className="fab-action" onClick={toggleThemeMenu} title="Alterar tema">
                                        <i className="fas fa-palette"></i>
                                    </button>
                                    <button className="fab-action" onClick={toggleFontMenu} title="Tamanho do texto">
                                        <i className="fas fa-text-height"></i>
                                    </button>
                                    <button className="fab-action" onClick={createPoll} title="Criar enquete">
                                        <i className="fas fa-poll"></i>
                                    </button>
                                    <button className="fab-action" onClick={deleteAllMessages} title="Apagar todas as mensagens">
                                        <i className="fas fa-trash-alt"></i>
                                    </button>
                                </div>
                                <div className={`fab-sub-menu ${showThemeMenu ? 'open' : ''}`}>
                                    <div className="fab-sub-menu-item" onClick={() => changeTheme('light')}>
                                        <i className="fas fa-sun mr-2"></i>Claro
                                    </div>
                                    <div className="fab-sub-menu-item" onClick={() => changeTheme('dark')}>
                                        <i className="fas fa-moon mr-2"></i>Escuro
                                    </div>
                                    <div className="fab-sub-menu-item" onClick={() => changeTheme('nature')}>
                                        <i className="fas fa-leaf mr-2"></i>Natureza
                                    </div>
                                </div>
                                <div className={`fab-sub-menu ${showFontMenu ? 'open' : ''}`}>
                                    <div className="fab-sub-menu-item" onClick={() => changeFontSize('small')}>Pequeno</div>
                                    <div className="fab-sub-menu-item" onClick={() => changeFontSize('medium')}>Médio</div>
                                    <div className="fab-sub-menu-item" onClick={() => changeFontSize('large')}>Grande</div>
                                    <div className="fab-sub-menu-item" onClick={() => changeFontSize('xlarge')}>Extra Grande</div>
                                    <div className="fab-sub-menu-item" onClick={() => changeFontSize('xxlarge')}>Extra Extra Grande</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    {fullscreenImage && (
                        <FullscreenImage src={fullscreenImage} onClose={closeFullscreenImage} />
                    )}
                </div>
            );
        };

        ReactDOM.render(<ChatApp />, document.getElementById('root'));
    </script>
</body>
</html>
